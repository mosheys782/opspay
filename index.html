<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpsPay - Payment Operations</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; color: #1e293b; }
    input, select, textarea, button { font-family: inherit; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"><div style="display:flex;align-items:center;justify-content:center;height:100vh;font-size:16px;color:#64748b">Loading...</div></div>
  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // ════════════════════════════════════════
    //  AZURE AD CONFIG
    // ════════════════════════════════════════
    const AZURE = {
      clientId: '37c72bb9-42bb-4416-af86-ea5754021802',
      tenantId: '8b20613e-54c4-43a3-af63-92cdbf260edb',
      siteHostname: 'gancfried.sharepoint.com',
      sitePath: '/sites/GIBUSA',
      redirectUri: window.location.href.split('?')[0].split('#')[0]
    };
    const msalConfig = {
      auth: { clientId: AZURE.clientId, authority: 'https://login.microsoftonline.com/' + AZURE.tenantId, redirectUri: AZURE.redirectUri },
      cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: false }
    };
    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginRequest = { scopes: ['User.Read', 'Sites.ReadWrite.All', 'Sites.Manage.All'] };
    var msalReady = msalInstance.initialize().then(function() {
      return msalInstance.handleRedirectPromise();
    });

    // ════════════════════════════════════════
    //  GRAPH API
    // ════════════════════════════════════════
    async function getToken() {
      var a = msalInstance.getAllAccounts();
      if (!a.length) throw new Error('No account');
      try { return (await msalInstance.acquireTokenSilent({ scopes: ['Sites.ReadWrite.All'], account: a[0] })).accessToken; }
      catch (e) { await msalInstance.acquireTokenRedirect({ scopes: ['Sites.ReadWrite.All'] }); return null; }
    }
    async function gFetch(url, opts) {
      var t = await getToken();
      var r = await fetch('https://graph.microsoft.com/v1.0' + url, {
        headers: { 'Authorization': 'Bearer ' + t, 'Content-Type': 'application/json', 'Prefer': 'HonorNonIndexedQueriesWarningMayFailRandomly' },
        ...opts
      });
      if (!r.ok) { var b = await r.text(); throw new Error(r.status + ': ' + b.substring(0, 500)); }
      return r.status === 204 ? null : r.json();
    }

    // ════════════════════════════════════════
    //  SHAREPOINT — PROPER LIST STRUCTURE
    // ════════════════════════════════════════
    var SP = { siteId: null, payListId: null, cfgListId: null, cfgItemId: null, driveId: null };

    var PAY_COLUMNS = [
      { name: 'PayKey', text: {} },
      { name: 'Category', text: {} },
      { name: 'Amount', number: {} },
      { name: 'DueDate', text: {} },
      { name: 'PayStatus', text: {} },
      { name: 'CheckNum', text: {} },
      { name: 'PayNote', text: { allowMultipleLines: true, maxLength: 0 } },
      { name: 'AutoPay', boolean: {} },
      { name: 'IsPayroll', boolean: {} },
      { name: 'EmpName', text: {} },
      { name: 'Excluded', boolean: {} },
      { name: 'MinPay', number: {} },
      { name: 'CloseDate', text: {} },
      { name: 'UseMin', boolean: {} },
      { name: 'MonthKey', text: {} },
      { name: 'Varies', boolean: {} },
      { name: 'AttachData', text: { allowMultipleLines: true, maxLength: 0 } },
      { name: 'IsReminder', boolean: {} },
      { name: 'PayCard', text: {} },
    ];

    async function ensureList(name, extraCols) {
      var base = '/sites/' + SP.siteId + '/lists/';
      var listId;
      try { var l = await gFetch(base + name); listId = l.id; }
      catch(e) {
        var body = { displayName: name, list: { template: 'genericList' } };
        var l2 = await gFetch(base.slice(0, -1), { method: 'POST', body: JSON.stringify(body) });
        listId = l2.id;
        console.log('Created list:', name, listId);
      }
      // Ensure all columns exist (idempotent)
      if (extraCols) {
        var existing = await gFetch(base + listId + '/columns');
        var existingNames = (existing.value || []).map(function(c) { return c.name; });
        for (var i = 0; i < extraCols.length; i++) {
          if (existingNames.indexOf(extraCols[i].name) === -1) {
            try {
              await gFetch(base + listId + '/columns', { method: 'POST', body: JSON.stringify(extraCols[i]) });
              console.log('Added column:', extraCols[i].name);
            } catch(e2) { console.warn('Column ' + extraCols[i].name + ':', e2.message); }
          }
        }
      }
      return listId;
    }

    async function getAllItems(listId) {
      var all = [], url = '/sites/' + SP.siteId + '/lists/' + listId + '/items?$expand=fields&$top=250';
      while (url) {
        var r = await gFetch(url);
        all = all.concat(r.value || []);
        url = r['@odata.nextLink'] ? r['@odata.nextLink'].replace('https://graph.microsoft.com/v1.0', '') : null;
      }
      return all;
    }

    async function initSP() {
      var s = await gFetch('/sites/' + AZURE.siteHostname + ':' + AZURE.sitePath);
      SP.siteId = s.id;
      SP.payListId = await ensureList('OpsPay_Payments', PAY_COLUMNS);
      SP.cfgListId = await ensureList('OpsPay_Config', [{ name: 'ConfigData', text: { allowMultipleLines: true, maxLength: 0 } }]);
      // Find or create config item
      var cfgItems = await getAllItems(SP.cfgListId);
      var cfgMain = cfgItems.find(function(i) { return i.fields.Title === 'main'; });
      if (cfgMain) { SP.cfgItemId = cfgMain.id; }
      else {
        var n = await gFetch('/sites/' + SP.siteId + '/lists/' + SP.cfgListId + '/items', {
          method: 'POST', body: JSON.stringify({ fields: { Title: 'main', ConfigData: '{}' } })
        });
        SP.cfgItemId = n.id;
      }
      // Setup document library for attachments
      try {
        var driveResp = await gFetch('/sites/' + SP.siteId + '/drives');
        var drives = (driveResp.value || []);
        var opsDrive = drives.find(function(d) { return d.name === 'OpsPayAttachments'; });
        if (opsDrive) {
          SP.driveId = opsDrive.id;
        } else {
          // Use the default document library
          var defaultDrive = drives.find(function(d) { return d.name === 'Documents' || d.name === 'Shared Documents'; });
          if (defaultDrive) SP.driveId = defaultDrive.id;
        }
        console.log('Drive ID:', SP.driveId);
      } catch(e) { console.warn('Drive setup:', e); }
      console.log('SP init:', SP);
    }

    // Config CRUD
    async function spLoadConfig() {
      var r = await gFetch('/sites/' + SP.siteId + '/lists/' + SP.cfgListId + '/items/' + SP.cfgItemId + '?$expand=fields');
      var raw = r.fields.ConfigData;
      return raw ? JSON.parse(raw) : {};
    }
    async function spSaveConfig(data) {
      await gFetch('/sites/' + SP.siteId + '/lists/' + SP.cfgListId + '/items/' + SP.cfgItemId + '/fields', {
        method: 'PATCH', body: JSON.stringify({ ConfigData: JSON.stringify(data) })
      });
    }

    // Payment row CRUD
    function payToFields(p) {
      return {
        Title: p.name, PayKey: p.id, Category: p.category, Amount: p.amount,
        DueDate: p.dueDate, PayStatus: p.status, CheckNum: p.checkNum || '',
        PayNote: p.note || '', AutoPay: !!p.autoPay, IsPayroll: !!p.isPayroll,
        EmpName: p.empName || '', Excluded: !!p.excluded, MinPay: p.minPay || 0,
        CloseDate: p.closeDate || '', UseMin: !!p.useMin,
        MonthKey: p.dueDate ? p.dueDate.substring(0, 7) : '', Varies: !!p.varies,
        AttachData: p.attachData || '',
        IsReminder: !!p.isReminder, PayCard: p.payCard || '',
      };
    }
    function fieldsToPay(f, spId) {
      return {
        id: f.PayKey, _spId: spId, name: f.Title, category: f.Category || 'Other',
        amount: f.Amount || 0, dueDate: f.DueDate || '', status: f.PayStatus || 'unpaid',
        checkNum: f.CheckNum || '', note: f.PayNote || '', autoPay: !!f.AutoPay,
        isPayroll: !!f.IsPayroll, empName: f.EmpName || '', excluded: !!f.Excluded,
        minPay: f.MinPay || 0, closeDate: f.CloseDate || '', useMin: !!f.UseMin,
        varies: !!f.Varies,
        attachData: f.AttachData || '',
        isReminder: !!f.IsReminder, payCard: f.PayCard || '',
      };
    }

    async function spCreatePay(p) {
      var r = await gFetch('/sites/' + SP.siteId + '/lists/' + SP.payListId + '/items', {
        method: 'POST', body: JSON.stringify({ fields: payToFields(p) })
      });
      return r.id;
    }
    async function spUpdatePay(spId, fields) {
      await gFetch('/sites/' + SP.siteId + '/lists/' + SP.payListId + '/items/' + spId + '/fields', {
        method: 'PATCH', body: JSON.stringify(fields)
      });
    }
    async function spDeletePay(spId) {
      await gFetch('/sites/' + SP.siteId + '/lists/' + SP.payListId + '/items/' + spId, { method: 'DELETE' });
    }
    async function spUploadAttachment(payId, file) {
      if (!SP.driveId) {
        // Find default drive
        var driveResp = await gFetch('/sites/' + SP.siteId + '/drive');
        SP.driveId = driveResp.id;
      }
      var ts = Date.now().toString(36);
      var safeName = payId.replace(/[^a-zA-Z0-9\-_]/g, '_') + '__' + ts + '_' + file.name.replace(/[^a-zA-Z0-9._\-]/g, '_');
      var url = '/drives/' + SP.driveId + '/root:/OpsPayAttachments/' + safeName + ':/content';
      var resp = await fetch('https://graph.microsoft.com/v1.0' + url, {
        method: 'PUT',
        headers: { 'Authorization': 'Bearer ' + (await getToken()), 'Content-Type': file.type || 'application/octet-stream' },
        body: file
      });
      if (!resp.ok) { var e = await resp.text(); throw new Error('Upload failed: ' + resp.status + ' ' + e); }
      var data = await resp.json();
      return { name: file.name, driveItemId: data.id, webUrl: data.webUrl, downloadUrl: data['@microsoft.graph.downloadUrl'] || data.webUrl };
    }

    async function spDeleteAttachment(driveItemId) {
      await gFetch('/drives/' + SP.driveId + '/items/' + driveItemId, { method: 'DELETE' });
    }

    async function spLoadAllPay() {
      var items = await getAllItems(SP.payListId);
      var map = {};
      items.forEach(function(item) { map[item.fields.PayKey || item.fields.Title] = fieldsToPay(item.fields, item.id); });
      return map;
    }

    // ════════════════════════════════════════
    //  PAYMENT DASHBOARD
    // ════════════════════════════════════════

/* ── Constants ── */
const UNPAID = "unpaid", PAID = "paid", CLEARED = "cleared";
const CATS = {
  "Credit Card": { bg: "#FEF3C7", tx: "#92400E", dot: "#F59E0B" },
  "Payroll": { bg: "#DBEAFE", tx: "#1E40AF", dot: "#3B82F6" },
  "Rent": { bg: "#E0E7FF", tx: "#3730A3", dot: "#6366F1" },
  "Mortgage": { bg: "#FCE7F3", tx: "#9D174D", dot: "#EC4899" },
  "Health Insurance": { bg: "#D1FAE5", tx: "#065F46", dot: "#10B981" },
  "Invoice": { bg: "#FEE2E2", tx: "#991B1B", dot: "#EF4444" },
  "Utilities": { bg: "#FEF9C3", tx: "#854D0E", dot: "#EAB308" },
  "Other": { bg: "#F3F4F6", tx: "#374151", dot: "#6B7280" },
};
const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

/* ── Helpers ── */
function fmt(n) { return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(n); }
function pad(n) { return String(n).padStart(2,"0"); }
function toISO(d) { return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate()); }
function parseD(s) { var p=s.split("-"); return new Date(+p[0],+p[1]-1,+p[2]); }
function getToday() { return toISO(new Date()); }
function daysIn(y,m) { return new Date(y,m+1,0).getDate(); }
function fmtS(s) { return parseD(s).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}); }
function dayN(s) { return parseD(s).toLocaleDateString("en-US",{weekday:"long"}); }
function overdueTxt(s) { var eff=effDue(s); var diff=Math.floor((new Date(getToday()+"T12:00:00")-new Date(eff+"T12:00:00"))/86400000); if(diff===1) return "1 day overdue"; if(diff>1) return diff+" days overdue"; return "due today"; }
function effAmt(p) { if(p.isReminder) return 0; if(p.category==="Credit Card"&&p.useMin&&p.minPay>0) return p.minPay; return p.amount; }
/* If due date falls on Sat, Sun, holiday, or office-closed day, effective due is the prior business day */
function effDue(dueDate) {
  var d = parseD(dueDate);
  // Walk backwards until we find an open business day
  var maxSteps = 10; // prevent infinite loop
  while (maxSteps-- > 0) {
    var day = d.getDay();
    var iso = toISO(d);
    if (day === 0 || day === 6) { d = new Date(d.getTime() - 86400000); continue; }
    // Check custom office closed + holiday closed
    if (typeof _closedDays !== "undefined" && _closedDays[iso]) { d = new Date(d.getTime() - 86400000); continue; }
    return toISO(d);
  }
  return dueDate;
}
var _closedDays = {};
var _bankClosed = {};
var _zmanLoc = { lat: 40.7128, lng: -74.006, tz: -5 };
function updateClosedDays(customClosed, year) {
  _closedDays = {};
  _bankClosed = {};
  // Add Jewish holiday closed days
  var hols = getJewishHolidays(year);
  Object.keys(hols).forEach(function(k) {
    if (OFFICE_CLOSED_HOLIDAYS.indexOf(hols[k]) !== -1) _closedDays[k] = hols[k];
  });
  var hols2 = getJewishHolidays(year + 1);
  Object.keys(hols2).forEach(function(k) { if (OFFICE_CLOSED_HOLIDAYS.indexOf(hols2[k]) !== -1) _closedDays[k] = hols2[k]; });
  var holsPrev = getJewishHolidays(year - 1);
  Object.keys(holsPrev).forEach(function(k) { if (OFFICE_CLOSED_HOLIDAYS.indexOf(holsPrev[k]) !== -1) _closedDays[k] = holsPrev[k]; });
  // Add US bank holidays
  [year - 1, year, year + 1].forEach(function(y) {
    var bh = getUSBankHolidays(y);
    Object.keys(bh).forEach(function(k) {
      _bankClosed[k] = bh[k];
      _closedDays[k] = bh[k];
    });
  });
  // Add custom office closed dates
  if (customClosed) {
    Object.keys(customClosed).forEach(function(k) { _closedDays[k] = customClosed[k] || "Office Closed"; });
  }
}

/* ── Hebrew Calendar ── */
/* Simplified Hebrew date converter - handles years 5780-5800 (2020-2040) */
/* Convert number to Hebrew numerals (Gematria) */
function toHebNum(n) {
  var ones = ["", "א", "ב", "ג", "ד", "ה", "ו", "ז", "ח", "ט"];
  var tens = ["", "י", "כ", "ל", "מ", "נ", "ס", "ע", "פ", "צ"];
  var hundreds = ["", "ק", "ר", "ש", "ת", "תק", "תר", "תש", "תת", "תתק"];
  if (n <= 0) return "";
  var str = "";
  if (n >= 100) { str += hundreds[Math.floor(n / 100)]; n = n % 100; }
  // Special cases: 15 = ט״ו not יה, 16 = ט״ז not יו
  if (n === 15) return str + "ט״ו";
  if (n === 16) return str + "ט״ז";
  if (n >= 10) { str += tens[Math.floor(n / 10)]; n = n % 10; }
  str += ones[n];
  // Add geresh for single char, gershayim for multi
  if (str.length === 1) return str + "׳";
  if (str.length > 1) return str.slice(0, -1) + "״" + str.slice(-1);
  return str;
}

/* Hebrew year - just last 3 digits in gematria (e.g. 5786 -> תשפ״ו) */
function toHebYear(hy) {
  var y = hy % 1000; // 786
  return toHebNum(y);
}

function hebrewMonthName(m) {
  var names = ["ניסן","אייר","סיון","תמוז","אב","אלול","תשרי","חשון","כסלו","טבת","שבט","אדר","אדר ב"];
  return names[m-1] || "";
}

function isHebrewLeapYear(hy) { return ((7 * hy + 1) % 19) < 7; }

function hebrewElapsedDays(hy) {
  var months = Math.floor((235 * hy - 234) / 19);
  var parts = 12084 + 13753 * months;
  var day = 29 * months + Math.floor(parts / 25920);
  if (3 * (day + 1) % 7 < 3) day++;
  return day;
}

function hebrewYearDays(hy) { return hebrewElapsedDays(hy + 1) - hebrewElapsedDays(hy); }

function hebrewMonthDays(hy, hm) {
  // hm: 1=Nisan..12=Adar, 13=Adar II
  if ([2,4,6,10,13].indexOf(hm) !== -1) return 29;
  if (hm === 12 && !isHebrewLeapYear(hy)) return 29;
  if (hm === 8) { var yd = hebrewYearDays(hy); return (yd % 10 === 5) ? 30 : 29; }
  if (hm === 9) { var yd2 = hebrewYearDays(hy); return (yd2 % 10 === 3) ? 29 : 30; }
  return 30;
}

/* Convert Gregorian to Hebrew date */
var _gregHebCache = {};
function gregToHebrew(year, month, day) {
  var gk = year * 10000 + month * 100 + day;
  if (_gregHebCache[gk]) return _gregHebCache[gk];
  // Use astronomical calculation
  // Reference: 1 Tishrei 5784 = Sep 16, 2023
  var jd = gregorianToJD(year, month + 1, day);
  // Search for Hebrew year
  var hy = year + 3761;
  var tishrei1 = hebrewNewYearJD(hy);
  if (jd < tishrei1) { hy--; tishrei1 = hebrewNewYearJD(hy); }
  var next = hebrewNewYearJD(hy + 1);
  if (jd >= next) { hy++; tishrei1 = next; }
  
  var dayOfYear = jd - tishrei1;
  // Walk through months starting from Tishrei (month 7)
  var monthOrder = [7,8,9,10,11,12];
  if (isHebrewLeapYear(hy)) monthOrder.push(13);
  monthOrder = monthOrder.concat([1,2,3,4,5,6]);
  
  var acc = 0;
  for (var i = 0; i < monthOrder.length; i++) {
    var md = hebrewMonthDays(hy, monthOrder[i]);
    if (dayOfYear < acc + md) {
      var r = { year: hy, month: monthOrder[i], day: dayOfYear - acc + 1 };
      _gregHebCache[gk] = r;
      return r;
    }
    acc += md;
  }
  var fb = { year: hy, month: 6, day: 29 };
  _gregHebCache[gk] = fb;
  return fb;
}

function gregorianToJD(y, m, d) {
  if (m <= 2) { y--; m += 12; }
  var A = Math.floor(y / 100);
  var B = 2 - A + Math.floor(A / 4);
  return Math.floor(365.25 * (y + 4716)) + Math.floor(30.6001 * (m + 1)) + d + B - 1524.5;
}

function hebrewNewYearJD(hy) {
  // 1 Tishrei of Hebrew year hy in Julian Day
  var elapsed = hebrewElapsedDays(hy);
  // Hebrew epoch: JD 347997.5 = 1 Tishrei 1
  return elapsed + 347997.5;
}

function hebrewDateStr(year, month, day) {
  return day + " " + hebrewMonthName(month) + " " + year;
}

/* ── Jewish Holidays (fixed Hebrew calendar dates) ── */
var _jewishHolCache = {};
function getJewishHolidays(gYear) {
  if (_jewishHolCache[gYear]) return _jewishHolCache[gYear];
  // Generate holidays for a Gregorian year by checking each day
  var holidays = {};
  // Check each day of the Gregorian year
  for (var m = 0; m < 12; m++) {
    var dim = daysIn(gYear, m);
    for (var d = 1; d <= dim; d++) {
      var h = gregToHebrew(gYear, m, d);
      var key = gYear + "-" + pad(m + 1) + "-" + pad(d);
      var hol = null;
      
      // Tishrei holidays
      if (h.month === 7 && h.day === 1) hol = "ראש השנה";
      if (h.month === 7 && h.day === 2) hol = "ראש השנה ב";
      if (h.month === 7 && h.day === 3) hol = "צום גדליה";
      if (h.month === 7 && h.day === 10) hol = "יום כיפור";
      if (h.month === 7 && h.day === 15) hol = "סוכות";
      if (h.month === 7 && h.day === 16) hol = "סוכות ב";
      if (h.month === 7 && h.day === 21) hol = "הושענא רבה";
      if (h.month === 7 && h.day === 22) hol = "שמיני עצרת";
      if (h.month === 7 && h.day === 23) hol = "שמחת תורה";
      if (h.month === 7 && h.day >= 17 && h.day <= 20) hol = "חול המועד סוכות";
      
      // Kislev/Tevet - Chanukah
      if (h.month === 9 && h.day === 25) hol = "חנוכה";
      if (h.month === 9 && h.day >= 26 && h.day <= 30) hol = "חנוכה";
      if (h.month === 10 && h.day <= 2) hol = "חנוכה";
      if (h.month === 9 && h.day === 30 || (h.month === 10 && h.day === 1)) hol = "חנוכה"; // could be 1 or 2 Tevet
      
      // Tevet
      if (h.month === 10 && h.day === 10) hol = "עשרה בטבת";
      
      // Shevat
      if (h.month === 11 && h.day === 15) hol = "ט״ו בשבט";
      
      // Adar
      if (h.month === 12 && !isHebrewLeapYear(h.year) && h.day === 13) hol = "תענית אסתר";
      if (h.month === 12 && !isHebrewLeapYear(h.year) && h.day === 14) hol = "פורים";
      if (h.month === 12 && !isHebrewLeapYear(h.year) && h.day === 15) hol = "שושן פורים";
      if (h.month === 13 && h.day === 13) hol = "תענית אסתר";
      if (h.month === 13 && h.day === 14) hol = "פורים";
      if (h.month === 13 && h.day === 15) hol = "שושן פורים";
      
      // Nisan
      if (h.month === 1 && h.day === 15) hol = "פסח";
      if (h.month === 1 && h.day === 16) hol = "פסח ב";
      if (h.month === 1 && h.day >= 17 && h.day <= 20) hol = "חול המועד פסח";
      if (h.month === 1 && h.day === 21) hol = "פסח ז";
      if (h.month === 1 && h.day === 22) hol = "פסח ח";
      
      // Iyar
      if (h.month === 2 && h.day === 5) hol = "יום העצמאות";
      if (h.month === 2 && h.day === 18) hol = "ל״ג בעומר";
      
      // Sivan
      if (h.month === 3 && h.day === 6) hol = "שבועות";
      if (h.month === 3 && h.day === 7) hol = "שבועות ב";
      
      // Tammuz
      if (h.month === 4 && h.day === 17) hol = "שבעה עשר בתמוז";
      
      // Av
      if (h.month === 5 && h.day === 9) hol = "תשעה באב";
      if (h.month === 5 && h.day === 15) hol = "ט״ו באב";
      
      if (hol) holidays[key] = hol;
    }
  }
  _jewishHolCache[gYear] = holidays;
  return holidays;
}

/* Major holidays where office is typically closed */

/* ── Weekly Torah Portions (Parshiyos) ── */
var PARSHIYOS = [
  "בראשית","נח","לך לך","וירא","חיי שרה","תולדות","ויצא","וישלח","וישב","מקץ","ויגש",
  "ויחי","שמות","וארא","בא","בשלח","יתרו","משפטים","תרומה","תצוה","כי תשא","ויקהל","פקודי",
  "ויקרא","צו","שמיני","תזריע","מצורע","אחרי מות","קדושים","אמור","בהר","בחקתי",
  "במדבר","נשא","בהעלתך","שלח","קרח","חקת","בלק","פינחס","מטות","מסעי",
  "דברים","ואתחנן","עקב","ראה","שופטים","כי תצא","נצבים","וילך","האזינו"
];

/* Simple parsha lookup - approximation based on week of year from Simchas Torah */
var _parshaCache = {};
function getParshaForShabbat(gYear, gMonth, gDay) {
  var pk = gYear + "-" + gMonth + "-" + gDay;
  if (_parshaCache[pk]) return _parshaCache[pk];
  // Find Simchas Torah of current cycle
  var h = gregToHebrew(gYear, gMonth, gDay);
  var hy = h.month >= 7 ? h.year : h.year; // Hebrew year
  
  // Find the Shabbat after Simchas Torah (23 Tishrei)
  // Walk from 23 Tishrei forward to first Shabbat = Bereishis
  // For simplicity, use a week counter from Bereishis
  // This is approximate - proper calculation needs full Hebrew calendar cycle
  
  // Get JD of this Shabbat
  var jdShabbat = gregorianToJD(gYear, gMonth + 1, gDay);
  
  // Get JD of Simchas Torah of this cycle
  var stHy = hy;
  var jdST = hebrewNewYearJD(stHy) + 22; // 23 Tishrei
  
  // If this Shabbat is before Simchas Torah, use previous year
  if (jdShabbat < jdST) {
    stHy--;
    jdST = hebrewNewYearJD(stHy) + 22;
  }
  
  // Find first Shabbat after Simchas Torah
  var d = new Date((jdST - 2440587.5) * 86400000);
  while (d.getDay() !== 6) d = new Date(d.getTime() + 86400000);
  var jdBereishis = gregorianToJD(d.getFullYear(), d.getMonth() + 1, d.getDate());
  
  var weekNum = Math.round((jdShabbat - jdBereishis) / 7);
  if (weekNum < 0 || weekNum >= PARSHIYOS.length) return "";
  var result = PARSHIYOS[weekNum] || "";
  _parshaCache[pk] = result;
  return result;
}

/* ── Special Shabbosos ── */
function getSpecialShabbos(gYear, gMonth, gDay) {
  // gMonth is 0-indexed. Returns array of special names in Hebrew.
  var specials = [];
  var h = gregToHebrew(gYear, gMonth, gDay);
  var hy = h.year, hm = h.month, hd = h.day;

  // Shabbos Mevorchim — Shabbos before Rosh Chodesh (except before Tishrei)
  // If this Shabbos's Hebrew month is NOT Elul (month 6) leading into Tishrei,
  // and the upcoming Rosh Chodesh is within the next 6 days
  var daysInCurMonth = hebrewMonthDays(hy, hm);
  if (hd >= daysInCurMonth - 6 && hd <= daysInCurMonth) {
    // Next month's Rosh Chodesh is coming. Check it's not Tishrei.
    var nextHm = hm;
    if (hm === 6) { /* Elul -> Tishrei: no mevorchim */ }
    else if (hm === 12 && !isHebrewLeapYear(hy)) { nextHm = 1; specials.push("שבת מברכים"); }
    else if (hm === 13) { nextHm = 1; specials.push("שבת מברכים"); }
    else { specials.push("שבת מברכים"); }
  }

  // Shabbos Shuvah — between Rosh Hashanah and Yom Kippur (3-9 Tishrei)
  if (hm === 7 && hd >= 3 && hd <= 9) specials.push("שבת שובה");

  // Shabbos HaGadol — Shabbos before Pesach (8-14 Nisan)
  if (hm === 1 && hd >= 8 && hd <= 14) specials.push("שבת הגדול");

  // Shabbos Chazon — Shabbos before Tisha B'Av (2-8 Av)
  if (hm === 5 && hd >= 2 && hd <= 8) specials.push("שבת חזון");

  // Shabbos Nachamu — Shabbos after Tisha B'Av (10-16 Av)
  if (hm === 5 && hd >= 10 && hd <= 16) specials.push("שבת נחמו");

  // Four Parshiyos: Shekalim, Zachor, Parah, HaChodesh
  // These depend on when Purim/Adar falls. We need 1 Adar (or Adar II in leap year)
  var adarMonth = isHebrewLeapYear(hy) ? 13 : 12;

  // Shekalim: Shabbos on or before 1 Adar (or Adar II)
  // If 1 Adar is Shabbos, it's Shekalim. Otherwise the Shabbos before.
  if (hm === adarMonth && hd === 1) specials.push("שבת שקלים");
  if (hm === (adarMonth === 13 ? 12 : 11)) {
    // Previous month - check if this is the last Shabbos and 1 Adar is within next 6 days
    var dm2 = hebrewMonthDays(hy, hm);
    var daysUntilAdar1 = dm2 - hd; // days until end of month
    if (daysUntilAdar1 >= 0 && daysUntilAdar1 < 7) {
      // Check that 1 Adar is NOT Shabbos (otherwise 1 Adar itself gets it)
      // Compute day-of-week of 1 Adar
      var jd1Adar = hebrewNewYearJD(hy);
      var monthOrder2 = [7,8,9,10,11,12];
      if (isHebrewLeapYear(hy)) monthOrder2.push(13);
      monthOrder2 = monthOrder2.concat([1,2,3,4,5,6]);
      var acc2 = 0;
      for (var mi = 0; mi < monthOrder2.length; mi++) {
        if (monthOrder2[mi] === adarMonth) break;
        acc2 += hebrewMonthDays(hy, monthOrder2[mi]);
      }
      jd1Adar += acc2;
      var dow1Adar = Math.round(jd1Adar + 1.5) % 7; // 0=Sun..6=Sat
      if (dow1Adar !== 6) specials.push("שבת שקלים");
    }
  }

  // Zachor: Shabbos before Purim (14 Adar). So 8-13 Adar
  if (hm === adarMonth && hd >= 8 && hd <= 13) specials.push("שבת זכור");

  // Parah: 2nd Shabbos before 1 Nisan. Roughly 15-21 Adar
  if (hm === adarMonth && hd >= 15 && hd <= 21) specials.push("שבת פרה");

  // HaChodesh: Shabbos on or before 1 Nisan. 24-29/30 Adar or 1 Nisan
  if (hm === 1 && hd === 1) specials.push("שבת החודש");
  if (hm === adarMonth && hd >= 23 && hd <= hebrewMonthDays(hy, adarMonth)) specials.push("שבת החודש");

  return specials;
}

/* Approximate candle lighting time (18 min before sunset) for NYC area */
/* Uses a simplified solar calculation */
/* Zmanim location presets */
var ZMAN_CITIES = [
  { name: "New York", lat: 40.7128, lng: -74.006, tz: -5 },
  { name: "Los Angeles", lat: 34.0522, lng: -118.2437, tz: -8 },
  { name: "Chicago", lat: 41.8781, lng: -87.6298, tz: -6 },
  { name: "Miami", lat: 25.7617, lng: -80.1918, tz: -5 },
  { name: "Houston", lat: 29.7604, lng: -95.3698, tz: -6 },
  { name: "Monticello", lat: 41.6556, lng: -74.6890, tz: -5 },
  { name: "Lakewood", lat: 40.0960, lng: -74.2218, tz: -5 },
  { name: "Baltimore", lat: 39.2904, lng: -76.6122, tz: -5 },
  { name: "Jerusalem", lat: 31.7683, lng: 35.2137, tz: 2 },
  { name: "Bnei Brak", lat: 32.0853, lng: 34.8334, tz: 2 },
  { name: "London", lat: 51.5074, lng: -0.1278, tz: 0 },
  { name: "Toronto", lat: 43.6532, lng: -79.3832, tz: -5 },
  { name: "Montreal", lat: 45.5017, lng: -73.5673, tz: -5 },
];

function getSunsetTime(gYear, gMonth, gDay, loc) {
  var lat = loc.lat;
  var lng = loc.lng;
  var baseTz = loc.tz;
  var dayOfYear = Math.floor((Date.UTC(gYear, gMonth, gDay) - Date.UTC(gYear, 0, 0)) / 86400000);
  // Equation of time correction
  var B = 2 * Math.PI * (dayOfYear - 81) / 365;
  var EoT = 9.87 * Math.sin(2*B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B); // minutes
  var decl = -23.45 * Math.cos(2 * Math.PI * (dayOfYear + 10) / 365);
  var declRad = decl * Math.PI / 180;
  var latRad = lat * Math.PI / 180;
  var cosH = (Math.sin(-0.833 * Math.PI / 180) - Math.sin(latRad) * Math.sin(declRad)) / (Math.cos(latRad) * Math.cos(declRad));
  if (cosH > 1 || cosH < -1) return null;
  var H = Math.acos(cosH) * 180 / Math.PI;
  // Solar noon in UTC = 12:00 - EoT(hours) - longitude/15
  var solarNoonUTC = 12 - (EoT / 60) - (lng / 15);
  var sunsetUTC = solarNoonUTC + H / 15;
  // DST check
  var isDST = false;
  if (baseTz >= -10 && baseTz <= -4) {
    var marStart = new Date(gYear, 2, 8); while (marStart.getDay() !== 0) marStart = new Date(marStart.getTime() + 86400000);
    var novEnd = new Date(gYear, 10, 1); while (novEnd.getDay() !== 0) novEnd = new Date(novEnd.getTime() + 86400000);
    if (new Date(gYear, gMonth, gDay) >= marStart && new Date(gYear, gMonth, gDay) < novEnd) isDST = true;
  } else if (baseTz === 0) {
    var marLast = new Date(gYear, 2, 31); while (marLast.getDay() !== 0) marLast = new Date(marLast.getTime() - 86400000);
    var octLast = new Date(gYear, 9, 31); while (octLast.getDay() !== 0) octLast = new Date(octLast.getTime() - 86400000);
    if (new Date(gYear, gMonth, gDay) >= marLast && new Date(gYear, gMonth, gDay) < octLast) isDST = true;
  } else if (baseTz === 2) {
    var octLastSun = new Date(gYear, 9, 31); while (octLastSun.getDay() !== 0) octLastSun = new Date(octLastSun.getTime() - 86400000);
    var marFri = new Date(gYear, 2, 23); while (marFri.getDay() !== 5) marFri = new Date(marFri.getTime() + 86400000);
    if (new Date(gYear, gMonth, gDay) >= marFri && new Date(gYear, gMonth, gDay) < octLastSun) isDST = true;
  }
  var localOffset = baseTz + (isDST ? 1 : 0);
  var sunsetLocal = sunsetUTC + localOffset;
  return sunsetLocal;
}

function getCandleLighting(gYear, gMonth, gDay, loc) {
  var sunset = getSunsetTime(gYear, gMonth, gDay, loc);
  if (sunset === null) return "";
  var candleMin = (sunset * 60) - 18;
  var hrs = Math.floor(candleMin / 60);
  var mins = Math.round(candleMin % 60);
  if (mins === 60) { hrs++; mins = 0; }
  var ampm = hrs >= 12 ? "PM" : "AM";
  var h12 = hrs % 12; if (h12 === 0) h12 = 12;
  return h12 + ":" + (mins < 10 ? "0" : "") + mins + " " + ampm;
}

/* Havdalah / Yom Tov end time (minutes after sunset) */
function getHavdalahTime(gYear, gMonth, gDay, loc) {
  var sunset = getSunsetTime(gYear, gMonth, gDay, loc);
  if (sunset === null) return "";
  // Standard: 42 min after sunset for 3 small stars
  var endMin = (sunset * 60) + 42;
  var hrs = Math.floor(endMin / 60);
  var mins = Math.round(endMin % 60);
  if (mins === 60) { hrs++; mins = 0; }
  var ampm = hrs >= 12 ? "PM" : "AM";
  var h12 = hrs % 12; if (h12 === 0) h12 = 12;
  return h12 + ":" + (mins < 10 ? "0" : "") + mins + " " + ampm;
}

/* Check if a date is a fast day and get fast end time */
function getFastTimes(gYear, gMonth, gDay) {
  var h = gregToHebrew(gYear, gMonth, gDay);
  var fasts = {};
  // Fast days end at nightfall (~40 min after sunset for regular, ~50 for Yom Kippur/Tisha BAv)
  var isMajor = false;
  var isFast = false;
  
  if (h.month === 7 && h.day === 3) isFast = true; // Tzom Gedaliah
  if (h.month === 7 && h.day === 10) { isFast = true; isMajor = true; } // Yom Kippur
  if (h.month === 10 && h.day === 10) isFast = true; // 10 Teves
  if (h.month === 4 && h.day === 17) isFast = true; // 17 Tammuz
  if (h.month === 5 && h.day === 9) { isFast = true; isMajor = true; } // Tisha B'Av
  if ((h.month === 12 && !isHebrewLeapYear(h.year) && h.day === 13) || (h.month === 13 && h.day === 13)) isFast = true; // Taanis Esther
  
  if (!isFast) return null;
  
  // Calculate end time using location
  var sunset = typeof _zmanLoc !== "undefined" ? getSunsetTime(gYear, gMonth, gDay, _zmanLoc) : getSunsetTime(gYear, gMonth, gDay, {lat:40.7128,lng:-74.006,tz:-5});
  if (sunset === null) return null;
  var endMin = (sunset * 60) + (isMajor ? 50 : 40);
  var hrs = Math.floor(endMin / 60);
  var mins = Math.round(endMin % 60);
  if (mins === 60) { hrs++; mins = 0; }
  var ampm = hrs >= 12 ? "PM" : "AM";
  var h12 = hrs % 12; if (h12 === 0) h12 = 12;
  return { end: h12 + ":" + (mins < 10 ? "0" : "") + mins + " " + ampm, isMajor: isMajor };
}

/* ── US Bank Holidays (Federal Reserve) ── */
var _bankHolCache = {};
function getUSBankHolidays(gYear) {
  if (_bankHolCache[gYear]) return _bankHolCache[gYear];
  var holidays = {};
  // New Year's Day - Jan 1 (observed prev Fri if Sat, next Mon if Sun)
  holidays[gYear + "-01-01"] = "New Year's Day";
  
  // MLK Day - 3rd Monday of Jan
  var jan1 = new Date(gYear, 0, 1);
  var mlk = new Date(gYear, 0, 1 + ((1 - jan1.getDay() + 7) % 7) + 14);
  holidays[toISO(mlk)] = "MLK Day";
  
  // Presidents Day - 3rd Monday of Feb
  var feb1 = new Date(gYear, 1, 1);
  var pres = new Date(gYear, 1, 1 + ((1 - feb1.getDay() + 7) % 7) + 14);
  holidays[toISO(pres)] = "Presidents' Day";
  
  // Memorial Day - Last Monday of May
  var may31 = new Date(gYear, 4, 31);
  while (may31.getDay() !== 1) may31 = new Date(may31.getTime() - 86400000);
  holidays[toISO(may31)] = "Memorial Day";
  
  // Juneteenth - Jun 19 (observed)
  var june19 = new Date(gYear, 5, 19);
  if (june19.getDay() === 6) june19 = new Date(june19.getTime() - 86400000);
  if (june19.getDay() === 0) june19 = new Date(june19.getTime() + 86400000);
  holidays[toISO(june19)] = "Juneteenth";
  
  // Independence Day - Jul 4 (observed)
  var jul4 = new Date(gYear, 6, 4);
  if (jul4.getDay() === 6) jul4 = new Date(jul4.getTime() - 86400000);
  if (jul4.getDay() === 0) jul4 = new Date(jul4.getTime() + 86400000);
  holidays[toISO(jul4)] = "Independence Day";
  
  // Labor Day - 1st Monday of Sep
  var sep1 = new Date(gYear, 8, 1);
  var labor = new Date(gYear, 8, 1 + ((1 - sep1.getDay() + 7) % 7));
  holidays[toISO(labor)] = "Labor Day";
  
  // Columbus Day - 2nd Monday of Oct
  var oct1 = new Date(gYear, 9, 1);
  var columbus = new Date(gYear, 9, 1 + ((1 - oct1.getDay() + 7) % 7) + 7);
  holidays[toISO(columbus)] = "Columbus Day";
  
  // Veterans Day - Nov 11 (observed)
  var nov11 = new Date(gYear, 10, 11);
  if (nov11.getDay() === 6) nov11 = new Date(nov11.getTime() - 86400000);
  if (nov11.getDay() === 0) nov11 = new Date(nov11.getTime() + 86400000);
  holidays[toISO(nov11)] = "Veterans Day";
  
  // Thanksgiving - 4th Thursday of Nov
  var nov1 = new Date(gYear, 10, 1);
  var thx = new Date(gYear, 10, 1 + ((4 - nov1.getDay() + 7) % 7) + 21);
  holidays[toISO(thx)] = "Thanksgiving";
  
  // Christmas - Dec 25 (observed)
  var dec25 = new Date(gYear, 11, 25);
  if (dec25.getDay() === 6) dec25 = new Date(dec25.getTime() - 86400000);
  if (dec25.getDay() === 0) dec25 = new Date(dec25.getTime() + 86400000);
  holidays[toISO(dec25)] = "Christmas Day";
  
  // Also handle New Year observed if Jan 1 is Sat (observed Dec 31 prev year)
  var ny = new Date(gYear, 0, 1);
  if (ny.getDay() === 6) holidays[(gYear-1) + "-12-31"] = "New Year's Day (Observed)";
  if (ny.getDay() === 0) holidays[gYear + "-01-02"] = "New Year's Day (Observed)";
  
  _bankHolCache[gYear] = holidays;
  return holidays;
}

var OFFICE_CLOSED_HOLIDAYS = ["ראש השנה","ראש השנה ב","יום כיפור","סוכות","סוכות ב","שמיני עצרת","שמחת תורה","פסח","פסח ב","פסח ז","פסח ח","שבועות","שבועות ב"];



/* ── Payroll dates: bi-weekly Wed from March 4 2026 ── */
function payrollDates(year,month) {
  var anchor=new Date(2026,2,4),s=new Date(year,month,1),e=new Date(year,month+1,0);
  // Calculate bi-weekly cycle from anchor (works both forwards and backwards)
  var diff=Math.floor((s-anchor)/86400000);
  var c=new Date(anchor.getTime()+(Math.floor(diff/14)-1)*14*86400000);
  var out=[];
  for(var i=0;i<10;i++){if(c>=s&&c<=e) out.push(toISO(c));if(c>e) break;c=new Date(c.getTime()+14*86400000);}
  return out;
}

var DEF_EMPS = [
  {name:"Maria Santos",salary:4200,startDate:"2026-03-04"},
  {name:"James Wilson",salary:3800,startDate:"2026-03-04"},
  {name:"Sarah Chen",salary:4500,startDate:"2026-03-04"},
  {name:"David Miller",salary:3600,startDate:"2026-03-04"},
  {name:"Aisha Patel",salary:4100,startDate:"2026-03-04"},
  {name:"Robert Johnson",salary:3900,startDate:"2026-03-04"},
];
var DEF_REC = [
  {name:"Amex Business Card",category:"Credit Card",amount:4250,minPay:85,closeDay:8,dayOfMonth:15,autoPay:true,varies:true,startDate:"2026-02-24"},
  {name:"Chase Visa",category:"Credit Card",amount:1875.5,minPay:45,closeDay:12,dayOfMonth:20,autoPay:true,varies:true,startDate:"2026-02-24"},
  {name:"Office Rent",category:"Rent",amount:6200,dayOfMonth:1,autoPay:false,varies:false,startDate:"2026-02-24"},
  {name:"Building Mortgage",category:"Mortgage",amount:3450,dayOfMonth:5,autoPay:true,varies:false,startDate:"2026-02-24"},
  {name:"Blue Cross Health",category:"Health Insurance",amount:2890,dayOfMonth:1,autoPay:true,varies:true,startDate:"2026-02-24"},
];

/* ── Generate expected payments for a month (in-memory, not stored) ── */
function genExpected(year, month, tmpls, emps) {
  var out = [], mk = year+"-"+pad(month+1), dm = daysIn(year,month);
  var monthStart = mk + "-01";
  var monthEnd = mk + "-" + pad(dm);

  tmpls.forEach(function(t) {
    // Skip if template has a startDate and this month is before it
    if (t.startDate && monthEnd < t.startDate) return;
    // Skip if template has an endDate and this month is after it
    if (t.endDate && monthStart > t.endDate) return;

    var dy = Math.min(t.dayOfMonth, dm);
    var dueDate = mk+"-"+pad(dy);
    // For the start month, skip if due date is before startDate
    if (t.startDate && dueDate < t.startDate) return;
    // For the end month, skip if due date is after endDate
    if (t.endDate && dueDate > t.endDate) return;

    var isCC = t.category === "Credit Card";
    out.push({
      id: "r-"+mk+"-"+t.name, name: t.name, category: t.category, amount: t.amount,
      minPay: isCC?(t.minPay||0):0, closeDate: isCC?mk+"-"+pad(Math.min(t.closeDay||1,dm)):"",
      useMin: false, dueDate: dueDate, autoPay: t.autoPay, varies: t.varies||false,
      status: UNPAID, checkNum: "", isPayroll: false, empName: "", excluded: false, note: t.note||"",
      isReminder: !!t.isReminder, payCard: t.defaultCard || "",
    });
  });

  payrollDates(year,month).forEach(function(date) {
    emps.forEach(function(emp) {
      // Skip if employee has a startDate and this date is before it
      if (emp.startDate && date < emp.startDate) return;
      // Skip if employee is paused and this date falls within pause range
      if (emp.pauseFrom && date >= emp.pauseFrom && (!emp.pauseTo || date <= emp.pauseTo)) return;

      out.push({
        id: "p-"+date+"-"+emp.name, name: "Payroll: "+emp.name, category: "Payroll", amount: emp.salary,
        minPay:0,closeDate:"",useMin:false,dueDate:date,autoPay:false,varies:false,
        status:UNPAID,checkNum:"",isPayroll:true,empName:emp.name,excluded:false,note:""
      });
    });
  });
  return out;
}

/* ── Styles (light theme) ── */
var cardS = {background:"white",borderRadius:12,padding:20,boxShadow:"0 1px 3px rgba(0,0,0,0.1)",border:"none",borderLeft:"4px solid #3b82f6"};
var lblS = {fontSize:12,color:"#64748b",fontWeight:500,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:4};
var numS = {fontSize:28,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",color:"#0f172a"};
var inputS = {width:"100%",padding:"10px 12px",borderRadius:8,border:"1px solid #d1d5db",fontSize:14,outline:"none",fontFamily:"inherit",color:"#111827",background:"white"};
var btnPrimary = {flex:1,padding:"10px 20px",borderRadius:8,border:"none",background:"linear-gradient(135deg,#3b82f6,#2563eb)",color:"#fff",fontSize:15,fontWeight:600,cursor:"pointer"};
var btnSecondary = {flex:1,padding:"10px 20px",borderRadius:8,border:"1px solid #d1d5db",background:"white",color:"#374151",fontSize:15,fontWeight:600,cursor:"pointer"};
var smBtn = function(bg,color){return{background:bg,border:"none",borderRadius:6,padding:"6px 10px",cursor:"pointer",color:color,fontSize:14,display:"inline-flex",alignItems:"center",justifyContent:"center"};};

/* ── Components ── */
function AttachSection({ editId, attachments, attachLoading, openAttachViewer, removeAttachment, uploadAttachment }) {
  var list = (editId && attachments && attachments[editId]) ? attachments[editId] : [];
  return (
    <div style={{ borderTop: "1px solid #e2e8f0", paddingTop: 10 }}>
      <label style={{fontSize:12,fontWeight:600,color:"#374151",marginBottom:4,display:"block",textTransform:"uppercase",letterSpacing:".05em"}}>Attachments</label>
      {list.map(function(att, idx) {
        return React.createElement("div", { key: idx, style: { display: "flex", alignItems: "center", gap: 8, padding: "5px 10px", background: "#f0fdf4", borderRadius: 8, border: "1px solid #bbf7d0", marginBottom: 4 } },
          React.createElement("span", { style: { flex: 1, fontSize: 12, fontWeight: 500, color: "#166534", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" } }, att.name),
          React.createElement("button", { onClick: function() { openAttachViewer(att, list, idx); }, style: { background: "#dbeafe", border: "none", borderRadius: 6, padding: "3px 8px", cursor: "pointer", fontSize: 11, color: "#2563eb", fontWeight: 600 } }, "View"),
          React.createElement("button", { onClick: function() { removeAttachment(editId, idx); }, style: { background: "#fee2e2", border: "none", borderRadius: 6, padding: "3px 8px", cursor: "pointer", fontSize: 11, color: "#dc2626", fontWeight: 600 } }, "Remove")
        );
      })}
      <div style={{ position: "relative", marginTop: list.length > 0 ? 4 : 0 }}>
        <div style={{ border: "2px dashed #d1d5db", borderRadius: 8, padding: 16, textAlign: "center", cursor: "pointer" }}
          onDragOver={function(e) { e.preventDefault(); e.currentTarget.style.borderColor = "#3b82f6"; }}
          onDragLeave={function(e) { e.currentTarget.style.borderColor = "#d1d5db"; }}
          onDrop={function(e) { e.preventDefault(); e.currentTarget.style.borderColor = "#d1d5db"; if(editId) Array.from(e.dataTransfer.files).forEach(function(f) { uploadAttachment(editId, f); }); }}
          onClick={function() { var el = document.getElementById("attachFileInput"); if(el) el.click(); }}
        >
          {attachLoading
            ? React.createElement("span", { style: { fontSize: 13, color: "#6b7280" } }, "Uploading...")
            : React.createElement("div", null,
                React.createElement("div", { style: { fontSize: 20, marginBottom: 4 } }, "+"),
                React.createElement("div", { style: { fontSize: 12, color: "#6b7280" } }, "Drop files here or ", React.createElement("span", { style: { color: "#3b82f6", fontWeight: 600 } }, "browse")),
                React.createElement("div", { style: { fontSize: 10, color: "#9ca3af", marginTop: 2 } }, "PDF, PNG, JPG up to 10MB")
              )
          }
        </div>
        <input id="attachFileInput" type="file" accept=".pdf,.png,.jpg,.jpeg" multiple style={{ display: "none" }} onChange={function(e) { if(editId) Array.from(e.target.files).forEach(function(f) { uploadAttachment(editId, f); }); e.target.value = ""; }} />
      </div>
    </div>
  );
}

function Modal({open,onClose,children}) {
  if(!open) return null;
  return (
    <div style={{position:"fixed",inset:0,zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.6)",backdropFilter:"blur(4px)"}} onClick={onClose}>
      <div onClick={function(e){e.stopPropagation();}} style={{background:"#fff",borderRadius:16,padding:24,width:"94%",maxWidth:520,maxHeight:"88vh",overflowY:"auto",boxShadow:"0 25px 50px -12px rgba(0,0,0,0.25)"}}>
        {children}
      </div>
    </div>
  );
}
function Label({text}) { return <label style={{fontSize:12,fontWeight:600,color:"#374151",marginBottom:4,display:"block",textTransform:"uppercase",letterSpacing:".05em"}}>{text}</label>; }

function CalIcon() {
  return (
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
      <line x1="16" y1="2" x2="16" y2="6" />
      <line x1="8" y1="2" x2="8" y2="6" />
      <line x1="3" y1="10" x2="21" y2="10" />
    </svg>
  );
}

/* ════════════════════════════════════════ */
/*  MAIN DASHBOARD COMPONENT               */
/* ════════════════════════════════════════ */
function PaymentDashboard({ onLogout, userName }) {
  var now = new Date();
  var [cy, setCy] = useState(now.getFullYear());
  var [cm, setCm] = useState(now.getMonth());
  var [bal, setBal] = useState(45000);
  var [balIn, setBalIn] = useState("45000");
  var [editBal, setEditBal] = useState(false);
  var [emps, setEmps] = useState(DEF_EMPS);
  var [tmpls, setTmpls] = useState(DEF_REC);
  var [payments, setPayments] = useState({});  // { payKey: { ...payment, _spId } }
  var [showCal, setShowCal] = useState(false);
  var [selDay, setSelDay] = useState(null);  // "2026-03-04" or null
  var [showAdd, setShowAdd] = useState(false);
  var [editId, setEditId] = useState(null);
  var [attachments, setAttachments] = useState({});  // { payId: [ {name, driveItemId, webUrl, downloadUrl}, ... ] }
  var [attachLoading, setAttachLoading] = useState(false);
  var [viewAttach, setViewAttach] = useState(null);  // { name, downloadUrl, driveItemId }
  var [viewBlobUrl, setViewBlobUrl] = useState(null);
  var [viewLoading, setViewLoading] = useState(false);
  var [viewAttachList, setViewAttachList] = useState([]);  // all attachments for cycling
  var [viewAttachIdx, setViewAttachIdx] = useState(0);

  async function loadAttachBlob(info) {
    setViewBlobUrl(null);
    setViewLoading(true);
    try {
      var token = await getToken();
      var resp = await fetch('https://graph.microsoft.com/v1.0/drives/' + SP.driveId + '/items/' + info.driveItemId + '/content', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      // If 401, force token refresh and retry once
      if (resp.status === 401) {
        var a = msalInstance.getAllAccounts();
        if (a.length > 0) {
          var tokenResp = await msalInstance.acquireTokenSilent({ scopes: ['Sites.ReadWrite.All'], account: a[0], forceRefresh: true });
          token = tokenResp.accessToken;
          resp = await fetch('https://graph.microsoft.com/v1.0/drives/' + SP.driveId + '/items/' + info.driveItemId + '/content', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
        }
      }
      if (!resp.ok) throw new Error('Failed to fetch file');
      var blob = await resp.blob();
      var url = URL.createObjectURL(blob);
      setViewBlobUrl(url);
    } catch(e) {
      console.error('Fetch attachment:', e);
      setViewBlobUrl(null);
    } finally {
      setViewLoading(false);
    }
  }

  async function openAttachViewer(info, list, idx) {
    setViewAttach(info);
    setViewAttachList(list || [info]);
    setViewAttachIdx(idx || 0);
    loadAttachBlob(info);
  }

  function viewAttachNav(dir) {
    var newIdx = viewAttachIdx + dir;
    if (newIdx < 0 || newIdx >= viewAttachList.length) return;
    if (viewBlobUrl) URL.revokeObjectURL(viewBlobUrl);
    var info = viewAttachList[newIdx];
    setViewAttach(info);
    setViewAttachIdx(newIdx);
    loadAttachBlob(info);
  }

  function closeAttachViewer() {
    if (viewBlobUrl) URL.revokeObjectURL(viewBlobUrl);
    setViewBlobUrl(null);
    setViewAttach(null);
  }

  function downloadAttach() {
    if (!viewBlobUrl || !viewAttach) return;
    var a = document.createElement('a');
    a.href = viewBlobUrl;
    a.download = viewAttach.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  var [showEmp, setShowEmp] = useState(false);
  var [checkId, setCheckId] = useState(null);
  var [showRec, setShowRec] = useState(false);
  var [editTmplIdx, setEditTmplIdx] = useState(null);  // index of template being edited
  var [editTmplF, setEditTmplF] = useState(null);      // edit form data
  var [showFc, setShowFc] = useState(false);
  var [noteId, setNoteId] = useState(null);
  var [ready, setReady] = useState(false);
  useEffect(function() { paymentsRef.current = payments; }, [payments]);
  var closedKey = JSON.stringify(officeClosed) + cy;
  useEffect(function() { updateClosedDays(officeClosed, cy >= 2020 ? cy : new Date().getFullYear()); }, [closedKey]);
  useEffect(function() { _zmanLoc = zmanLoc; }, [zmanLoc]);
  var [tab, setTab] = useState("action");
  var [saveStatus, setSaveStatus] = useState("saved");
  var [selected, setSelected] = useState({});  // { payId: true }

  var [form, setForm] = useState({name:"",category:"Invoice",amount:"",dueDate:getToday(),autoPay:false,checkNum:"",note:"",minPay:"",closeDay:"",isRecurring:false,dayOfMonth:"1",sameAmount:true});
  var [recF, setRecF] = useState({name:"",category:"Credit Card",amount:"",dayOfMonth:"1",autoPay:false,varies:true,minPay:"",closeDay:"",startDate:getToday(),endDate:"",isReminder:false,defaultCard:""});
  var [empF, setEmpF] = useState({name:"",salary:"",startDate:getToday()});
  var [chkIn, setChkIn] = useState("");
  var [noteIn, setNoteIn] = useState("");
  var [fcFrom, setFcFrom] = useState(getToday());
  var [fcTo, setFcTo] = useState(function(){var d=new Date();d.setDate(d.getDate()+30);return toISO(d);});
  var [editEmpName, setEditEmpName] = useState(null);   // name of employee being edited
  var [editEmpF, setEditEmpF] = useState(null);          // edit form data for employee
  var [searchQ, setSearchQ] = useState("");               // global search query
  var [copied, setCopied] = useState(false);              // clipboard copied feedback
  var [skipUntil, setSkipUntil] = useState({});
  var [officeClosed, setOfficeClosed] = useState({});  // { "2026-03-15": "reason" }
  var [zmanLoc, setZmanLoc] = useState({ name: "New York", lat: 40.7128, lng: -74.006, tz: -5 });  // candle lighting location
  var [showZmanPicker, setShowZmanPicker] = useState(false);
  var [showMonthPicker, setShowMonthPicker] = useState(false);            // { payId: "2026-03-15" }
  var [skipPickId, setSkipPickId] = useState(null);        // payment id for skip date picker
  var [skipPickDate, setSkipPickDate] = useState("");      // date value in picker
  var [showShare, setShowShare] = useState(false);         // share summary modal
  var [shareOpts, setShareOpts] = useState({
    balance: true, available: true, totalDue: true, funding: true,
    pending: true, itemList: true, itemDetails: true
  });

  var cfgTimer = useRef(null);
  var refreshTimer = useRef(null);
  var paymentsRef = useRef({});

  /* ══════ LOAD + ENSURE + BG REFRESH ══════ */
  async function fullLoad(currentTmpls, currentEmps, viewY, viewM) {
    // Load all existing payments from SP
    var payMap = await spLoadAllPay();
    console.log('Loaded', Object.keys(payMap).length, 'payments from SP');

    // Ensure payments exist for date range (past 4 months through current view)
    var td2 = getToday(), d = parseD(td2);
    var sY = d.getFullYear(), sM = d.getMonth() - 4;
    if (sM < 0) { sM += 12; sY--; }
    var created = 0;
    var y = sY, m = sM;
    while (y < viewY || (y === viewY && m <= viewM)) {
      var expected = genExpected(y, m, currentTmpls, currentEmps);
      for (var i = 0; i < expected.length; i++) {
        if (!payMap[expected[i].id]) {
          try {
            var spId = await spCreatePay(expected[i]);
            expected[i]._spId = spId;
            payMap[expected[i].id] = expected[i];
            created++;
          } catch(e2) { console.error('Create:', e2); }
        }
      }
      m++; if (m > 11) { m = 0; y++; }
    }
    if (created > 0) console.log('Created', created, 'new payment rows');
    return payMap;
  }

  // Initial load
  useEffect(function() {
    (async function() {
      try {
        var cfg = await spLoadConfig();
        var t = cfg.tmpls || DEF_REC;
        var e = cfg.emps || DEF_EMPS;
        var today = getToday();
        // Reset balance to 0 each day — force user to enter current balance
        var b = (cfg.balDate === today && cfg.bal !== undefined) ? cfg.bal : 0;
        setBal(b); setBalIn(String(b));
        if (cfg.balDate !== today) setEditBal(true); // auto-open balance editor
        setEmps(e); setTmpls(t);
        if (cfg.skipUntil) setSkipUntil(cfg.skipUntil);
        if (cfg.officeClosed) setOfficeClosed(cfg.officeClosed);
        if (cfg.zmanLoc) setZmanLoc(cfg.zmanLoc);
        updateClosedDays(cfg.officeClosed || {}, new Date().getFullYear());

        var payMap = await fullLoad(t, e, cy, cm);
        setPayments(payMap);
        hydrateAttachmentsFromPayments(payMap);
      } catch(e) { console.error('Load failed:', e); }
      setReady(true);
    })();
  }, []);

  // When view month changes, ensure those payments exist
  var lastView = useRef(cy + '-' + cm);
  useEffect(function() {
    if (!ready) return;
    var key = cy + '-' + cm;
    if (key === lastView.current) return;
    lastView.current = key;
    (async function() {
      var payMap = await fullLoad(tmpls, emps, cy, cm);
      setPayments(payMap);
      hydrateAttachmentsFromPayments(payMap);
    })();
  }, [cy, cm, ready]);

  // When templates/emps change, regenerate for current range
  var lastTmpls = useRef(null);
  useEffect(function() {
    if (!ready) return;
    var key = JSON.stringify(tmpls) + JSON.stringify(emps);
    if (key === lastTmpls.current) return;
    lastTmpls.current = key;
    (async function() {
      var payMap = await fullLoad(tmpls, emps, cy, cm);
      setPayments(payMap);
      hydrateAttachmentsFromPayments(payMap);
    })();
  }, [tmpls, emps, ready]);

  // Background refresh every 60 seconds — reload payments AND config
  useEffect(function() {
    if (!ready) return;
    refreshTimer.current = setInterval(async function() {
      try {
        var cfg = await spLoadConfig();
        if (cfg.officeClosed) { setOfficeClosed(cfg.officeClosed); updateClosedDays(cfg.officeClosed, new Date().getFullYear()); }
        if (cfg.tmpls) setTmpls(cfg.tmpls);
        if (cfg.zmanLoc) setZmanLoc(cfg.zmanLoc);
        var payMap = await spLoadAllPay();
        setPayments(payMap);
        hydrateAttachmentsFromPayments(payMap);
        console.log('BG refresh:', Object.keys(payMap).length, 'payments');
      } catch(e) { console.error('BG refresh failed:', e); }
    }, 60000);
    return function() { clearInterval(refreshTimer.current); };
  }, [ready]);

  /* ══════ SAVE CONFIG (debounced) ══════ */
  var cfgSkip = useRef(true);
  useEffect(function() {
    if (!ready) return;
    if (cfgSkip.current) { cfgSkip.current = false; return; }
    if (cfgTimer.current) clearTimeout(cfgTimer.current);
    setSaveStatus("saving");
    cfgTimer.current = setTimeout(async function() {
      try { await spSaveConfig({ bal: bal, balDate: getToday(), emps: emps, tmpls: tmpls, skipUntil: skipUntil, officeClosed: officeClosed, zmanLoc: zmanLoc }); setSaveStatus("saved"); }
      catch(e) { console.error('Save config:', e); setSaveStatus("error"); }
    }, 1500);
  }, [bal, emps, tmpls, skipUntil, officeClosed, zmanLoc, ready]);

  /* ══════ SEARCH FILTER ══════ */

  /* ══════ AUTO-UNSKIP: check skipUntil dates ══════ */
  useEffect(function() {
    if (!ready) return;
    var today = getToday();
    var changed = false;
    var newSkip = Object.assign({}, skipUntil);
    var unskipIds = [];
    Object.keys(newSkip).forEach(function(id) {
      if (newSkip[id] && newSkip[id] <= today) {
        unskipIds.push(id);
        delete newSkip[id];
        changed = true;
      }
    });
    if (changed) {
      setSkipUntil(newSkip);
      unskipIds.forEach(function(id) {
        var p = payments[id];
        if (p && p.excluded) {
          spUpdate(id, { Excluded: false });
        }
      });
    }
  }, [ready, payments]);

  function skipWithDate(id, untilDate) {
    var p = payments[id];
    // Mark as excluded if not already
    if (!p || !p.excluded) {
      spUpdate(id, { Excluded: true });
    }
    // Store or clear the unskip date
    if (untilDate) {
      setSkipUntil(function(prev) { var n = Object.assign({}, prev); n[id] = untilDate; return n; });
    } else {
      setSkipUntil(function(prev) { var n = Object.assign({}, prev); delete n[id]; return n; });
    }
    setSkipPickId(null);
    setSkipPickDate("");
  }

  function unskipPay(id) {
    spUpdate(id, { Excluded: false });
    setSkipUntil(function(prev) { var n = Object.assign({}, prev); delete n[id]; return n; });
  }
  var searchFilter = useCallback(function(p) {
    if (!searchQ) return true;
    var q = searchQ.toLowerCase();
    return (p.name && p.name.toLowerCase().indexOf(q) !== -1) ||
      (p.category && p.category.toLowerCase().indexOf(q) !== -1) ||
      (p.checkNum && p.checkNum.toLowerCase().indexOf(q) !== -1) ||
      (p.note && p.note.toLowerCase().indexOf(q) !== -1) ||
      (p.empName && p.empName.toLowerCase().indexOf(q) !== -1) ||
      (p.amount && String(p.amount).indexOf(q) !== -1) ||
      (p.dueDate && p.dueDate.indexOf(q) !== -1);
  }, [searchQ]);

  /* ══════ DERIVED DATA ══════ */
  var [td, setTd] = useState(getToday());
  // Keep today's date fresh — check every 30s and on tab focus
  useEffect(function() {
    function checkDate() {
      var now = getToday();
      if (now !== td) setTd(now);
    }
    var iv = setInterval(checkDate, 30000);
    function onVis() { if (!document.hidden) checkDate(); }
    document.addEventListener("visibilitychange", onVis);
    window.addEventListener("focus", onVis);
    return function() { clearInterval(iv); document.removeEventListener("visibilitychange", onVis); window.removeEventListener("focus", onVis); };
  }, [td]);
  var allPayments = useMemo(function() { return Object.values(payments); }, [payments]);

  var actionItems = useMemo(function() {
    return allPayments.filter(function(p){return p.status===UNPAID && effDue(p.dueDate)<=td;}).filter(searchFilter)
      .sort(function(a,b){return a.dueDate<b.dueDate?-1:a.dueDate>b.dueDate?1:b.amount-a.amount;});
  }, [allPayments, td, searchFilter]);
  var todayItems = useMemo(function(){return actionItems.filter(function(p){return effDue(p.dueDate)===td;});}, [actionItems,td]);
  var pastItems = useMemo(function(){return actionItems.filter(function(p){return effDue(p.dueDate)<td;});}, [actionItems,td]);
  var pendItems = useMemo(function(){
    return allPayments.filter(function(p){return p.status===PAID;}).filter(searchFilter).sort(function(a,b){return a.dueDate<b.dueDate?-1:1;});
  }, [allPayments, searchFilter]);
  var clrItems = useMemo(function(){
    return allPayments.filter(function(p){return p.status===CLEARED;}).filter(searchFilter).sort(function(a,b){return a.dueDate>b.dueDate?-1:1;});
  }, [allPayments, searchFilter]);

  var skippedItems = useMemo(function() {
    return allPayments.filter(function(p){return p.status===UNPAID && p.excluded;}).filter(searchFilter).sort(function(a,b){return a.dueDate<b.dueDate?-1:1;});
  }, [allPayments, searchFilter]);
  var skippedTotal = useMemo(function() { return skippedItems.reduce(function(s,p){return s+effAmt(p);},0); }, [skippedItems]);

  var sum = function(arr,filterExcl){return arr.filter(function(p){return filterExcl?!p.excluded:true;}).reduce(function(s,p){return s+effAmt(p);},0);};

  // Date-filtered totals: when a day is selected, show all unpaid+pending from today through that date
  var fActionItems = selDay
    ? allPayments.filter(function(p){return p.status===UNPAID && effDue(p.dueDate)<=selDay;})
    : actionItems;
  var fPendItems = selDay
    ? allPayments.filter(function(p){return p.status===PAID && p.dueDate<=selDay;})
    : pendItems;
  var fClrItems = selDay ? clrItems.filter(function(p){return p.dueDate<=selDay;}) : clrItems;

  // Future items: show unpaid items after today — when a future date is selected OR when searching
  var futureItems = useMemo(function() {
    var hasSearch = !!searchQ;
    var hasFutureDay = selDay && selDay > td;
    if (!hasSearch && !hasFutureDay) return [];
    var maxDate = hasFutureDay ? selDay : "9999-12-31";
    return allPayments.filter(function(p) { return p.status === UNPAID && effDue(p.dueDate) > td && effDue(p.dueDate) <= maxDate; }).filter(searchFilter)
      .sort(function(a,b) { return a.dueDate < b.dueDate ? -1 : a.dueDate > b.dueDate ? 1 : b.amount - a.amount; });
  }, [allPayments, selDay, td, searchFilter, searchQ]);

  var actionTotal = sum(fActionItems,true);
  var exclTotal = sum(fActionItems.filter(function(p){return p.excluded && !p.isReminder;}),false);
  var exclCount = fActionItems.filter(function(p){return p.excluded && !p.isReminder;}).length;
  var pendTotal = sum(fPendItems,false);
  var clrTotal = sum(fClrItems,false);
  var avail = bal - pendTotal;
  var gap = actionTotal - avail;
  var isShort = gap > 0;

  /* ══════ FORECAST (in-memory generation for date range) ══════ */
  var fcData = useMemo(function() {
    if (!showFc) return null;
    var fD = parseD(fcFrom), tD = parseD(fcTo);
    if (fD > tD) return { err: true };
    // Use existing payments + generate missing future ones in-memory
    var inRange = allPayments.filter(function(p) { return p.dueDate >= fcFrom && p.dueDate <= fcTo; });
    // Also generate expected for months not yet in SP
    var y = fD.getFullYear(), m = fD.getMonth();
    while (y < tD.getFullYear() || (y === tD.getFullYear() && m <= tD.getMonth())) {
      var exp = genExpected(y, m, tmpls, emps);
      exp.forEach(function(e) { if (!payments[e.id] && e.dueDate >= fcFrom && e.dueDate <= fcTo) inRange.push(e); });
      m++; if (m > 11) { m = 0; y++; }
    }
    var unpaid = inRange.filter(function(p){return p.status===UNPAID && !p.excluded;});
    var pend = inRange.filter(function(p){return p.status===PAID;});
    var tDue = unpaid.reduce(function(s,p){return s+effAmt(p);},0);
    var tPend = pend.reduce(function(s,p){return s+effAmt(p);},0);
    var total = tDue + tPend;
    var byDate = {};
    unpaid.concat(pend).forEach(function(p) {
      if(!byDate[p.dueDate]) byDate[p.dueDate]={items:[],total:0};
      byDate[p.dueDate].items.push(p); byDate[p.dueDate].total+=effAmt(p);
    });
    var byCat = {};
    unpaid.concat(pend).forEach(function(p){byCat[p.category]=(byCat[p.category]||0)+effAmt(p);});
    return {total:total,gap:total-bal,dates:Object.keys(byDate).sort(),byDate:byDate,byCat:byCat,count:unpaid.length+pend.length};
  }, [showFc,fcFrom,fcTo,allPayments,tmpls,emps,bal,payments]);

  /* ══════ CALENDAR ══════ */
  var jewishHols = useMemo(function() { return Object.assign({}, getJewishHolidays(cy), getJewishHolidays(cy+1)); }, [cy]);

  var calDays = useMemo(function() {
    // Ensure _closedDays is up-to-date before computing calendar
    updateClosedDays(officeClosed, cy >= 2020 ? cy : new Date().getFullYear());
    var days = [], dm = daysIn(cy,cm), first = new Date(cy,cm,1).getDay();
    for(var i=0;i<first;i++) days.push(null);
    for(var d=1;d<=dm;d++) {
      var ds = cy+"-"+pad(cm+1)+"-"+pad(d);
      var monthPay = allPayments.filter(function(p){return effDue(p.dueDate)===ds || p.dueDate===ds;});
      var due = monthPay.filter(function(p){return p.status===UNPAID;}).reduce(function(s,p){return s+effAmt(p);},0);
      var cnt = monthPay.filter(function(p){return p.status===UNPAID;}).length;
      var hp = monthPay.some(function(p){return p.isPayroll && p.status!==CLEARED;});
      var heb = gregToHebrew(cy, cm, d);
      var hebStr = heb.day + " " + hebrewMonthName(heb.month);
      var hebDay = heb.day;
      var hebMonth = hebrewMonthName(heb.month);
      var holiday = jewishHols[ds] || null;
      var isClosed = !!_closedDays[ds];
      var bankHol = _bankClosed[ds] || null;
      var isWknd = (new Date(cy,cm,d).getDay() === 0 || new Date(cy,cm,d).getDay() === 6);
      var dayOfWeek = new Date(cy,cm,d).getDay();
      var isFri = dayOfWeek === 5;
      var isSat = dayOfWeek === 6;
      // Parsha on Friday and Saturday
      var parsha = isFri ? getParshaForShabbat(cy, cm, d + 1) : isSat ? getParshaForShabbat(cy, cm, d) : "";
      var candle = "";
      // Candle lighting on Friday
      if (isFri) {
        candle = getCandleLighting(cy, cm, d, zmanLoc);
      }
      // Also show candle lighting on Yom Tov eve (day before major holiday)
      var tomorrow = cy+"-"+pad(cm+1)+"-"+pad(d+1 <= daysIn(cy,cm) ? d+1 : 1);
      if (!isFri && jewishHols[tomorrow] && OFFICE_CLOSED_HOLIDAYS.indexOf(jewishHols[tomorrow]) !== -1) {
        candle = getCandleLighting(cy, cm, d, zmanLoc);
      }
      // Havdalah / Yom Tov end time - on Shabbos and major Yom Tov days
      var havdalah = "";
      if (isSat) {
        havdalah = getHavdalahTime(cy, cm, d, zmanLoc);
      } else if (holiday && OFFICE_CLOSED_HOLIDAYS.indexOf(holiday) !== -1) {
        // Check if tomorrow is NOT also Yom Tov/Shabbos (only show end on last day)
        var tmrwD = new Date(cy, cm, d + 1);
        var tmrwKey2 = toISO(tmrwD);
        var tmrwHol = jewishHols[tmrwKey2] || null;
        var tmrwIsSat = tmrwD.getDay() === 6;
        var tmrwIsYomTov = tmrwHol && OFFICE_CLOSED_HOLIDAYS.indexOf(tmrwHol) !== -1;
        if (!tmrwIsSat && !tmrwIsYomTov) {
          havdalah = getHavdalahTime(cy, cm, d, zmanLoc);
        }
      }
      var fastInfo = getFastTimes(cy, cm, d);
      var specialShab = isSat ? getSpecialShabbos(cy, cm, d) : [];
      days.push({day:d,ds:ds,due:due,cnt:cnt,hp:hp,heb:hebStr,hebDay:hebDay,hebMonth:hebMonth,hebYear:heb.year,holiday:holiday,isClosed:isClosed,isWknd:isWknd,bankHol:bankHol,parsha:parsha,candle:candle,havdalah:havdalah,fastInfo:fastInfo,specialShab:specialShab});
    }
    return days;
  }, [cy,cm,allPayments,officeClosed,zmanLoc]);

  var dayItems = useMemo(function() {
    if (!selDay) return [];
    return allPayments.filter(function(p) { return effDue(p.dueDate) === selDay || p.dueDate === selDay; })
      .sort(function(a,b) { return a.status === CLEARED ? 1 : b.status === CLEARED ? -1 : a.dueDate < b.dueDate ? -1 : a.dueDate > b.dueDate ? 1 : a.name < b.name ? -1 : 1; });
  }, [selDay, allPayments]);

  /* ══════ ACTIONS — optimistic UI + background SP write ══════ */
  var fieldMap = {PayStatus:'status',CheckNum:'checkNum',PayNote:'note',Excluded:'excluded',UseMin:'useMin',
    Title:'name',Category:'category',Amount:'amount',DueDate:'dueDate',AutoPay:'autoPay',MinPay:'minPay',CloseDate:'closeDate',
    IsReminder:'isReminder',PayCard:'payCard'};

  function spFieldsToJs(fields) {
    var js = {};
    Object.keys(fields).forEach(function(k) { if (fieldMap[k]) js[fieldMap[k]] = fields[k]; });
    return js;
  }

  function spUpdate(id, fields) {
    var p = payments[id];
    if (!p || !p._spId) { console.error('No SP ID for', id); return; }
    // Optimistic: update local state immediately
    setPayments(function(prev) {
      var n = Object.assign({}, prev);
      n[id] = Object.assign({}, n[id], spFieldsToJs(fields));
      return n;
    });
    // Write to SP in background
    setSaveStatus("saving");
    spUpdatePay(p._spId, fields).then(function() {
      setSaveStatus("saved");
    }).catch(function(e) {
      console.error('Update:', e);
      setSaveStatus("error");
    });
  }

  function markPaid(id) { spUpdate(id, { PayStatus: PAID }); }
  function markCleared(id) { spUpdate(id, { PayStatus: CLEARED }); }
  function markUnpaid(id) { spUpdate(id, { PayStatus: UNPAID, CheckNum: '' }); }
  function toggleExcl(id) {
    var p = payments[id];
    if (p) spUpdate(id, { Excluded: !p.excluded });
  }
  function toggleMin(id) {
    var p = payments[id];
    if (p) spUpdate(id, { UseMin: !p.useMin });
  }
  function delPay(id) {
    var p = payments[id];
    if (!p || !p._spId) return;
    // Optimistic: remove from state immediately
    setPayments(function(prev) { var n = Object.assign({}, prev); delete n[id]; return n; });
    setSaveStatus("saving");
    spDeletePay(p._spId).then(function() { setSaveStatus("saved"); })
      .catch(function(e) { console.error('Delete:', e); setSaveStatus("error"); });
  }
  function delTmpl(name) { setTmpls(function(p){return p.filter(function(t){return t.name!==name;});}); }

  function addPay() {
    if (!form.name || !form.amount) return;
    var isCC = form.category === "Credit Card";
    if (form.isRecurring) {
      if (!form.dayOfMonth) return;
      setTmpls(function(prev) {
        return prev.concat([{
          name:form.name,category:form.category,amount:parseFloat(form.amount),
          dayOfMonth:parseInt(form.dayOfMonth),autoPay:form.autoPay,varies:!form.sameAmount,
          minPay:isCC&&form.minPay?parseFloat(form.minPay):0,
          closeDay:isCC&&form.closeDay?parseInt(form.closeDay):0,
          startDate:form.startDate||getToday(),endDate:form.endDate||"",
          note:form.note||"",
          isReminder:!!form.isReminder,defaultCard:form.payCard||""
        }]);
      });
    } else {
      if (!form.dueDate) return;
      var newP = {
        id:"ot-"+Date.now()+"-"+Math.random().toString(36).slice(2,6),
        name:form.name,category:form.category,amount:parseFloat(form.amount),
        minPay:isCC&&form.minPay?parseFloat(form.minPay):0,
        closeDate:isCC&&form.closeDay?form.dueDate.slice(0,8)+pad(parseInt(form.closeDay)):"",
        useMin:false,dueDate:form.dueDate,autoPay:form.autoPay,
        status:UNPAID,checkNum:"",isPayroll:false,varies:false,excluded:false,note:form.note||"",
        isReminder:!!form.isReminder,payCard:form.payCard||""
      };
      // Optimistic: add to state immediately
      setPayments(function(prev) { var n = Object.assign({}, prev); n[newP.id] = newP; return n; });
      // Create in SP in background
      setSaveStatus("saving");
      spCreatePay(newP).then(function(spId) {
        newP._spId = spId;
        setPayments(function(prev) { var n = Object.assign({}, prev); n[newP.id] = Object.assign({}, n[newP.id], { _spId: spId }); return n; });
        setSaveStatus("saved");
      }).catch(function(e) { console.error('Add:', e); setSaveStatus("error"); });
    }
    setForm({name:"",category:"Invoice",amount:"",dueDate:getToday(),autoPay:false,checkNum:"",note:"",minPay:"",closeDay:"",isRecurring:false,dayOfMonth:"1",sameAmount:true,isReminder:false,payCard:"",startDate:getToday(),endDate:""});
    setShowAdd(false);
  }

  function addRec() {
    if (!recF.name||!recF.amount||!recF.dayOfMonth) return;
    var isCC = recF.category === "Credit Card";
    setTmpls(function(prev) {
      return prev.concat([{
        name:recF.name,category:recF.category,amount:parseFloat(recF.amount),
        dayOfMonth:parseInt(recF.dayOfMonth),autoPay:recF.autoPay,varies:recF.varies,
        minPay:isCC&&recF.minPay?parseFloat(recF.minPay):0,
        closeDay:isCC&&recF.closeDay?parseInt(recF.closeDay):0,
        startDate:recF.startDate||getToday(),
        endDate:recF.endDate||"",
        isReminder:!!recF.isReminder,defaultCard:recF.defaultCard||""
      }]);
    });
    setRecF({name:"",category:"Credit Card",amount:"",dayOfMonth:"1",autoPay:false,varies:true,minPay:"",closeDay:"",startDate:getToday(),endDate:"",isReminder:false,defaultCard:""});
    setShowRec(false);
  }

  function remTmpl(name) { setTmpls(function(prev){return prev.filter(function(t){return t.name!==name;});}); }

  function openEditTmpl(idx) {
    var t = tmpls[idx];
    setEditTmplIdx(idx);
    setEditTmplF({
      name:t.name, category:t.category, amount:String(t.amount),
      dayOfMonth:String(t.dayOfMonth), autoPay:t.autoPay, varies:t.varies||false,
      minPay:t.minPay?String(t.minPay):"", closeDay:t.closeDay?String(t.closeDay):"",
      startDate:t.startDate||"", endDate:t.endDate||"",
      isReminder:!!t.isReminder, defaultCard:t.defaultCard||"",
      note:t.note||""
    });
  }
  function saveEditTmpl() {
    if (!editTmplF || editTmplIdx === null) return;
    var isCC = editTmplF.category === "Credit Card";
    var oldTmpl = tmpls[editTmplIdx];
    var newNote = editTmplF.note || "";
    var newAmt = parseFloat(editTmplF.amount);
    var newTmpl = {
      name:editTmplF.name, category:editTmplF.category, amount:newAmt,
      dayOfMonth:parseInt(editTmplF.dayOfMonth), autoPay:editTmplF.autoPay, varies:editTmplF.varies,
      minPay:isCC&&editTmplF.minPay?parseFloat(editTmplF.minPay):0,
      closeDay:isCC&&editTmplF.closeDay?parseInt(editTmplF.closeDay):0,
      startDate:editTmplF.startDate||"", endDate:editTmplF.endDate||"",
      stmtUpdated: oldTmpl.stmtUpdated || "",
      isReminder: !!editTmplF.isReminder, defaultCard: editTmplF.defaultCard || "",
      note: newNote
    };
    setTmpls(function(prev) { var n = prev.slice(); n[editTmplIdx] = newTmpl; return n; });

    // Propagate template changes to all UNPAID payments from this template
    // Only update fields that still match the OLD template defaults (user hasn't customized them)
    var oldNote = oldTmpl.note || "";
    var oldAmt = oldTmpl.amount;
    setPayments(function(prev) {
      var updated = Object.assign({}, prev);
      var dirty = [];
      Object.keys(updated).forEach(function(pid) {
        var p = updated[pid];
        if (p.status !== UNPAID) return;
        if (p.name !== oldTmpl.name) return;
        if (!pid.startsWith("r-")) return; // only recurring-generated payments
        var changed = false;
        var patch = {};
        // Update note if it still matches old template note (user didn't customize)
        if (p.note === oldNote && newNote !== oldNote) { patch.note = newNote; changed = true; }
        // Update amount if same-amount mode and amount still matches old template
        if (!newTmpl.varies && p.amount === oldAmt && newAmt !== oldAmt) { patch.amount = newAmt; changed = true; }
        // Update autoPay
        if (p.autoPay !== newTmpl.autoPay) { patch.autoPay = newTmpl.autoPay; changed = true; }
        if (changed) {
          updated[pid] = Object.assign({}, p, patch);
          dirty.push(updated[pid]);
        }
      });
      // Persist changes to SP in background
      dirty.forEach(function(dp) { if (dp._spId) spUpdatePay(dp._spId, payToFields(dp)).catch(function(e){ console.error("Tmpl propagate:", e); }); });
      return updated;
    });

    setEditTmplIdx(null); setEditTmplF(null);
  }

  var [ccUpdateIdx, setCcUpdateIdx] = useState(null);
  var [ccNewAmt, setCcNewAmt] = useState("");
  var [ccNewMin, setCcNewMin] = useState("");
  var [ccDismissed, setCcDismissed] = useState({});  // { tmplName: true }

  // CC statement alert: find credit cards where close day has passed this month and statement not yet updated
  var ccAlerts = useMemo(function() {
    var today = getToday();
    var todayD = parseD(today);
    var curMk = todayD.getFullYear() + "-" + pad(todayD.getMonth() + 1);
    return tmpls.map(function(t, idx) {
      if (t.category !== "Credit Card" || !t.closeDay) return null;
      if (t.isReminder) return null; // Reminders don't have CC statements
      var dm = daysIn(todayD.getFullYear(), todayD.getMonth());
      var closeDay = Math.min(t.closeDay, dm);
      var closeDate = curMk + "-" + pad(closeDay);
      if (today < closeDate) return null; // close day hasn't passed yet
      if (t.stmtUpdated === curMk) return null; // already updated this month
      if (ccDismissed[t.name]) return null; // dismissed this session
      return { idx: idx, name: t.name, closeDate: closeDate };
    }).filter(Boolean);
  }, [tmpls, ccDismissed]);

  // Credit card names from templates (for reminder card picker)
  var ccCardNames = useMemo(function() {
    return tmpls.filter(function(t) { return t.category === "Credit Card" && !t.isReminder; }).map(function(t) { return t.name; });
  }, [tmpls]);

  // Reminder alerts: for reminder templates where invoice/statement date has passed
  var reminderAlerts = useMemo(function() {
    var today = getToday();
    var todayD = parseD(today);
    var curMk = todayD.getFullYear() + "-" + pad(todayD.getMonth() + 1);
    return tmpls.map(function(t, idx) {
      if (!t.isReminder) return null;
      if (!t.closeDay) return null; // closeDay doubles as invoice/statement date for reminders
      var dm = daysIn(todayD.getFullYear(), todayD.getMonth());
      var invDay = Math.min(t.closeDay, dm);
      var invDate = curMk + "-" + pad(invDay);
      if (today < invDate) return null;
      if (t.stmtUpdated === curMk) return null;
      if (ccDismissed["rem_" + t.name]) return null;
      return { idx: idx, name: t.name, invDate: invDate, category: t.category };
    }).filter(Boolean);
  }, [tmpls, ccDismissed]);

  var [remUpdateIdx, setRemUpdateIdx] = useState(null);
  var [remNewAmt, setRemNewAmt] = useState("");

  function updateReminderStatement(idx) {
    if (!remNewAmt) return;
    var todayD = parseD(getToday());
    var curMk = todayD.getFullYear() + "-" + pad(todayD.getMonth() + 1);
    var tName = tmpls[idx].name;
    setTmpls(function(prev) {
      var n = prev.slice();
      n[idx] = Object.assign({}, n[idx], { amount: parseFloat(remNewAmt), stmtUpdated: curMk });
      return n;
    });
    // Also update this month's payment row
    var payId = "r-" + curMk + "-" + tName;
    if (payments[payId]) {
      spUpdate(payId, { Amount: parseFloat(remNewAmt) });
    }
    setCcDismissed(function(prev) { var n = Object.assign({}, prev); n["rem_" + tName] = true; return n; });
    setRemUpdateIdx(null); setRemNewAmt("");
  }

  function dismissReminderAlert(idx) {
    var todayD = parseD(getToday());
    var curMk = todayD.getFullYear() + "-" + pad(todayD.getMonth() + 1);
    var tName = tmpls[idx].name;
    setTmpls(function(prev) {
      var n = prev.slice();
      n[idx] = Object.assign({}, n[idx], { stmtUpdated: curMk });
      return n;
    });
    setCcDismissed(function(prev) { var n = Object.assign({}, prev); n["rem_" + tName] = true; return n; });
  }

  // Quick card change on a reminder row
  function setPayCard(id, card) {
    spUpdate(id, { PayCard: card });
    // Also update template default if this is recurring
    var p = payments[id];
    if (p && p.id.startsWith("r-")) {
      var tName = p.name;
      setTmpls(function(prev) {
        return prev.map(function(t) {
          if (t.name === tName && t.isReminder) return Object.assign({}, t, { defaultCard: card });
          return t;
        });
      });
    }
  }

  function updateCcStatement(idx) {
    if (!ccNewAmt) return;
    var todayD = parseD(getToday());
    var curMk = todayD.getFullYear() + "-" + pad(todayD.getMonth() + 1);
    var tName = tmpls[idx].name;
    setTmpls(function(prev) {
      var n = prev.slice();
      n[idx] = Object.assign({}, n[idx], {
        amount: parseFloat(ccNewAmt),
        minPay: ccNewMin ? parseFloat(ccNewMin) : n[idx].minPay,
        stmtUpdated: curMk
      });
      return n;
    });
    // Also update the current month's payment row if it exists
    var t = tmpls[idx];
    var mk = curMk;
    var payId = "r-" + mk + "-" + t.name;
    if (payments[payId]) {
      var fields = { Amount: parseFloat(ccNewAmt) };
      if (ccNewMin) fields.MinPay = parseFloat(ccNewMin);
      spUpdate(payId, fields);
    }
    setCcDismissed(function(prev) { var n = Object.assign({}, prev); n[tName] = true; return n; });
    setCcUpdateIdx(null); setCcNewAmt(""); setCcNewMin("");
  }

  function dismissCcAlert(idx) {
    var todayD = parseD(getToday());
    var curMk = todayD.getFullYear() + "-" + pad(todayD.getMonth() + 1);
    var tName = tmpls[idx].name;
    setTmpls(function(prev) {
      var n = prev.slice();
      n[idx] = Object.assign({}, n[idx], { stmtUpdated: curMk });
      return n;
    });
    setCcDismissed(function(prev) { var n = Object.assign({}, prev); n[tName] = true; return n; });
  }

  // Attachment functions
  async function uploadAttachment(payId, file) {
    setAttachLoading(true);
    try {
      console.log('Uploading attachment for', payId, file.name);
      var info = await spUploadAttachment(payId, file);
      console.log('Upload success:', info);
      var newList = (attachments[payId] || []).concat([info]);
      setAttachments(function(prev) { var n = Object.assign({}, prev); n[payId] = newList; return n; });
      // Persist to SP list item
      saveAttachDataToSP(payId, newList);
    } catch(e) { console.error('Upload failed:', e); alert('Upload failed: ' + e.message); }
    setAttachLoading(false);
  }

  function saveAttachDataToSP(payId, attachList) {
    // Find payment's _spId and update AttachData field
    var p = paymentsRef.current[payId];
    if (p && p._spId) {
      var data = attachList.map(function(a) { return { name: a.name, driveItemId: a.driveItemId, webUrl: a.webUrl }; });
      console.log('Saving AttachData for', payId, 'spId:', p._spId, 'items:', data.length);
      spUpdatePay(p._spId, { AttachData: JSON.stringify(data) }).then(function() {
        console.log('AttachData saved successfully for', payId);
      }).catch(function(e) { console.warn('Save attach data failed:', e); });
    } else {
      console.warn('saveAttachDataToSP: no payment or _spId for', payId, 'payment:', p);
    }
  }


  function hydrateAttachmentsFromPayments(payMap) {
    var map = {};
    var total = Object.keys(payMap).length;
    var withData = 0;
    Object.keys(payMap).forEach(function(id) {
      var p = payMap[id];
      if (p.attachData) {
        withData++;
        try {
          var arr = JSON.parse(p.attachData);
          if (arr && arr.length > 0) map[id] = arr;
        } catch(e) { console.warn('Bad attachData JSON for', id, p.attachData); }
      }
    });
    if (Object.keys(map).length > 0) {
      setAttachments(function(prev) { return Object.assign({}, prev, map); });
    }
    console.log('Attachments hydrated:', Object.keys(map).length, 'of', total, 'payments.', withData, 'had attachData field');
  }

  async function removeAttachment(payId, idx) {
    var arr = attachments[payId];
    if (!arr || !arr[idx]) return;
    var att = arr[idx];
    if (!confirm('Remove attachment ' + att.name + '?')) return;
    try {
      await spDeleteAttachment(att.driveItemId);
      var newArr = arr.filter(function(_, i) { return i !== idx; });
      setAttachments(function(prev) {
        var n = Object.assign({}, prev);
        if (newArr.length === 0) delete n[payId]; else n[payId] = newArr;
        return n;
      });
      saveAttachDataToSP(payId, newArr);
    } catch(e) { alert('Delete failed: ' + e.message); }
  }

  function openEdit(p) {
    setEditId(p.id);
    // For note, fall back to template note if payment has no custom note
    var editNote = p.note || "";
    if (!editNote && p.id && p.id.startsWith("r-")) {
      var tmpl = tmpls.find(function(t) { return t.name === p.name; });
      if (tmpl && tmpl.note) editNote = tmpl.note;
    }
    setForm({name:p.name,category:p.category,amount:String(p.amount),dueDate:p.dueDate,autoPay:p.autoPay,checkNum:p.checkNum||"",note:editNote,minPay:p.minPay?String(p.minPay):"",closeDay:p.closeDate?String(parseInt(p.closeDate.slice(-2))):"",isReminder:!!p.isReminder,payCard:p.payCard||""});
  }

  function saveEdit() {
    var isCC = form.category === "Credit Card";
    var fields = {
      Title: form.name, Category: form.category, Amount: parseFloat(form.amount),
      DueDate: form.dueDate, AutoPay: form.autoPay, CheckNum: form.checkNum || "",
      PayNote: form.note || "",
      MinPay: isCC && form.minPay ? parseFloat(form.minPay) : 0,
      CloseDate: isCC && form.closeDay ? form.dueDate.slice(0,8)+pad(parseInt(form.closeDay)) : "",
      MonthKey: form.dueDate.substring(0,7),
      PayCard: form.payCard || ""
    };
    spUpdate(editId, fields);
    setEditId(null);
  }

  function addEmp() {
    if(!empF.name||!empF.salary) return;
    setEmps(function(p){return p.concat([{name:empF.name,salary:parseFloat(empF.salary),startDate:empF.startDate||getToday(),pauseFrom:"",pauseTo:""}]);});
    setEmpF({name:"",salary:"",startDate:getToday()});
  }
  function remEmp(n) { setEmps(function(p){return p.filter(function(e){return e.name!==n;});}); }
  function pauseEmp(n, from, to) {
    setEmps(function(p){return p.map(function(e){return e.name===n?Object.assign({},e,{pauseFrom:from,pauseTo:to}):e;});});
  }
  function unpauseEmp(n) {
    setEmps(function(p){return p.map(function(e){return e.name===n?Object.assign({},e,{pauseFrom:"",pauseTo:""}):e;});});
  }
  function openEditEmp(emp) {
    setEditEmpName(emp.name);
    setEditEmpF({ name: emp.name, salary: String(emp.salary), startDate: emp.startDate || "" });
  }
  function saveEditEmp() {
    if (!editEmpF || !editEmpName) return;
    setEmps(function(prev) {
      return prev.map(function(e) {
        if (e.name !== editEmpName) return e;
        return Object.assign({}, e, {
          name: editEmpF.name,
          salary: parseFloat(editEmpF.salary) || e.salary,
          startDate: editEmpF.startDate || e.startDate
        });
      });
    });
    setEditEmpName(null);
    setEditEmpF(null);
  }
  var [pauseEmpName, setPauseEmpName] = useState(null);
  var [pauseFrom, setPauseFrom] = useState(getToday());
  var [pauseTo, setPauseTo] = useState("");
  function saveChk(id) { spUpdate(id, { CheckNum: chkIn }); setCheckId(null); setChkIn(""); }
  function saveNote(id) { spUpdate(id, { PayNote: noteIn }); setNoteId(null); setNoteIn(""); }
  function saveBal() { var v=parseFloat(balIn.replace(/,/g,"")); if(!isNaN(v)) setBal(v); setEditBal(false); }
  function navMo(dir) { var m=cm+dir,y=cy; if(m>11){m=0;y++;} if(m<0){m=11;y--;} setCm(m);setCy(y);setSelDay(null); }

  // Multi-select helpers
  function toggleSel(id) { setSelected(function(prev) { var n = Object.assign({}, prev); if (n[id]) delete n[id]; else n[id] = true; return n; }); }
  var selIds = Object.keys(selected);
  var selCount = selIds.length;

  function selAll(items) {
    var s = {};
    items.forEach(function(p) { s[p.id] = true; });
    setSelected(s);
  }
  function selNone() { setSelected({}); }
  function allSelected(items) { return items.length > 0 && items.every(function(p) { return !!selected[p.id]; }); }
  function toggleSelAll(items) { if (allSelected(items)) { var n = Object.assign({}, selected); items.forEach(function(p) { delete n[p.id]; }); setSelected(n); } else { selAll(items); } }

  function bulkPaid() {
    if (!confirm("Mark " + selCount + " items as Paid?")) return;
    selIds.forEach(function(id) { markPaid(id); });
    setSelected({});
  }
  function bulkUnskip() {
    if (!confirm("Unskip " + selCount + " items?")) return;
    selIds.forEach(function(id) { unskipPay(id); });
    setSelected({});
  }

  function bulkCleared() {
    if (!confirm("Mark " + selCount + " items as Cleared?")) return;
    selIds.forEach(function(id) { markCleared(id); });
    setSelected({});
  }
  function bulkDelete() {
    if (!confirm("DELETE " + selCount + " items? This cannot be undone.")) return;
    selIds.forEach(function(id) { delPay(id); });
    setSelected({});
  }
  function bulkUnpaid() {
    if (!confirm("Move " + selCount + " items back to Unpaid?")) return;
    selIds.forEach(function(id) { markUnpaid(id); });
    setSelected({});
  }

  function bulkSkip() {
    setSkipPickId("__bulk__");
    setSkipPickDate("");
  }

  function bulkResumeDate() {
    setSkipPickId("__bulk_resume__");
    setSkipPickDate("");
  }

  async function doRefresh() {
    setSaveStatus("saving");
    try {
      var cfg = await spLoadConfig();
      if (cfg.officeClosed) { setOfficeClosed(cfg.officeClosed); updateClosedDays(cfg.officeClosed, new Date().getFullYear()); }
      if (cfg.tmpls) setTmpls(cfg.tmpls);
      if (cfg.zmanLoc) setZmanLoc(cfg.zmanLoc);
      var m = await spLoadAllPay(); setPayments(m); hydrateAttachmentsFromPayments(m);
      setTd(getToday());
      setSaveStatus("saved");
    }
    catch(e) { console.error('Refresh:', e); setSaveStatus("error"); }
  }

  async function resetAllData() {
    if (!confirm("⚠️ DELETE ALL payment rows and templates?\n\nThis will:\n• Delete ALL payment rows from SharePoint\n• Clear all recurring templates\n• Clear all employees\n• Reset balance to 0\n\nYou can then set up your own data from scratch.\n\nThis cannot be undone!")) return;
    setSaveStatus("saving");
    try {
      // Delete all payment rows from SP
      var items = await getAllItems(SP.payListId);
      for (var i = 0; i < items.length; i++) {
        try { await spDeletePay(items[i].id); } catch(e) {}
      }
      // Clear local state
      setPayments({});
      setTmpls([]);
      setEmps([]);
      setBal(0);
      setBalIn("0");
      // Save empty config
      await spSaveConfig({ bal: 0, balDate: '', emps: [], tmpls: [] });
      setSaveStatus("saved");
      alert("✅ All data cleared! You can now add your own templates, employees, and payments.");
    } catch(e) { console.error('Reset:', e); setSaveStatus("error"); }
  }

  /* ══════ WHATSAPP SUMMARY — copy-paste for boss ══════ */
  function generateSummary(opts) {
    if (!opts) opts = shareOpts;
    var today = new Date();
    var dateStr = today.toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric", year: "numeric" });
    var throughDate = selDay && selDay > td ? selDay : null;

    // Get items: due/past-due + future if date selected, excluding skipped
    var cutoff = throughDate || td;
    var dueItems = allPayments.filter(function(p) {
      return p.status === UNPAID && effDue(p.dueDate) <= cutoff && !p.excluded;
    }).sort(function(a, b) {
      return a.dueDate < b.dueDate ? -1 : a.dueDate > b.dueDate ? 1 : b.amount - a.amount;
    });

    var totalDue = dueItems.reduce(function(s, p) { return s + effAmt(p); }, 0);
    var fundingGap = totalDue - avail;

    var lines = [];
    if (throughDate) {
      lines.push("💰 *OpsPay — Funding Summary*");
      lines.push("📅 " + dateStr);
      lines.push("📆 *Through:* " + fmtS(throughDate) + " (" + dayN(throughDate) + ")");
    } else {
      lines.push("💰 *OpsPay — Daily Summary*");
      lines.push("📅 " + dateStr);
    }
    lines.push("");

    // Balances
    if (opts.balance) {
      lines.push("🏦 *Operating Account Balance:* " + fmt(bal));
    }
    if (opts.available) {
      lines.push("📊 *Available (After Pending):* " + fmt(avail));
    }
    if (opts.balance || opts.available) lines.push("");

    // Funding
    if (opts.totalDue && totalDue > 0) {
      lines.push("💵 *Total Payments Due" + (throughDate ? " Through " + fmtS(throughDate) : "") + ":* " + fmt(totalDue));
    }
    if (opts.funding) {
      if (totalDue > 0) {
        if (fundingGap > 0) {
          lines.push("🔴 *Additional Funding Needed:* " + fmt(fundingGap));
        } else {
          lines.push("✅ *No additional funding needed* — covered by " + fmt(Math.abs(fundingGap)));
        }
      } else {
        lines.push("✅ *No payments due" + (throughDate ? " through " + fmtS(throughDate) : " today") + "* — all caught up!");
      }
    }

    if (opts.pending && pendTotal > 0) {
      lines.push("⏳ *Pending to Clear:* " + fmt(pendTotal));
    }

    // Items list
    if (opts.itemList && dueItems.length > 0) {
      lines.push("");
      lines.push("━━━━━━━━━━━━━━━━━━");
      lines.push("📋 *Payments Due (" + dueItems.length + "):*");

      if (opts.itemDetails) {
        lines.push("");
        var lastDate = null;
        dueItems.forEach(function(p) {
          if (p.dueDate !== lastDate) {
            lastDate = p.dueDate;
            if (p.dueDate === td) {
              lines.push("▸ *Due Today:*");
            } else if (p.dueDate < td) {
              var daysOver = Math.floor((new Date(td + "T12:00:00") - new Date(p.dueDate + "T12:00:00")) / 86400000);
              lines.push("▸ *" + fmtS(p.dueDate) + "* (" + daysOver + "d overdue):");
            } else {
              lines.push("▸ *" + fmtS(p.dueDate) + "* (" + dayN(p.dueDate) + "):");
            }
          }
          var amtStr = fmt(effAmt(p));
          var extras = [];
          if (p.autoPay) extras.push("Auto-Pay");
          if (p.category === "Credit Card" && p.useMin) extras.push("Min Pmt");
          if (p.checkNum) extras.push("Chk #" + p.checkNum);
          var line = "    • " + p.name + " — " + amtStr;
          if (extras.length) line += " _(" + extras.join(", ") + ")_";
          lines.push(line);
        });
      }
    }

    lines.push("");
    lines.push("━━━━━━━━━━━━━━━━━━");

    return lines.join("\n");
  }

  function copySummary() {
    var text = generateSummary(shareOpts);
    navigator.clipboard.writeText(text).then(function() {
      setCopied(true);
      setTimeout(function() { setCopied(false); }, 2500);
    }).catch(function() {
      // Fallback
      var ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      setCopied(true);
      setTimeout(function() { setCopied(false); }, 2500);
    });
  }

  /* ── Date Badge: small pill shown above the first item of each date ── */
  function DateBadge({ date }) {
    var isToday = date === td;
    var isPast = date < td;
    return (
      <div style={{
        padding: "4px 12px", fontSize: 11, fontWeight: 700,
        color: isToday ? "#1e40af" : isPast ? "#991b1b" : "#374151",
        background: isToday ? "#dbeafe" : isPast ? "#fee2e2" : "#f1f5f9",
        borderRadius: "6px 6px 0 0", borderBottom: "none",
        display: "inline-flex", alignItems: "center", gap: 6,
        marginTop: 8, marginLeft: 4
      }}>
        <span style={{ width: 6, height: 6, borderRadius: "50%", background: isToday ? "#3b82f6" : isPast ? "#ef4444" : "#94a3b8" }} />
        {isToday ? "Today — " + fmtS(date) : fmtS(date) + " · " + dayN(date)}
      </div>
    );
  }

  /* ── Render a list of items grouped by date with date badges ── */
  function GroupedRows({ items, sec }) {
    var lastDate = null;
    var globalIdx = 0;
    return items.map(function(p) {
      var showBadge = p.dueDate !== lastDate;
      lastDate = p.dueDate;
      var idx = globalIdx++;
      return (
        <div key={p.id}>
          {showBadge && <DateBadge date={p.dueDate} />}
          <Row p={p} sec={sec} idx={idx} />
        </div>
      );
    });
  }

  /* ════ UI starts here ════ */
  function Row({ p, sec, idx }) {
    var cat = CATS[p.category] || CATS.Other;
    var isPast = effDue(p.dueDate) < td && p.status === UNPAID;
    var isExcl = p.excluded && sec === "action";
    var isCC = p.category === "Credit Card";
    var isRem = p.isReminder;
    // Effective note: payment's own note, or fall back to template note for recurring
    var tmplNote = "";
    if (!p.note && p.id && p.id.startsWith("r-")) {
      var tmpl = tmpls.find(function(t) { return t.name === p.name; });
      if (tmpl && tmpl.note) tmplNote = tmpl.note;
    }
    var effectiveNote = p.note || tmplNote;
    var amt = effAmt(p);
    var stripe = idx % 2 === 0 ? "white" : "#f9fafb";

    // For reminders, figure out what card to show
    // Find the template's default card
    var tmplDefaultCard = "";
    if (isRem && p.id.startsWith("r-")) {
      var tmpl = tmpls.find(function(t) { return t.name === p.name && t.isReminder; });
      if (tmpl) tmplDefaultCard = tmpl.defaultCard || "";
    }
    var displayCard = p.payCard || tmplDefaultCard;
    // Check if last payment used a different card than default
    var lastCardNote = "";
    if (isRem && p.payCard && tmplDefaultCard && p.payCard !== tmplDefaultCard) {
      lastCardNote = "Default: " + tmplDefaultCard;
    }

    return (
      <div style={{
        background: isRem ? (isExcl ? "#f5f3ff" : (stripe === "white" ? "#faf5ff" : "#f5f0ff")) : (isExcl ? "#f1f5f9" : stripe),
        padding: "14px 16px",
        borderBottom: "1px solid #e5e7eb",
        borderLeft: isRem ? "3px solid #a78bfa" : (isPast && !isExcl ? "3px solid #ef4444" : "3px solid transparent"),
        display: "flex", alignItems: "flex-start", gap: 10,
        opacity: isExcl ? 0.5 : 1
      }}>
        {/* Multi-select checkbox */}
        <input type="checkbox" checked={!!selected[p.id]} onChange={function() { toggleSel(p.id); }} style={{
          width: 18, height: 18, flexShrink: 0, marginTop: 4, cursor: "pointer", accentColor: isRem ? "#8b5cf6" : "#3b82f6"
        }} />
        {/* Status button */}
        {sec === "action" && !isRem && (
          <button onClick={function() { markPaid(p.id); }} style={{
            width: 26, height: 26, borderRadius: 6, flexShrink: 0, marginTop: 2,
            border: "2px solid #93c5fd", background: "#eff6ff",
            cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center",
            color: "#60A5FA", fontSize: 13, fontWeight: 700
          }}>$</button>
        )}
        {sec === "action" && isRem && (
          <button onClick={function() { markCleared(p.id); }} style={{
            width: 26, height: 26, borderRadius: 6, flexShrink: 0, marginTop: 2,
            border: "2px solid #c4b5fd", background: "#f5f3ff",
            cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center",
            color: "#8b5cf6", fontSize: 12, fontWeight: 700
          }}>💳</button>
        )}
        {sec === "pending" && (
          <button onClick={function() { markCleared(p.id); }} style={{
            width: 26, height: 26, borderRadius: 6, flexShrink: 0, marginTop: 2,
            border: "2px solid #6ee7b7", background: "#ecfdf5",
            cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center",
            color: "#059669", fontSize: 12, fontWeight: 700
          }}>✓</button>
        )}
        {sec === "cleared" && (
          <div style={{
            width: 26, height: 26, borderRadius: 6, flexShrink: 0, marginTop: 2,
            background: "linear-gradient(135deg,#10B981,#059669)",
            display: "flex", alignItems: "center", justifyContent: "center",
            color: "#fff", fontSize: 12, fontWeight: 700
          }}>✓</div>
        )}

        <div style={{ width: 6, height: 6, borderRadius: "50%", background: isRem ? "#a78bfa" : cat.dot, flexShrink: 0, marginTop: 7 }} />

        {/* Info */}
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{
            fontSize: 15, fontWeight: 600,
            color: sec === "cleared" || isExcl ? "#94a3b8" : "#111827",
            textDecoration: sec === "cleared" || isExcl ? "line-through" : "none",
            whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis"
          }}>{p.name}</div>

          <div style={{ display: "flex", gap: 4, marginTop: 2, flexWrap: "wrap", alignItems: "center" }}>
            <span style={{ fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, background: cat.bg, color: cat.tx }}>{p.category}</span>
            {isRem && <span style={{ fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, background: "rgba(139,92,246,.1)", color: "#7c3aed" }}>🔔 Reminder</span>}
            {(p.id.startsWith("r-") || p.id.startsWith("p-")) && !isRem && <span style={{ fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, background: "rgba(99,102,241,.08)", color: "#6366f1" }}>🔁 Recurring</span>}
            {p.autoPay && <span style={{ fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, background: "rgba(59,130,246,.1)", color: "#60A5FA" }}>Auto-Pay</span>}
            {p.checkNum && <span style={{ fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, background: "rgba(16,185,129,.1)", color: "#059669", fontFamily: "'JetBrains Mono',monospace" }}>Chk #{p.checkNum}</span>}
            {isPast && !isExcl && !isRem && <span style={{ fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, background: "rgba(239,68,68,.1)", color: "#dc2626" }}>{fmtS(p.dueDate)} · {overdueTxt(p.dueDate)}</span>}
            {isPast && !isExcl && isRem && <span style={{ fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, background: "rgba(139,92,246,.1)", color: "#7c3aed" }}>{fmtS(p.dueDate)} · {overdueTxt(p.dueDate)}</span>}
            {!isPast && sec === "action" && p.dueDate !== td && <span style={{ fontSize: 12, fontWeight: 500, padding: "3px 10px", borderRadius: 4, background: effDue(p.dueDate) === td && p.dueDate !== td ? "rgba(59,130,246,.1)" : "rgba(148,163,184,.08)", color: effDue(p.dueDate) === td && p.dueDate !== td ? "#2563eb" : "#64748b" }}>{effDue(p.dueDate) === td ? "due " + fmtS(p.dueDate) + " (wknd → Fri)" : "due " + fmtS(p.dueDate)}</span>}
            {sec === "pending" && <span style={{ fontSize: 11, color: "#94a3b8" }}>due {fmtS(p.dueDate)}</span>}
            {sec === "skipped" && <span style={{ fontSize: 12, fontWeight: 500, padding: "3px 10px", borderRadius: 4, background: "rgba(148,163,184,.08)", color: "#64748b" }}>due {fmtS(p.dueDate)}</span>}
            {p.excluded && sec === "action" && <span style={{ fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, background: "rgba(148,163,184,.1)", color: "#94A3B8" }}>Skipped</span>}
            {p.excluded && skipUntil[p.id] && (sec === "action" || sec === "skipped") && <span style={{ fontSize: 12, fontWeight: 500, padding: "3px 10px", borderRadius: 4, background: "rgba(245,158,11,.08)", color: "#d97706" }}>{"⏰"} Resumes {fmtS(skipUntil[p.id])}</span>}
          </div>

          {/* CC info */}
          {isCC && !isRem && (
            <div style={{ display: "flex", gap: 6, alignItems: "center", flexWrap: "wrap", marginTop: 3 }}>
              {p.closeDate && <span style={{ fontSize: 11, color: "#94a3b8" }}>Closes {fmtS(p.closeDate)}</span>}
              {p.minPay > 0 && (
                <button onClick={function(e) { e.stopPropagation(); toggleMin(p.id); }} style={{
                  fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 4, cursor: "pointer", border: "none",
                  background: p.useMin ? "rgba(245,158,11,.15)" : "rgba(148,163,184,.08)",
                  color: p.useMin ? "#F59E0B" : "#64748B"
                }}>
                  {p.useMin ? "Min " + fmt(p.minPay) + " ✓" : "Min " + fmt(p.minPay)}
                </button>
              )}
              <span style={{ fontSize: 9, fontWeight: 600, color: p.useMin ? "#64748B" : "#93C5FD", padding: "1px 6px", borderRadius: 4, background: p.useMin ? "transparent" : "rgba(59,130,246,.08)" }}>
                Stmt: {fmt(p.amount)}
              </span>
            </div>
          )}

          {/* Reminder card selector */}
          {isRem && sec !== "cleared" && (
            <div style={{ display: "flex", gap: 6, alignItems: "center", flexWrap: "wrap", marginTop: 3 }}>
              <span style={{ fontSize: 11, color: "#8b5cf6", fontWeight: 600 }}>Pay with:</span>
              <select value={displayCard} onChange={function(e) { setPayCard(p.id, e.target.value); }} style={{
                fontSize: 11, padding: "2px 6px", borderRadius: 4, border: "1px solid #c4b5fd", background: "#faf5ff",
                color: "#5b21b6", fontWeight: 600, cursor: "pointer", outline: "none", maxWidth: 160
              }}>
                <option value="">Select card...</option>
                {ccCardNames.map(function(cn) { return <option key={cn} value={cn}>{cn}</option>; })}
              </select>
              {lastCardNote && <span style={{ fontSize: 10, color: "#a78bfa", fontStyle: "italic" }}>{lastCardNote}</span>}
              {p.closeDate && <span style={{ fontSize: 11, color: "#94a3b8" }}>Invoice {fmtS(p.closeDate)}</span>}
            </div>
          )}
          {isRem && sec === "cleared" && displayCard && (
            <div style={{ display: "flex", gap: 4, alignItems: "center", marginTop: 3 }}>
              <span style={{ fontSize: 11, color: "#a78bfa" }}>Paid with: {displayCard}</span>
            </div>
          )}

          {/* Note preview */}
          {effectiveNote && (
            <div style={{ marginTop: 3, fontSize: 11, color: "#6b7280", fontStyle: "italic", whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis", maxWidth: 350 }}>
              📝 {effectiveNote}{!p.note && tmplNote ? " ⟳" : ""}
            </div>
          )}
        </div>

        {/* Amount */}
        <div style={{ textAlign: "right", flexShrink: 0 }}>
          <div style={{
            fontSize: 18, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace",
            color: isRem ? (sec === "cleared" || isExcl ? "#c4b5fd" : "#7c3aed") : (sec === "cleared" || isExcl ? "#94a3b8" : "#111827"),
            textDecoration: sec === "cleared" || isExcl ? "line-through" : "none"
          }}>{fmt(p.amount)}</div>
          {isRem && <div style={{ fontSize: 10, color: "#a78bfa", fontWeight: 600 }}>reminder</div>}
          {isCC && !isRem && p.useMin && <div style={{ fontSize: 11, color: "#d97706" }}>min pmt</div>}
        </div>

        {/* Actions */}
        <div style={{ display: "flex", gap: 6, flexShrink: 0, alignItems: "center" }}>
          <button onClick={function() { setNoteId(p.id); setNoteIn(effectiveNote || ""); }} title={effectiveNote ? "Note: " + effectiveNote : "Add note"} style={smBtn(effectiveNote ? "#f3e8ff" : "#f1f5f9", effectiveNote ? "#7c3aed" : "#64748b")}>📝</button>
          {attachments[p.id] && attachments[p.id].length > 0 && <button onClick={function() { openAttachViewer(attachments[p.id][0], attachments[p.id], 0); }} title={attachments[p.id].length + " attachment(s)"} style={smBtn("#dbeafe", "#2563eb")}>{attachments[p.id].length > 1 ? "📎" + attachments[p.id].length : "📎"}</button>}
          {sec === "action" && !p.excluded && (
            <button onClick={function() { setSkipPickId(p.id); setSkipPickDate(""); }} title="Skip" style={smBtn("#f1f5f9", "#64748b")}>⏭️</button>
          )}
          {(sec === "action" || sec === "skipped") && p.excluded && (
            <button onClick={function() { unskipPay(p.id); }} title="Unskip" style={smBtn("#dbeafe", "#2563eb")}>↩️</button>
          )}
          {(sec === "action" || sec === "skipped") && p.excluded && (
            <button onClick={function() { setSkipPickId(p.id); setSkipPickDate(skipUntil[p.id] || ""); }} title="Change resume date" style={smBtn("#fef3c7", "#d97706")}>⏰</button>
          )}
          {p.isPayroll && !p.checkNum && sec !== "cleared" && (
            <button onClick={function() { setCheckId(p.id); setChkIn(""); }} title="Check #" style={smBtn("#d1fae5", "#059669")}>#️⃣</button>
          )}
          <button onClick={function() { openEdit(p); }} title="Edit" style={smBtn("#dbeafe", "#2563eb")}>✏️</button>
          {sec === "pending" && <button onClick={function() { markUnpaid(p.id); }} title="Undo to Unpaid" style={smBtn("#fef3c7", "#d97706")}>↩️</button>}
          {sec === "cleared" && <button onClick={function() { isRem ? markUnpaid(p.id) : markPaid(p.id); }} title={isRem ? "Undo to Action" : "Undo to Pending"} style={smBtn("#fef3c7", "#d97706")}>↩️</button>}
          {sec !== "cleared" && <button onClick={function() { if (confirm("Delete " + p.name + "?")) delPay(p.id); }} title="Delete" style={smBtn("#fee2e2", "#dc2626")}>🗑️</button>}
        </div>
      </div>
    );
  }

  /* ── CC fields for forms ── */
  function CCFields({ f, setF }) {
    if (f.category !== "Credit Card") return null;
    return (
      <div style={{ padding: "9px 11px", background: "#FFFBEB", borderRadius: 8, border: "1px solid #FDE68A", background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.1)", overflow: "hidden" }}>
        <div style={{ fontSize: 10, fontWeight: 700, color: "#92400E" }}>💳 Credit Card Details</div>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
          <div>
            <Label text="Min Payment ($)" />
            <input style={Object.assign({}, inputS, { fontFamily: "'JetBrains Mono',monospace", borderColor: "#FDE68A" })} type="number" step=".01" value={f.minPay} onChange={function(e) { setF(Object.assign({}, f, { minPay: e.target.value })); }} placeholder="e.g. 85" />
          </div>
          <div>
            <Label text="Statement Close Day" />
            <input style={Object.assign({}, inputS, { fontFamily: "'JetBrains Mono',monospace", borderColor: "#FDE68A" })} type="number" min="1" max="31" value={f.closeDay} onChange={function(e) { setF(Object.assign({}, f, { closeDay: e.target.value })); }} placeholder="e.g. 8" />
          </div>
        </div>
      </div>
    );
  }

  if (!ready) {
    return (
      <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: "#0F172A", color: "#64748B", fontFamily: "'DM Sans',sans-serif" }}>
        <div style={{ textAlign: "center" }}>
          <div style={{ fontSize: 28 }}>◈</div>
          <div style={{ marginTop: 8 }}>Loading…</div>
        </div>
      </div>
    );
  }

  return (
    <div style={{ minHeight: "100vh", padding: 24, maxWidth: 1400, margin: "0 auto" }}>
      <style>{`
        *{box-sizing:border-box;margin:0;padding:0}
        input,select,button,textarea{font-family:inherit}
      `}</style>

      {/* Header */}
      <header style={{ background: "linear-gradient(135deg, #0f172a 0%, #1e293b 100%)", color: "white", padding: "20px 28px", borderRadius: 12, marginBottom: 24, display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: 16 }}>
        <div>
          <h1 style={{ margin: 0, fontSize: 22, fontWeight: 700, display: "flex", alignItems: "center", gap: 10 }}>
            <span style={{ width: 36, height: 36, borderRadius: 9, background: "linear-gradient(135deg,#3B82F6,#8B5CF6)", display: "inline-flex", alignItems: "center", justifyContent: "center", fontSize: 16, fontWeight: 700 }}>$</span>
            OpsPay
          </h1>
          <p style={{ margin: "4px 0 0", opacity: 0.8, fontSize: 13 }}>Payment Operations Dashboard</p>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 10, flexWrap: "wrap" }}>
          <span style={{ fontSize: 14, opacity: 0.9 }}>Welcome, {userName}</span>
          <button onClick={function() { setShowEmp(true); }} style={{ padding: "8px 14px", background: "rgba(255,255,255,0.1)", color: "white", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 8, cursor: "pointer", fontSize: 13 }}>👥 Employees</button>
          <button onClick={function() { setShowRec(true); }} style={{ padding: "8px 14px", background: "rgba(255,255,255,0.1)", color: "white", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 8, cursor: "pointer", fontSize: 13 }}>⟳ Recurring</button>
          <button onClick={function() { setShowFc(!showFc); }} style={{ padding: "8px 14px", background: showFc ? "rgba(139,92,246,0.3)" : "rgba(255,255,255,0.1)", color: "white", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 8, cursor: "pointer", fontSize: 13, fontWeight: showFc ? 600 : 400 }}>📊 Forecast</button>
          <button onClick={function() { setShowShare(true); }} style={{ padding: "8px 14px", background: "rgba(255,255,255,0.1)", color: "white", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 8, cursor: "pointer", fontSize: 13 }}>📋 Share Summary</button>
          <button onClick={function() { setForm({ name: "", category: "Invoice", amount: "", dueDate: getToday(), autoPay: false, checkNum: "", note: "", minPay: "", closeDay: "", isRecurring: false, dayOfMonth: "1", sameAmount: true, isReminder: false, payCard: "", startDate: getToday(), endDate: "" }); setShowAdd(true); }} style={{ padding: "8px 16px", background: "#3b82f6", color: "white", border: "none", borderRadius: 8, cursor: "pointer", fontSize: 14, fontWeight: 600 }}>+ Payment</button>
          <button onClick={async function() { setSaveStatus("saving"); try { var cfg = await spLoadConfig(); if (cfg.officeClosed) { setOfficeClosed(cfg.officeClosed); updateClosedDays(cfg.officeClosed, new Date().getFullYear()); } if (cfg.tmpls) setTmpls(cfg.tmpls); if (cfg.zmanLoc) setZmanLoc(cfg.zmanLoc); var m = await spLoadAllPay(); setPayments(m); hydrateAttachmentsFromPayments(m); setTd(getToday()); setSaveStatus("saved"); } catch(e) { console.error("Refresh:", e); setSaveStatus("error"); } }} style={{ padding: "8px 14px", background: "rgba(255,255,255,0.1)", color: "white", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 8, cursor: "pointer", fontSize: 13 }}>🔄 Refresh</button>
          <button onClick={function() { if(confirm("Sign out of OpsPay?")) { var a = msalInstance.getAllAccounts(); if(a.length) { msalInstance.logoutPopup({ account: a[0] }).then(function(){ localStorage.clear(); sessionStorage.clear(); location.reload(); }).catch(function(){ localStorage.clear(); sessionStorage.clear(); location.reload(); }); } else { localStorage.clear(); sessionStorage.clear(); location.reload(); } }}} style={{ padding: "8px 14px", background: "rgba(255,255,255,0.1)", color: "white", border: "1px solid rgba(255,255,255,0.2)", borderRadius: 8, cursor: "pointer", fontSize: 13 }}>Sign Out</button>
        </div>
      </header>

      <div>

        {/* CC Statement Alerts */}
        {ccAlerts.map(function(a) {
          return (
            <div key={a.idx} style={{ background: "#fffbeb", border: "1px solid #fde68a", borderRadius: 10, padding: "10px 16px", marginBottom: 10, display: "flex", alignItems: "center", gap: 10, flexWrap: "wrap" }}>
              <span style={{ fontSize: 20 }}>💳</span>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: "#92400e" }}>{a.name} — Statement Ready</div>
                <div style={{ fontSize: 11, color: "#a16207" }}>Statement closed {fmtS(a.closeDate)}. Please enter new balance & min payment.</div>
              </div>
              {ccUpdateIdx === a.idx ? (
                <div style={{ display: "flex", gap: 6, alignItems: "center", flexWrap: "wrap" }}>
                  <input value={ccNewAmt} onChange={function(e){setCcNewAmt(e.target.value);}} placeholder="New balance" type="number" step=".01" style={{ width: 110, padding: "6px 8px", borderRadius: 6, border: "1.5px solid #fde68a", fontSize: 12, fontFamily: "'JetBrains Mono',monospace", outline: "none" }} />
                  <input value={ccNewMin} onChange={function(e){setCcNewMin(e.target.value);}} placeholder="Min due" type="number" step=".01" style={{ width: 90, padding: "6px 8px", borderRadius: 6, border: "1.5px solid #fde68a", fontSize: 12, fontFamily: "'JetBrains Mono',monospace", outline: "none" }} />
                  <button onClick={function(){updateCcStatement(a.idx);}} style={{ background: "#f59e0b", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", fontSize: 12, fontWeight: 600, cursor: "pointer" }}>Update</button>
                  <button onClick={function(){setCcUpdateIdx(null);}} style={{ background: "white", border: "1px solid #d1d5db", borderRadius: 6, padding: "6px 8px", fontSize: 11, cursor: "pointer", color: "#6b7280" }}>✕</button>
                </div>
              ) : (
                <div style={{ display: "flex", gap: 6 }}>
                  <button onClick={function(){setCcUpdateIdx(a.idx);setCcNewAmt("");setCcNewMin("");}} style={{ background: "#f59e0b", color: "white", border: "none", borderRadius: 6, padding: "8px 14px", fontSize: 12, fontWeight: 600, cursor: "pointer" }}>Update Statement</button>
                  <button onClick={function(){dismissCcAlert(a.idx);}} style={{ background: "white", border: "1px solid #d1d5db", borderRadius: 6, padding: "8px 10px", fontSize: 11, cursor: "pointer", color: "#6b7280" }}>Dismiss</button>
                </div>
              )}
            </div>
          );
        })}

        {/* Reminder Invoice/Statement Alerts */}
        {reminderAlerts.map(function(a) {
          return (
            <div key={"rem-"+a.idx} style={{ background: "#faf5ff", border: "1px solid #d8b4fe", borderRadius: 10, padding: "10px 16px", marginBottom: 10, display: "flex", alignItems: "center", gap: 10, flexWrap: "wrap" }}>
              <span style={{ fontSize: 20 }}>🔔</span>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: "#6b21a8" }}>{a.name} — Invoice/Statement Ready</div>
                <div style={{ fontSize: 11, color: "#7e22ce" }}>Invoice date passed ({fmtS(a.invDate)}). Enter the due amount.</div>
              </div>
              {remUpdateIdx === a.idx ? (
                <div style={{ display: "flex", gap: 6, alignItems: "center", flexWrap: "wrap" }}>
                  <input value={remNewAmt} onChange={function(e){setRemNewAmt(e.target.value);}} placeholder="Amount due" type="number" step=".01" style={{ width: 120, padding: "6px 8px", borderRadius: 6, border: "1.5px solid #d8b4fe", fontSize: 12, fontFamily: "'JetBrains Mono',monospace", outline: "none" }} autoFocus />
                  <button onClick={function(){updateReminderStatement(a.idx);}} style={{ background: "#8b5cf6", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", fontSize: 12, fontWeight: 600, cursor: "pointer" }}>Update</button>
                  <button onClick={function(){setRemUpdateIdx(null);}} style={{ background: "white", border: "1px solid #d1d5db", borderRadius: 6, padding: "6px 8px", fontSize: 11, cursor: "pointer", color: "#6b7280" }}>✕</button>
                </div>
              ) : (
                <div style={{ display: "flex", gap: 6 }}>
                  <button onClick={function(){setRemUpdateIdx(a.idx);setRemNewAmt("");}} style={{ background: "#8b5cf6", color: "white", border: "none", borderRadius: 6, padding: "8px 14px", fontSize: 12, fontWeight: 600, cursor: "pointer" }}>Enter Amount</button>
                  <button onClick={function(){dismissReminderAlert(a.idx);}} style={{ background: "white", border: "1px solid #d1d5db", borderRadius: 6, padding: "8px 10px", fontSize: 11, cursor: "pointer", color: "#6b7280" }}>Dismiss</button>
                </div>
              )}
            </div>
          );
        })}

        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit,minmax(200px,1fr))", gap: 16, marginBottom: 24 }}>
          <div style={cardS}>
            <div style={lblS}>Account Balance</div>
            {editBal ? (
              <div style={{ display: "flex", gap: 4 }}>
                <input value={balIn} onChange={function(e) { setBalIn(e.target.value); }} onKeyDown={function(e) { if (e.key === "Enter") saveBal(); }} autoFocus style={{ background: "white", border: "2px solid #3b82f6", borderRadius: 8, padding: "4px 10px", color: "#0f172a", fontSize: 22, fontFamily: "'JetBrains Mono',monospace", fontWeight: 700, width: "100%", outline: "none" }} />
                <button onClick={saveBal} style={{ background: "#3b82f6", color: "#fff", border: "none", borderRadius: 8, padding: "6px 12px", cursor: "pointer", fontWeight: 600, fontSize: 13 }}>✓</button>
              </div>
            ) : (
              <div onClick={function() { setBalIn(String(bal)); setEditBal(true); }} style={Object.assign({}, numS, { cursor: "pointer" })}>{fmt(bal)}</div>
            )}
            <div style={{ fontSize: 11, color: "#94a3b8", marginTop: 2 }}>Click to update</div>
          </div>

          <div style={Object.assign({}, cardS, { borderLeft: "4px solid #f59e0b" })}>
            <div style={lblS}>Available (After Pending)</div>
            <div style={Object.assign({}, numS, { color: avail >= 0 ? "#F59E0B" : "#EF4444" })}>{fmt(avail)}</div>
            {pendTotal > 0 && <div style={{ fontSize: 11, color: "#64748b", marginTop: 2 }}>{fmt(pendTotal)} clearing</div>}
          </div>

          <div style={Object.assign({}, cardS, { borderLeft: "4px solid #ef4444" })}>
            <div style={lblS}>Funding Needed</div>
            <div style={Object.assign({}, numS, { color: actionTotal > 0 ? "#dc2626" : "#10B981" })}>{fmt(actionTotal)}</div>
            <div style={{ fontSize: 11, color: "#64748b", marginTop: 2 }}>{fActionItems.filter(function(p) { return !p.excluded && !p.isReminder; }).length} items{exclCount > 0 ? " · " + exclCount + " skipped" : ""}</div>
          </div>

          <div style={Object.assign({}, cardS, { borderLeft: isShort ? "4px solid #dc2626" : "4px solid #10b981" })}>
            <div style={lblS}>{isShort ? "⚠ Shortfall" : "✓ Covered"}</div>
            <div style={Object.assign({}, numS, { color: isShort ? "#dc2626" : "#059669" })}>{isShort ? "−" + fmt(gap) : fmt(avail - actionTotal)}</div>
            {isShort && <div style={{ fontSize: 13, color: "#991b1b", marginTop: 4, fontWeight: 600 }}>Need {fmt(gap)} more</div>}
          </div>
        </div>

        {/* Forecast */}
        {showFc && (
          <div style={{ background: "white", boxShadow: "0 1px 3px rgba(0,0,0,0.1)", borderRadius: 12, padding: 16, border: "1px solid #e2e8f0", marginBottom: 14 }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
              <div style={{ fontSize: 14, fontWeight: 700, color: "#A78BFA" }}>📊 Funding Forecast</div>
              <button onClick={function() { setShowFc(false); }} style={{ background: "#f1f5f9", border: "1px solid #e2e8f0", borderRadius: 6, padding: "4px 10px", cursor: "pointer", color: "#374151", fontSize: 11 }}>Close</button>
            </div>
            <div style={{ display: "flex", gap: 8, marginBottom: 14, flexWrap: "wrap", alignItems: "flex-end" }}>
              <div><Label text="From" /><input type="date" value={fcFrom} onChange={function(e) { setFcFrom(e.target.value); }} style={Object.assign({}, inputS, { background: "white", color: "#111827", border: "1px solid #d1d5db", width: 155 })} /></div>
              <div><Label text="To" /><input type="date" value={fcTo} onChange={function(e) { setFcTo(e.target.value); }} style={Object.assign({}, inputS, { background: "white", color: "#111827", border: "1px solid #d1d5db", width: 155 })} /></div>
              <div style={{ display: "flex", gap: 4 }}>
                {[7, 14, 30, 60, 90].map(function(d) {
                  return <button key={d} onClick={function() { setFcFrom(getToday()); var nd = new Date(); nd.setDate(nd.getDate() + d); setFcTo(toISO(nd)); }} style={{ background: "white", border: "1px solid #e2e8f0", borderRadius: 6, padding: "6px 10px", cursor: "pointer", color: "#374151", fontSize: 10, fontWeight: 600 }}>{d}d</button>;
                })}
              </div>
            </div>
            {fcData && !fcData.err && (
              <div>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit,minmax(140px,1fr))", gap: 8, marginBottom: 14 }}>
                  <div style={{ background: "#f8fafc", borderRadius: 8, padding: 10 }}>
                    <div style={{ fontSize: 11, color: "#94a3b8", fontWeight: 600, textTransform: "uppercase", marginBottom: 2 }}>Total Due</div>
                    <div style={{ fontSize: 18, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace", color: "#0f172a" }}>{fmt(fcData.total)}</div>
                    <div style={{ fontSize: 11, color: "#64748b", marginTop: 1 }}>{fcData.count} payments</div>
                  </div>
                  <div style={{ background: "#f8fafc", borderRadius: 8, padding: 10 }}>
                    <div style={{ fontSize: 11, color: "#94a3b8", fontWeight: 600, textTransform: "uppercase", marginBottom: 2 }}>Balance</div>
                    <div style={{ fontSize: 18, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace", color: "#93C5FD" }}>{fmt(bal)}</div>
                  </div>
                  <div style={{ background: fcData.gap > 0 ? "rgba(127,29,29,.2)" : "rgba(6,78,59,.2)", borderRadius: 8, padding: 10 }}>
                    <div style={{ fontSize: 11, color: "#94a3b8", fontWeight: 600, textTransform: "uppercase", marginBottom: 2 }}>{fcData.gap > 0 ? "Gap" : "Surplus"}</div>
                    <div style={{ fontSize: 18, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace", color: fcData.gap > 0 ? "#EF4444" : "#10B981" }}>{fcData.gap > 0 ? "−" + fmt(fcData.gap) : fmt(Math.abs(fcData.gap))}</div>
                  </div>
                </div>
                <div style={{ maxHeight: 180, overflowY: "auto", display: "flex", flexDirection: "column", gap: 3 }}>
                  {fcData.dates.map(function(date) {
                    var d = fcData.byDate[date];
                    return (
                      <div key={date} style={{ display: "flex", alignItems: "center", gap: 8, padding: "5px 9px", borderRadius: 6, background: "#f8fafc" }}>
                        <div style={{ width: 75, flexShrink: 0, fontSize: 11, fontWeight: 600, color: date === td ? "#93C5FD" : "#CBD5E1" }}>{date === td ? "Today" : fmtS(date)}</div>
                        <div style={{ flex: 1, fontSize: 10, color: "#64748B" }}>{d.items.length} items</div>
                        <div style={{ fontSize: 13, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace", color: "#0f172a" }}>{fmt(d.total)}</div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Summary */}
        {selDay && (
          <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8, padding: "6px 12px", background: "#eff6ff", borderRadius: 8, border: "1px solid #bfdbfe" }}>
            <span style={{ fontSize: 12, fontWeight: 600, color: "#1e40af" }}>📅 Funding needed through: {fmtS(selDay)} ({dayN(selDay)})</span>
            <div style={{ flex: 1 }} />
            <button onClick={function() { setSelDay(null); setShowCal(false); var n = new Date(); setCy(n.getFullYear()); setCm(n.getMonth()); }} style={{ background: "#dbeafe", border: "none", borderRadius: 4, padding: "3px 8px", cursor: "pointer", color: "#1e40af", fontSize: 11, fontWeight: 600 }}>✕ Clear filter</button>
          </div>
        )}
        
        {/* Date bar */}
        <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 10, flexWrap: "wrap" }}>
          <button onClick={function() { if (!showCal) { var n = new Date(); setCy(n.getFullYear()); setCm(n.getMonth()); } setShowCal(!showCal); }} style={{ background: showCal ? "#eff6ff" : "white", border: "1px solid #e2e8f0", borderRadius: 7, padding: "5px 7px", cursor: "pointer", display: "flex", alignItems: "center" }}>
            <CalIcon size={16} color={showCal ? "#60A5FA" : "#94A3B8"} />
          </button>
          <span style={{ fontSize: 16, fontWeight: 700, color: "#0f172a" }}>Today</span>
          <span style={{ fontSize: 12, color: "#64748B" }}>{fmtS(td)}</span>
          {(function() {
            var tp = td.split("-");
            var tY = +tp[0], tM = +tp[1]-1, tD = +tp[2];
            var th = gregToHebrew(tY, tM, tD);
            var hebDays = ["\u05D9\u05D5\u05DD \u05D0\u05F3","\u05D9\u05D5\u05DD \u05D1\u05F3","\u05D9\u05D5\u05DD \u05D2\u05F3","\u05D9\u05D5\u05DD \u05D3\u05F3","\u05D9\u05D5\u05DD \u05D4\u05F3","\u05E2\u05E8\u05D1 \u05E9\u05D1\u05EA","\u05E9\u05D1\u05EA"];
            var dow = new Date(tY, tM, tD).getDay();
            var isFri = dow === 5;
            var isSat = dow === 6;
            var parts = [];

            // Hebrew day name + date
            parts.push(<span key="heb" style={{ fontSize: 12, color: "#9ca3af", direction: "rtl" }}>{hebDays[dow] + " · " + toHebNum(th.day) + " " + hebrewMonthName(th.month) + " " + toHebYear(th.year)}</span>);

            // Candle lighting on Friday
            if (isFri) {
              var cl = getCandleLighting(tY, tM, tD, zmanLoc);
              if (cl) parts.push(<span key="candle" style={{ fontSize: 11, fontWeight: 600, color: "#d97706", background: "#fefce8", padding: "1px 8px", borderRadius: 4 }}>{"\uD83D\uDD6F\uFE0F " + cl}</span>);
            }

            // Erev Yom Tov candle lighting (not Friday)
            if (!isFri) {
              var tmrw = new Date(tY, tM, tD + 1);
              var tmrwKey = toISO(tmrw);
              var tmrwHol = jewishHols[tmrwKey];
              if (tmrwHol && OFFICE_CLOSED_HOLIDAYS.indexOf(tmrwHol) !== -1) {
                var cl2 = getCandleLighting(tY, tM, tD, zmanLoc);
                if (cl2) parts.push(<span key="candle2" style={{ fontSize: 11, fontWeight: 600, color: "#d97706", background: "#fefce8", padding: "1px 8px", borderRadius: 4 }}>{"\uD83D\uDD6F\uFE0F " + cl2 + " (ער\"ח " + tmrwHol + ")"}</span>);
              }
            }

            // Havdalah on Saturday
            if (isSat) {
              var hav = getHavdalahTime(tY, tM, tD, zmanLoc);
              if (hav) parts.push(<span key="hav" style={{ fontSize: 11, fontWeight: 600, color: "#6d28d9", background: "#f5f3ff", padding: "1px 8px", borderRadius: 4 }}>{"\u2728 " + hav}</span>);
            }

            // Parsha on Friday (this Shabbos) or Saturday
            var parsha = "";
            if (isFri) parsha = getParshaForShabbat(tY, tM, tD + 1);
            if (isSat) parsha = getParshaForShabbat(tY, tM, tD);
            if (parsha) parts.push(<span key="parsha" style={{ fontSize: 11, fontWeight: 600, color: "#7c3aed", background: "rgba(139,92,246,.08)", padding: "1px 8px", borderRadius: 4, direction: "rtl" }}>{"\uD83D\uDCDC " + parsha}</span>);

            // Special Shabbos — on Friday (for this coming Shabbos) or Saturday
            var specShab = [];
            if (isFri) specShab = getSpecialShabbos(tY, tM, tD + 1);
            if (isSat) specShab = getSpecialShabbos(tY, tM, tD);
            if (specShab.length > 0) {
              specShab.forEach(function(ss, si) {
                parts.push(<span key={"spec"+si} style={{ fontSize: 11, fontWeight: 600, color: "#be185d", background: "#fce7f3", padding: "1px 8px", borderRadius: 4, direction: "rtl" }}>{ss}</span>);
              });
            }

            return parts;
          })()}
          {jewishHols[td] && <span style={{ fontSize: 11, fontWeight: 600, color: "#92400e", background: "#fefce8", padding: "1px 8px", borderRadius: 4, direction: "rtl" }}>{jewishHols[td]}</span>}
          {_bankClosed[td] && <span style={{ fontSize: 11, fontWeight: 600, color: "#1e40af", background: "#eff6ff", padding: "1px 8px", borderRadius: 4 }}>{String.fromCodePoint(0x1F3E6)} {_bankClosed[td]}</span>}
          <div style={{ flex: 1 }} />
          {/* Search bar */}
          <div style={{ position: "relative", width: 240 }}>
            <input value={searchQ} onChange={function(e) { setSearchQ(e.target.value); }} placeholder="Search name, check #, amount, notes..." style={{
              width: "100%", padding: "7px 12px 7px 32px", borderRadius: 8, border: searchQ ? "2px solid #3b82f6" : "1px solid #e2e8f0",
              fontSize: 12, outline: "none", color: "#111827", background: searchQ ? "#eff6ff" : "white", fontFamily: "inherit"
            }} />
            <span style={{ position: "absolute", left: 10, top: "50%", transform: "translateY(-50%)", fontSize: 14, color: "#94a3b8", pointerEvents: "none" }}>🔍</span>
            {searchQ && <button onClick={function() { setSearchQ(""); }} style={{ position: "absolute", right: 6, top: "50%", transform: "translateY(-50%)", background: "none", border: "none", cursor: "pointer", color: "#94a3b8", fontSize: 12, padding: 2 }}>✕</button>}
          </div>
        </div>

        {/* Search active indicator */}
        {searchQ && (
          <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8, padding: "5px 12px", background: "#eff6ff", borderRadius: 8, border: "1px solid #bfdbfe" }}>
            <span style={{ fontSize: 12, fontWeight: 600, color: "#1e40af" }}>🔍 Showing results for: "{searchQ}"</span>
            <span style={{ fontSize: 11, color: "#64748b" }}>({actionItems.length + pendItems.length + clrItems.length + futureItems.length} matches)</span>
            <div style={{ flex: 1 }} />
            <button onClick={function() { setSearchQ(""); }} style={{ background: "#dbeafe", border: "none", borderRadius: 4, padding: "3px 8px", cursor: "pointer", color: "#1e40af", fontSize: 11, fontWeight: 600 }}>✕ Clear search</button>
          </div>
        )}

        {/* Calendar */}
        {showCal && (
          <div style={{ background: "white", boxShadow: "0 1px 3px rgba(0,0,0,0.1)", borderRadius: 11, padding: 12, border: "1px solid #e5e7eb", marginBottom: 14 }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 0 }}>
                <button onClick={function() { navMo(-1); setShowMonthPicker(false); }} style={{ background: "white", border: "1px solid #e2e8f0", borderRadius: 6, padding: "4px 10px", color: "#374151", fontSize: 16, cursor: "pointer", fontWeight: 700 }}>‹</button>
                <button onClick={function() { setShowMonthPicker(!showMonthPicker); }} style={{ background: showMonthPicker ? "#eff6ff" : "white", border: "1px solid #e2e8f0", borderRadius: 8, padding: "4px 14px", cursor: "pointer", marginLeft: 6, marginRight: 6 }}>
                  <span style={{ fontSize: 16, fontWeight: 700, color: "#0f172a" }}>{MONTHS[cm]} {cy}</span>
                  <span style={{ fontSize: 12, color: "#9ca3af", fontWeight: 500, marginLeft: 8 }}>{(function() { var h1 = gregToHebrew(cy, cm, 1); var h2 = gregToHebrew(cy, cm, daysIn(cy, cm)); return h1.month === h2.month ? hebrewMonthName(h1.month) + " " + toHebYear(h1.year) : hebrewMonthName(h1.month) + " / " + hebrewMonthName(h2.month) + " " + toHebYear(h2.year); })()}</span>
                </button>
                <button onClick={function() { navMo(1); setShowMonthPicker(false); }} style={{ background: "white", border: "1px solid #e2e8f0", borderRadius: 6, padding: "4px 10px", color: "#374151", fontSize: 16, cursor: "pointer", fontWeight: 700 }}>›</button>
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 4 }}>
                <button onClick={function() { var t = new Date(); setCy(t.getFullYear()); setCm(t.getMonth()); setShowMonthPicker(false); }} style={{ background: "rgba(59,130,246,.1)", border: "none", borderRadius: 4, padding: "3px 8px", color: "#2563eb", fontSize: 11, fontWeight: 600, cursor: "pointer" }}>Today</button>
                <button onClick={function() { setShowZmanPicker(!showZmanPicker); }} title={"Zmanim: " + zmanLoc.name} style={{ background: showZmanPicker ? "#eff6ff" : "#f8fafc", border: "1px solid #e2e8f0", borderRadius: 6, padding: "3px 7px", cursor: "pointer", fontSize: 10, color: "#64748b" }}>{String.fromCodePoint(0x1F4CD)} {zmanLoc.name}</button>
                <button onClick={function() { setShowCal(false); setSelDay(null); setShowMonthPicker(false); var n = new Date(); setCy(n.getFullYear()); setCm(n.getMonth()); }} style={{ background: "#f1f5f9", border: "1px solid #e2e8f0", borderRadius: 6, padding: "4px 8px", cursor: "pointer", color: "#64748b", fontSize: 12, fontWeight: 600 }}>✕</button>
              </div>
            </div>
            {showMonthPicker && (
              <div style={{ background: "#f8fafc", border: "1px solid #e2e8f0", borderRadius: 10, padding: 12, marginBottom: 8 }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8, marginBottom: 10 }}>
                  <button onClick={function() { setCy(cy - 1); }} style={{ background: "white", border: "1px solid #e2e8f0", borderRadius: 6, padding: "2px 10px", cursor: "pointer", fontSize: 14, fontWeight: 700, color: "#374151" }}>‹</button>
                  <span style={{ fontSize: 15, fontWeight: 700, color: "#0f172a", minWidth: 50, textAlign: "center" }}>{cy}</span>
                  <button onClick={function() { setCy(cy + 1); }} style={{ background: "white", border: "1px solid #e2e8f0", borderRadius: 6, padding: "2px 10px", cursor: "pointer", fontSize: 14, fontWeight: 700, color: "#374151" }}>›</button>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 4 }}>
                  {MONTHS.map(function(m, i) {
                    var isCur = i === cm;
                    var isNow = i === new Date().getMonth() && cy === new Date().getFullYear();
                    return React.createElement("button", {
                      key: i,
                      onClick: function() { setCm(i); setShowMonthPicker(false); setSelDay(null); },
                      style: { padding: "8px 4px", fontSize: 12, fontWeight: isCur ? 700 : 500, background: isCur ? "#3b82f6" : isNow ? "#eff6ff" : "white", color: isCur ? "white" : "#374151", border: "1px solid " + (isCur ? "#3b82f6" : isNow ? "#93c5fd" : "#e2e8f0"), borderRadius: 6, cursor: "pointer" }
                    }, m);
                  })}
                </div>
              </div>
            )}
            {showZmanPicker && (
              <div style={{ background: "#f8fafc", border: "1px solid #e2e8f0", borderRadius: 8, padding: 10, marginBottom: 8, display: "flex", flexWrap: "wrap", gap: 4, alignItems: "center" }}>
                <span style={{ fontSize: 10, color: "#64748b", fontWeight: 600, marginRight: 4 }}>{String.fromCodePoint(0x1F56F)} Candle Lighting Location:</span>
                {ZMAN_CITIES.map(function(city) {
                  var isSel = zmanLoc.name === city.name;
                  return React.createElement("button", {
                    key: city.name,
                    onClick: function() { setZmanLoc(city); setShowZmanPicker(false); },
                    style: { padding: "3px 8px", fontSize: 10, fontWeight: isSel ? 700 : 500, background: isSel ? "#3b82f6" : "white", color: isSel ? "white" : "#374151", border: "1px solid " + (isSel ? "#3b82f6" : "#e2e8f0"), borderRadius: 4, cursor: "pointer" }
                  }, city.name);
                })}
              </div>
            )}
            <div style={{ display: "grid", gridTemplateColumns: "repeat(7,1fr)", gap: 2, marginBottom: 2 }}>
              {["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"].map(function(d) { return <div key={d} style={{ textAlign: "center", fontSize: 11, fontWeight: 600, color: "#6b7280", padding: "4px 0" }}>{d}</div>; })}
            </div>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(7,1fr)", gap: 2 }}>
              {calDays.map(function(c, i) {
                if (!c) return <div key={"e" + i} />;
                var isT = c.ds === td;
                var isSel = c.ds === selDay;
                var cellBg = isSel ? "#eff6ff" : c.bankHol ? "#eff6ff" : c.isClosed ? "#fef2f2" : c.isWknd ? "#f1f5f9" : c.holiday ? "#fefce8" : c.due > 0 ? "white" : "#f8fafc";
                return (
                  <button key={c.ds} onClick={function() { setSelDay(isSel ? null : c.ds); }} style={{
                    background: cellBg,
                    border: isSel ? "2px solid #2563eb" : isT ? "2px solid #3b82f6" : c.bankHol ? "1px solid #93c5fd" : c.isClosed ? "1px solid #fca5a5" : c.holiday ? "1px solid #fde68a" : "1px solid #e5e7eb",
                    borderRadius: 6, padding: "3px 2px", cursor: "pointer", textAlign: "center", minHeight: 70,
                    display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "flex-start", gap: 0, position: "relative"
                  }}>
                    <div style={{ fontSize: 13, fontWeight: isT || isSel ? 700 : 500, color: isSel ? "#2563eb" : isT ? "#60A5FA" : c.isClosed ? "#dc2626" : "#334155" }}>{c.day}</div>
                    <div style={{ fontSize: 9, color: "#9ca3af", lineHeight: 1.2, direction: "rtl" }}>{toHebNum(c.hebDay) + " " + c.hebMonth}</div>
                    {c.holiday && <div style={{ fontSize: 8, color: "#92400e", fontWeight: 600, lineHeight: 1.2, marginTop: 1, maxWidth: "100%", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap", padding: "0 2px", direction: "rtl" }}>{c.holiday}</div>}
                    {c.bankHol && <div style={{ fontSize: 7, color: "#1e40af", fontWeight: 600, lineHeight: 1.1, marginTop: 1 }}>{"\uD83C\uDFE6"} {c.bankHol}</div>}
                    {c.isClosed && !c.isWknd && !c.bankHol && <div style={{ fontSize: 8, color: "#dc2626", fontWeight: 700, lineHeight: 1.2, marginTop: 1 }}>CLOSED</div>}
                    {c.parsha && <div style={{ fontSize: 8, color: "#7c3aed", fontWeight: 600, lineHeight: 1.2, marginTop: 1, direction: "rtl" }}>{c.parsha}</div>}
                    {c.specialShab && c.specialShab.length > 0 && <div style={{ fontSize: 7, color: "#be185d", fontWeight: 600, lineHeight: 1.1, marginTop: 1, direction: "rtl" }}>{c.specialShab.join(" · ")}</div>}
                    {c.candle && <div style={{ fontSize: 8, color: "#d97706", lineHeight: 1.2, marginTop: 1 }}>{String.fromCodePoint(0x1F56F)}{c.candle}</div>}
                    {c.havdalah && <div style={{ fontSize: 8, color: "#6b21a8", lineHeight: 1.2, marginTop: 1 }}>{String.fromCodePoint(0x2728)}{c.havdalah}</div>}
                    {c.fastInfo && <div style={{ fontSize: 8, color: "#dc2626", lineHeight: 1.2 }}>{String.fromCodePoint(0x23F0)}{c.fastInfo.end}</div>}
                    {c.due > 0 && <div style={{ fontSize: 10, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace", color: c.due > avail ? "#dc2626" : "#64748b", marginTop: 1 }}>{c.due >= 1000 ? "$" + (c.due / 1000).toFixed(1) + "k" : fmt(c.due)}</div>}
                    {c.hp && <div style={{ width: 3, height: 3, borderRadius: "50%", background: "#3B82F6" }} />}
                  </button>
                );
              })}
            </div>

            {/* Selected day detail */}
            {selDay && (
              <div style={{ marginTop: 10, borderTop: "1px solid #e5e7eb", paddingTop: 10 }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                    <span style={{ fontSize: 13, fontWeight: 700, color: "#1e40af" }}>{fmtS(selDay)}</span>
                    <span style={{ fontSize: 12, color: "#64748b" }}>{dayN(selDay)}</span>
                    {(function() { var h = gregToHebrew(parseInt(selDay.slice(0,4)), parseInt(selDay.slice(5,7))-1, parseInt(selDay.slice(8,10))); return <span style={{ fontSize: 11, color: "#9ca3af", direction: "rtl" }}>{toHebNum(h.day) + " " + hebrewMonthName(h.month) + " " + toHebYear(h.year)}</span>; })()}
                    {jewishHols[selDay] && <span style={{ fontSize: 11, fontWeight: 600, color: "#92400e", background: "#fefce8", padding: "1px 6px", borderRadius: 4, direction: "rtl" }}>{jewishHols[selDay]}</span>}
                    {(function() {
                      var sd = parseD(selDay);
                      var items = [];
                      if (sd.getDay() === 5) {
                        var p = getParshaForShabbat(sd.getFullYear(), sd.getMonth(), sd.getDate() + 1);
                        var cl = getCandleLighting(sd.getFullYear(), sd.getMonth(), sd.getDate(), zmanLoc);
                        if (p) items.push(React.createElement("span", { key: "p", style: { fontSize: 11, fontWeight: 600, color: "#7c3aed", background: "#f3e8ff", padding: "1px 6px", borderRadius: 4, direction: "rtl" } }, String.fromCodePoint(0x1F4DC) + " " + p));
                        if (cl) items.push(React.createElement("span", { key: "cl", style: { fontSize: 11, color: "#d97706", background: "#fefce8", padding: "1px 6px", borderRadius: 4 } }, String.fromCodePoint(0x1F56F) + " " + cl));
                        // Special shabbos for this coming Shabbos
                        var specFri = getSpecialShabbos(sd.getFullYear(), sd.getMonth(), sd.getDate() + 1);
                        specFri.forEach(function(ss, si) { items.push(React.createElement("span", { key: "specf"+si, style: { fontSize: 11, fontWeight: 600, color: "#be185d", background: "#fce7f3", padding: "1px 6px", borderRadius: 4, direction: "rtl" } }, ss)); });
                      }
                      // Parsha + special shabbos on Saturday
                      if (sd.getDay() === 6) {
                        var pSat = getParshaForShabbat(sd.getFullYear(), sd.getMonth(), sd.getDate());
                        if (pSat) items.push(React.createElement("span", { key: "pSat", style: { fontSize: 11, fontWeight: 600, color: "#7c3aed", background: "#f3e8ff", padding: "1px 6px", borderRadius: 4, direction: "rtl" } }, String.fromCodePoint(0x1F4DC) + " " + pSat));
                        var specSat = getSpecialShabbos(sd.getFullYear(), sd.getMonth(), sd.getDate());
                        specSat.forEach(function(ss, si) { items.push(React.createElement("span", { key: "specs"+si, style: { fontSize: 11, fontWeight: 600, color: "#be185d", background: "#fce7f3", padding: "1px 6px", borderRadius: 4, direction: "rtl" } }, ss)); });
                      }
                      // Yom Tov eve candle lighting
                      var tmrw = new Date(sd.getTime() + 86400000);
                      var tmrwKey = toISO(tmrw);
                      if (sd.getDay() !== 5 && jewishHols[tmrwKey] && OFFICE_CLOSED_HOLIDAYS.indexOf(jewishHols[tmrwKey]) !== -1) {
                        var cl2 = getCandleLighting(sd.getFullYear(), sd.getMonth(), sd.getDate(), zmanLoc);
                        if (cl2) items.push(React.createElement("span", { key: "cl2", style: { fontSize: 11, color: "#d97706", background: "#fefce8", padding: "1px 6px", borderRadius: 4 } }, String.fromCodePoint(0x1F56F) + " " + cl2));
                      }
                      // Havdalah on Shabbos
                      if (sd.getDay() === 6) {
                        var hav = getHavdalahTime(sd.getFullYear(), sd.getMonth(), sd.getDate(), zmanLoc);
                        if (hav) items.push(React.createElement("span", { key: "hav", style: { fontSize: 11, color: "#6b21a8", background: "#f3e8ff", padding: "1px 6px", borderRadius: 4 } }, String.fromCodePoint(0x2728) + " " + hav));
                      }
                      // Havdalah on Yom Tov (last day)
                      if (sd.getDay() !== 6) {
                        var selHol = jewishHols[selDay];
                        if (selHol && OFFICE_CLOSED_HOLIDAYS.indexOf(selHol) !== -1) {
                          var tmrw3 = new Date(sd.getTime() + 86400000);
                          var tmrwK3 = toISO(tmrw3);
                          var tmrwH3 = jewishHols[tmrwK3];
                          if (tmrw3.getDay() !== 6 && !(tmrwH3 && OFFICE_CLOSED_HOLIDAYS.indexOf(tmrwH3) !== -1)) {
                            var hav2 = getHavdalahTime(sd.getFullYear(), sd.getMonth(), sd.getDate(), zmanLoc);
                            if (hav2) items.push(React.createElement("span", { key: "hav2", style: { fontSize: 11, color: "#6b21a8", background: "#f3e8ff", padding: "1px 6px", borderRadius: 4 } }, String.fromCodePoint(0x2728) + " " + hav2));
                          }
                        }
                      }
                      var fi = getFastTimes(sd.getFullYear(), sd.getMonth(), sd.getDate());
                      if (fi) items.push(React.createElement("span", { key: "fi", style: { fontSize: 11, color: "#dc2626", background: "#fee2e2", padding: "1px 6px", borderRadius: 4 } }, String.fromCodePoint(0x23F0) + " Fast ends " + fi.end));
                      if (items.length === 0) return null;
                      return React.createElement("span", { style: { display: "flex", gap: 6, alignItems: "center" } }, items);
                    })()}
                  </div>
                  <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                    <span style={{ fontSize: 13, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace", color: "#0f172a" }}>{fmt(dayItems.reduce(function(s,p){return s+effAmt(p);},0))}</span>
                    <span style={{ fontSize: 11, color: "#94a3b8" }}>{dayItems.length} items</span>
                    <button onClick={function() { toggleSelAll(dayItems); }} style={{ background: "none", border: "none", color: "#93c5fd", fontSize: 11, cursor: "pointer", fontWeight: 600 }}>{allSelected(dayItems) ? "Deselect all" : "Select all"}</button>
                    {_bankClosed[selDay] && <span style={{ fontSize: 11, fontWeight: 600, color: "#b91c1c", background: "#fee2e2", padding: "1px 6px", borderRadius: 4 }}>{String.fromCodePoint(0x1F3E6)} {_bankClosed[selDay]}</span>}
                    {(function() {
                      var wd = new Date(parseInt(selDay.slice(0,4)), parseInt(selDay.slice(5,7))-1, parseInt(selDay.slice(8,10))).getDay();
                      if (wd === 0 || wd === 6) return null;
                      var closed = !!officeClosed[selDay];
                      return <button onClick={function() {
                        var oc = Object.assign({}, officeClosed);
                        if (closed) { delete oc[selDay]; } else { oc[selDay] = "Office Closed"; }
                        setOfficeClosed(oc);
                        updateClosedDays(oc, cy >= 2020 ? cy : new Date().getFullYear());
                      }} style={{ background: closed ? "#fee2e2" : "#f0fdf4", border: "1px solid " + (closed ? "#fca5a5" : "#bbf7d0"), borderRadius: 4, padding: "2px 8px", cursor: "pointer", color: closed ? "#dc2626" : "#16a34a", fontSize: 10, fontWeight: 600 }}>{closed ? "Reopen Office" : "Mark Closed"}</button>;
                    })()}
                    <button onClick={function() { setSelDay(null); }} style={{ background: "#f1f5f9", border: "none", borderRadius: 4, padding: "2px 6px", cursor: "pointer", color: "#64748b", fontSize: 11 }}>✕</button>
                  </div>
                </div>
                {dayItems.length === 0 ? (
                  <div style={{ padding: 16, textAlign: "center", color: "#94a3b8", fontSize: 13 }}>No payments on this day</div>
                ) : (
                  <div style={{ borderRadius: 8, overflow: "hidden", border: "1px solid #e5e7eb" }}>
                    {dayItems.map(function(p, i) {
                      var sec = p.status === CLEARED ? "cleared" : p.status === PAID ? "pending" : "action";
                      return <Row key={p.id} p={p} sec={sec} idx={i} />;
                    })}
                  </div>
                )}
              </div>
            )}

          </div>
        )}
        {selCount > 0 && (
          <div style={{ background: "linear-gradient(135deg,#1e40af,#3b82f6)", borderRadius: 10, padding: "10px 16px", marginBottom: 10, display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
            <span style={{ color: "white", fontSize: 13, fontWeight: 600 }}>{selCount} selected</span>
            <span style={{ color: "#93c5fd", fontSize: 14, fontWeight: 700, fontFamily: "'JetBrains Mono',monospace", background: "rgba(255,255,255,0.15)", padding: "3px 10px", borderRadius: 6 }}>{fmt(selIds.reduce(function(s,id){var p=payments[id];return s+(p?effAmt(p):0);},0))}</span>
            <div style={{ flex: 1 }} />
            {tab === "action" && <button onClick={bulkPaid} style={{ background: "rgba(255,255,255,0.2)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>💰 Mark Paid</button>}
            {tab === "action" && <button onClick={bulkSkip} style={{ background: "rgba(255,255,255,0.2)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>⏭️ Skip</button>}
            {tab === "pending" && <button onClick={bulkCleared} style={{ background: "rgba(255,255,255,0.2)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>✓ Mark Cleared</button>}
            {tab === "pending" && <button onClick={bulkUnpaid} style={{ background: "rgba(255,255,255,0.2)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>↩️ Undo to Unpaid</button>}
            {tab === "skipped" && <button onClick={bulkUnskip} style={{ background: "rgba(255,255,255,0.2)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>↩️ Unskip Selected</button>}
            {tab === "skipped" && <button onClick={bulkResumeDate} style={{ background: "rgba(255,255,255,0.2)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>⏰ Change Resume Date</button>}
            {tab === "cleared" && <button onClick={bulkUnpaid} style={{ background: "rgba(255,255,255,0.2)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>↩️ Undo</button>}
            <button onClick={bulkDelete} style={{ background: "rgba(239,68,68,0.3)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>🗑️ Delete</button>
            <button onClick={selNone} style={{ background: "rgba(255,255,255,0.15)", color: "white", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer", fontSize: 12, fontWeight: 600 }}>✕ Clear</button>
          </div>
        )}

        {/* Tabs */}
        <div style={{ display: "flex", background: "white", boxShadow: "0 1px 3px rgba(0,0,0,0.1)", borderRadius: 9, padding: 3, marginBottom: 12, border: "1px solid #e5e7eb" }}>
          {[
            { k: "action", l: "Action Needed", n: actionItems.filter(function(p) { return !p.excluded && !p.isReminder; }).length + (selDay && selDay > td ? futureItems.filter(function(p) { return !p.excluded && !p.isReminder; }).length : 0), c: "#dc2626" },
            { k: "pending", l: "Pending Clear", n: pendItems.length, c: "#F59E0B" },
            { k: "cleared", l: "Cleared", n: clrItems.length, c: "#10B981" },
            { k: "skipped", l: "Skipped", n: skippedItems.length, c: "#94A3B8" }
          ].map(function(t) {
            return (
              <button key={t.k} onClick={function() { setTab(t.k); setSelected({}); }} style={{
                flex: 1, padding: "9px 4px", borderRadius: 7, border: "none",
                background: tab === t.k ? "#0f172a" : "transparent",
                color: tab === t.k ? "white" : "#374151", fontSize: 12, fontWeight: 600,
                cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", gap: 4
              }}>
                <span>{t.l}</span>
                {t.n > 0 && <span style={{ fontSize: 10, fontWeight: 700, padding: "2px 6px", borderRadius: 10, background: tab === t.k ? t.c : "rgba(148,163,184,.12)", color: tab === t.k ? "#fff" : "#94A3B8", minWidth: 18, textAlign: "center" }}>{t.n}</span>}
              </button>
            );
          })}
        </div>

        {/* Action tab */}
        {tab === "action" && (
          <div>
            {(function() {
              var todayBank = _bankClosed[td];
              if (todayBank) return <div style={{ background: "linear-gradient(135deg, #991b1b, #dc2626)", borderRadius: 10, padding: "10px 16px", marginBottom: 10, display: "flex", alignItems: "center", gap: 10 }}>
                <span style={{ fontSize: 20 }}>{String.fromCodePoint(0x1F3E6)}</span>
                <div>
                  <div style={{ color: "white", fontSize: 13, fontWeight: 700 }}>Bank Closed Today</div>
                  <div style={{ color: "#fecaca", fontSize: 11 }}>{todayBank}</div>
                </div>
              </div>;
              return null;
            })()}
            {actionItems.length === 0 && !futureItems.length && <div style={{ textAlign: "center", padding: 36, color: "#475569", background: "#f8fafc", borderRadius: 11 }}><div style={{ fontSize: 28, marginBottom: 4 }}>✓</div><div style={{ fontSize: 14, fontWeight: 600 }}>All caught up!</div></div>}
            {exclCount > 0 && <div style={{ padding: "6px 10px", background: "#f1f5f9", borderRadius: 8, marginBottom: 10, fontSize: 11, color: "#94A3B8" }}>{exclCount} skipped ({fmt(exclTotal)}) — not in funding total</div>}
            {pastItems.length > 0 && (
              <div style={{ marginBottom: 12 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
                  <div style={{ width: 8, height: 8, borderRadius: "50%", background: "#EF4444" }} />
                  <span style={{ fontSize: 14, fontWeight: 700, color: "#dc2626" }}>Past Due</span>
                  <span style={{ fontSize: 14, fontWeight: 600, fontFamily: "'JetBrains Mono',monospace", color: "#991b1b" }}>{fmt(sum(pastItems.filter(function(p) { return !p.excluded; }), false))}</span>
                  <div style={{ flex: 1 }} />
                  <button onClick={function() { toggleSelAll(pastItems); }} style={{ background: "none", border: "none", color: "#93c5fd", fontSize: 11, cursor: "pointer", fontWeight: 600 }}>{allSelected(pastItems) ? "Deselect all" : "Select all"}</button>
                </div>
                <div style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.1)", overflow: "hidden" }}>
                  <GroupedRows items={pastItems} sec="action" />
                </div>
              </div>
            )}
            {todayItems.length > 0 && (
              <div>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
                  <div style={{ width: 8, height: 8, borderRadius: "50%", background: "#3B82F6" }} />
                  <span style={{ fontSize: 14, fontWeight: 700, color: "#1e40af" }}>Due Today</span>
                  <span style={{ fontSize: 14, fontWeight: 600, fontFamily: "'JetBrains Mono',monospace", color: "#2563eb" }}>{fmt(sum(todayItems.filter(function(p) { return !p.excluded; }), false))}</span>
                  <div style={{ flex: 1 }} />
                  <button onClick={function() { toggleSelAll(todayItems); }} style={{ background: "none", border: "none", color: "#93c5fd", fontSize: 11, cursor: "pointer", fontWeight: 600 }}>{allSelected(todayItems) ? "Deselect all" : "Select all"}</button>
                </div>
                <div style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.1)", overflow: "hidden" }}>
                  {todayItems.map(function(p, i) { return <Row key={p.id} p={p} sec="action" idx={i} />; })}
                </div>
              </div>
            )}
            {futureItems.length > 0 && (
              <div style={{ marginTop: 12 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
                  <div style={{ width: 8, height: 8, borderRadius: "50%", background: "#8B5CF6" }} />
                  <span style={{ fontSize: 14, fontWeight: 700, color: "#6d28d9" }}>Upcoming</span>
                  <span style={{ fontSize: 14, fontWeight: 600, fontFamily: "'JetBrains Mono',monospace", color: "#7c3aed" }}>{fmt(sum(futureItems.filter(function(p) { return !p.excluded; }), false))}</span>
                  {selDay && <span style={{ fontSize: 11, color: "#a78bfa" }}>through {fmtS(selDay)}</span>}
                  <div style={{ flex: 1 }} />
                  <button onClick={function() { toggleSelAll(futureItems); }} style={{ background: "none", border: "none", color: "#a78bfa", fontSize: 11, cursor: "pointer", fontWeight: 600 }}>{allSelected(futureItems) ? "Deselect all" : "Select all"}</button>
                </div>
                <div style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.1)", overflow: "hidden" }}>
                  <GroupedRows items={futureItems} sec="action" />
                </div>
              </div>
            )}
          </div>
        )}

        {/* Pending tab */}
        {tab === "pending" && (
          <div>
            {pendItems.length === 0 ? (
              <div style={{ textAlign: "center", padding: 36, color: "#475569", background: "#f8fafc", borderRadius: 11 }}><div style={{ fontSize: 28, marginBottom: 4 }}>🏦</div><div style={{ fontSize: 14, fontWeight: 600 }}>No pending items</div></div>
            ) : (
              <div>
                <div style={{ padding: "6px 10px", background: "#fffbeb", borderRadius: 8, marginBottom: 10, display: "flex", justifyContent: "space-between", flexWrap: "wrap", alignItems: "center" }}>
                  <span style={{ fontSize: 12, color: "#F59E0B", fontWeight: 600 }}>Pending: {fmt(pendTotal)}</span>
                  <span style={{ fontSize: 11, color: "#94A3B8" }}>Available: {fmt(avail)}</span>
                  <button onClick={function() { toggleSelAll(pendItems); }} style={{ background: "none", border: "none", color: "#f59e0b", fontSize: 11, cursor: "pointer", fontWeight: 600 }}>{allSelected(pendItems) ? "Deselect all" : "Select all"}</button>
                </div>
                <div style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.1)", overflow: "hidden" }}>
                  <GroupedRows items={pendItems} sec="pending" />
                </div>
              </div>
            )}
          </div>
        )}

        {/* Cleared tab */}
        {tab === "cleared" && (
          <div>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8, alignItems: "center" }}>
              <span style={{ fontSize: 14, fontWeight: 600, color: "#374151" }}>Cleared Payments</span>
              <span style={{ fontSize: 14, fontWeight: 600, fontFamily: "'JetBrains Mono',monospace", color: "#059669" }}>{fmt(clrTotal)}</span>
              {clrItems.length > 0 && <button onClick={function() { toggleSelAll(clrItems); }} style={{ background: "none", border: "none", color: "#10b981", fontSize: 11, cursor: "pointer", fontWeight: 600 }}>{allSelected(clrItems) ? "Deselect all" : "Select all"}</button>}
            </div>
            {clrItems.length === 0 ? (
              <div style={{ textAlign: "center", padding: 36, color: "#475569", background: "#f8fafc", borderRadius: 11 }}><div style={{ fontSize: 28, marginBottom: 4 }}>📋</div><div style={{ fontSize: 15, fontWeight: 600 }}>Nothing cleared yet</div></div>
            ) : (
              <div style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.1)", overflow: "hidden" }}>
                {<GroupedRows items={clrItems} sec="cleared" />}
              </div>
            )}
          </div>
        )}

        {/* Skipped tab */}
        {tab === "skipped" && (
          <div>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8, alignItems: "center" }}>
              <span style={{ fontSize: 14, fontWeight: 600, color: "#374151" }}>Skipped Payments</span>
              <span style={{ fontSize: 14, fontWeight: 600, fontFamily: "'JetBrains Mono',monospace", color: "#64748b" }}>{fmt(skippedTotal)}</span>
              {skippedItems.length > 0 && <button onClick={function() { toggleSelAll(skippedItems); }} style={{ background: "none", border: "none", color: "#94a3b8", fontSize: 11, cursor: "pointer", fontWeight: 600 }}>{allSelected(skippedItems) ? "Deselect all" : "Select all"}</button>}
            </div>
            {skippedItems.length === 0 ? (
              <div style={{ textAlign: "center", padding: 36, color: "#475569", background: "#f8fafc", borderRadius: 11 }}><div style={{ fontSize: 28, marginBottom: 4 }}>⏭️</div><div style={{ fontSize: 15, fontWeight: 600 }}>No skipped items</div></div>
            ) : (
              <div>
                <div style={{ padding: "6px 10px", background: "#f1f5f9", borderRadius: 8, marginBottom: 10, fontSize: 11, color: "#94A3B8" }}>
                  {skippedItems.length} item{skippedItems.length !== 1 ? "s" : ""} skipped &middot; {fmt(skippedTotal)} excluded from funding
                </div>
                <div style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.1)", overflow: "hidden" }}>
                  {skippedItems.map(function(p, i) { return <Row key={p.id} p={p} sec="skipped" idx={i} />; })}
                </div>
              </div>
            )}
          </div>
        )}

      </div>

      {/* ── Modals ── */}

      {/* Skip with date picker */}
      <Modal open={skipPickId !== null} onClose={function() { setSkipPickId(null); }}>
        {(function() {
          var isBulkSkip = skipPickId === "__bulk__";
          var isBulkResume = skipPickId === "__bulk_resume__";
          var isBulk = isBulkSkip || isBulkResume;
          var isSingle = !isBulk && skipPickId;
          var singleP = isSingle ? payments[skipPickId] : null;
          var isAlreadySkipped = singleP ? singleP.excluded : isBulkResume;

          var title = isBulkSkip ? "⏭️ Skip " + selCount + " Payments"
            : isBulkResume ? "⏰ Change Resume Date (" + selCount + " items)"
            : (isAlreadySkipped ? "⏰ Change Resume Date" : "⏭️ Skip Payment");
          var subtitle = isBulk
            ? selIds.map(function(id){var p=payments[id];return p?p.name:"";}).filter(Boolean).join(", ")
            : (singleP ? singleP.name : "");

          function doAction() {
            if (isBulk) {
              selIds.forEach(function(id) {
                if (isBulkSkip) {
                  skipWithDate(id, skipPickDate || null);
                } else {
                  // Bulk resume — only update resume date, item should already be skipped
                  if (skipPickDate) {
                    setSkipUntil(function(prev) { var n = Object.assign({}, prev); n[id] = skipPickDate; return n; });
                  } else {
                    setSkipUntil(function(prev) { var n = Object.assign({}, prev); delete n[id]; return n; });
                  }
                }
              });
              setSkipPickId(null);
              setSkipPickDate("");
              if (isBulkSkip) setSelected({});
            } else {
              skipWithDate(skipPickId, skipPickDate || null);
            }
          }

          var btnLabel = isBulkSkip
            ? (skipPickDate ? "Skip " + selCount + " until " + fmtS(skipPickDate) : "Skip " + selCount + " Indefinitely")
            : isBulkResume
            ? (skipPickDate ? "Set resume to " + fmtS(skipPickDate) : "Remove resume dates")
            : (isAlreadySkipped ? (skipPickDate ? "Set resume to " + fmtS(skipPickDate) : "Remove resume date") : (skipPickDate ? "Skip until " + fmtS(skipPickDate) : "Skip Indefinitely"));

          return React.createElement("div", null,
            React.createElement("h2", { style: { fontSize: 15, fontWeight: 700, color: "#0F172A", marginBottom: 4 } }, title),
            React.createElement("p", { style: { fontSize: 12, color: "#64748b", marginBottom: 12, maxHeight: 40, overflow: "hidden", textOverflow: "ellipsis" } }, subtitle),
            React.createElement("div", { style: { marginBottom: 12 } },
              React.createElement(Label, { text: "Auto-resume on (optional)" }),
              React.createElement("input", { type: "date", value: skipPickDate, onChange: function(e) { setSkipPickDate(e.target.value); }, min: getToday(), style: Object.assign({}, inputS, { marginBottom: 4 }) }),
              React.createElement("div", { style: { fontSize: 11, color: "#94a3b8" } }, "Leave blank to skip indefinitely. If a date is set, payment will automatically unskip on that day.")
            ),
            React.createElement("div", { style: { display: "flex", gap: 8 } },
              React.createElement("button", { onClick: function() { setSkipPickId(null); }, style: btnSecondary }, "Cancel"),
              React.createElement("button", { onClick: doAction, style: Object.assign({}, btnPrimary, { background: "linear-gradient(135deg,#94a3b8,#64748b)" }) }, btnLabel)
            )
          );
        })()}
      </Modal>

      {/* Share Summary with options */}
      <Modal open={showShare} onClose={function() { setShowShare(false); }}>
        <h2 style={{ fontSize: 15, fontWeight: 700, color: "#0F172A", marginBottom: 4 }}>📋 Share Summary</h2>
        <p style={{ fontSize: 12, color: "#64748b", marginBottom: 12 }}>Choose what to include, then copy to clipboard.</p>
        {(function() {
          var opts = [
            { key: "balance", label: "Operating Account Balance", icon: "🏦" },
            { key: "available", label: "Available (After Pending)", icon: "📊" },
            { key: "totalDue", label: "Total Payments Due", icon: "💵" },
            { key: "funding", label: "Funding Needed / Covered", icon: "🔴" },
            { key: "pending", label: "Pending to Clear", icon: "⏳" },
            { key: "itemList", label: "Payment Items (names & amounts)", icon: "📋" },
            { key: "itemDetails", label: "Item Details (auto-pay, check #, min pmt)", icon: "📝" },
          ];
          return (
            <div style={{ display: "flex", flexDirection: "column", gap: 4, marginBottom: 16 }}>
              {opts.map(function(o) {
                var checked = shareOpts[o.key];
                return (
                  <label key={o.key} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 12px", background: checked ? "#eff6ff" : "#f8fafc", border: checked ? "1.5px solid #93c5fd" : "1.5px solid #e2e8f0", borderRadius: 8, cursor: "pointer", transition: "all 0.15s" }}>
                    <input type="checkbox" checked={checked} onChange={function() { setShareOpts(function(prev) { var n = Object.assign({}, prev); n[o.key] = !n[o.key]; return n; }); }} style={{ width: 16, height: 16, accentColor: "#3b82f6", cursor: "pointer" }} />
                    <span style={{ fontSize: 15 }}>{o.icon}</span>
                    <span style={{ fontSize: 13, fontWeight: checked ? 600 : 400, color: checked ? "#1e40af" : "#64748b" }}>{o.label}</span>
                  </label>
                );
              })}
            </div>
          );
        })()}
        {/* Preview */}
        <div style={{ background: "#f8fafc", border: "1px solid #e2e8f0", borderRadius: 8, padding: 12, marginBottom: 14, maxHeight: 200, overflowY: "auto" }}>
          <div style={{ fontSize: 10, fontWeight: 700, color: "#94a3b8", textTransform: "uppercase", marginBottom: 6 }}>Preview</div>
          <pre style={{ fontSize: 11, color: "#374151", whiteSpace: "pre-wrap", fontFamily: "inherit", lineHeight: 1.5, margin: 0 }}>{generateSummary(shareOpts)}</pre>
        </div>
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={function() { setShowShare(false); }} style={btnSecondary}>Cancel</button>
          <button onClick={function() { copySummary(); setShowShare(false); }} style={Object.assign({}, btnPrimary, { background: copied ? "linear-gradient(135deg,#10b981,#059669)" : "linear-gradient(135deg,#3b82f6,#2563eb)" })}>{copied ? "✅ Copied!" : "📋 Copy to Clipboard"}</button>
        </div>
      </Modal>

      {/* Add Payment */}
      <Modal open={showAdd} onClose={function() { setShowAdd(false); }}>
        <h2 style={{ fontSize: 15, fontWeight: 700, color: "#0F172A", marginBottom: 12 }}>Add Payment</h2>
        <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>

          {/* Recurring toggle */}
          <div style={{ display: "flex", borderRadius: 8, overflow: "hidden", border: "1.5px solid #E2E8F0" }}>
            <button onClick={function() { setForm(Object.assign({}, form, { isRecurring: false })); }} style={{ flex: 1, padding: "8px 0", border: "none", fontSize: 12, fontWeight: 600, cursor: "pointer", background: !form.isRecurring ? "#3B82F6" : "#F8FAFC", color: !form.isRecurring ? "#fff" : "#64748B" }}>One-Time</button>
            <button onClick={function() { setForm(Object.assign({}, form, { isRecurring: true })); }} style={{ flex: 1, padding: "8px 0", border: "none", fontSize: 12, fontWeight: 600, cursor: "pointer", background: form.isRecurring ? "#3B82F6" : "#F8FAFC", color: form.isRecurring ? "#fff" : "#64748B", borderLeft: "1px solid #E2E8F0" }}>Recurring Monthly</button>
          </div>

          {/* Reminder toggle */}
          <label style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 12px", background: form.isReminder ? "#faf5ff" : "#f8fafc", border: form.isReminder ? "1.5px solid #c4b5fd" : "1.5px solid #e2e8f0", borderRadius: 8, cursor: "pointer", transition: "all 0.15s" }}>
            <input type="checkbox" checked={form.isReminder} onChange={function(e) { setForm(Object.assign({}, form, { isReminder: e.target.checked })); }} style={{ width: 15, height: 15, accentColor: "#8b5cf6", cursor: "pointer" }} />
            <span style={{ fontSize: 14 }}>🔔</span>
            <div>
              <span style={{ fontSize: 12, fontWeight: form.isReminder ? 600 : 400, color: form.isReminder ? "#6b21a8" : "#64748b" }}>Reminder Only (CC Payment)</span>
              <div style={{ fontSize: 10, color: "#94a3b8" }}>Won't affect funding calculations</div>
            </div>
          </label>

          <div><Label text="Name" /><input style={inputS} value={form.name} onChange={function(e) { setForm(Object.assign({}, form, { name: e.target.value })); }} placeholder="e.g. Office Supplies" /></div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
            <div><Label text="Category" /><select style={Object.assign({}, inputS, { cursor: "pointer" })} value={form.category} onChange={function(e) { setForm(Object.assign({}, form, { category: e.target.value })); }}>{Object.keys(CATS).map(function(c) { return <option key={c}>{c}</option>; })}</select></div>
            <div><Label text={form.category === "Credit Card" ? "Full Statement ($)" : "Amount ($)"} /><input style={Object.assign({}, inputS, { fontFamily: "'JetBrains Mono',monospace" })} type="number" step=".01" value={form.amount} onChange={function(e) { setForm(Object.assign({}, form, { amount: e.target.value })); }} /></div>
          </div>
          <CCFields f={form} setF={setForm} />

          {/* Conditional: One-time shows due date, Recurring shows day-of-month */}
          {form.isRecurring ? (
            <div>
              <div><Label text="Due Day of Month (1-31)" /><input style={Object.assign({}, inputS, { fontFamily: "'JetBrains Mono',monospace" })} type="number" min="1" max="31" value={form.dayOfMonth} onChange={function(e) { setForm(Object.assign({}, form, { dayOfMonth: e.target.value })); }} /></div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginTop: 10 }}>
                <div><Label text="Start Date" /><input type="date" style={inputS} value={form.startDate} onChange={function(e) { setForm(Object.assign({}, form, { startDate: e.target.value })); }} /></div>
                <div><Label text="End Date (optional)" /><input type="date" style={inputS} value={form.endDate} onChange={function(e) { setForm(Object.assign({}, form, { endDate: e.target.value })); }} /></div>
              </div>
              <div style={{ marginTop: 10, padding: "9px 11px", background: "#F0FDF4", borderRadius: 8, border: "1px solid #BBF7D0" }}>
                <label style={{ display: "flex", alignItems: "flex-start", gap: 7, cursor: "pointer" }}>
                  <input type="checkbox" checked={form.sameAmount} onChange={function(e) { setForm(Object.assign({}, form, { sameAmount: e.target.checked })); }} style={{ accentColor: "#10B981", width: 14, height: 14, marginTop: 2 }} />
                  <div>
                    <span style={{ fontSize: 12, color: "#374151", fontWeight: 500 }}>Same amount each month</span>
                    <div style={{ fontSize: 10, color: "#94A3B8", marginTop: 1 }}>{form.sameAmount ? "Exact amount duplicated every month" : "Amount varies — you can edit each month"}</div>
                  </div>
                </label>
              </div>
            </div>
          ) : (
            <div><Label text="Due Date" /><input style={inputS} type="date" value={form.dueDate} onChange={function(e) { setForm(Object.assign({}, form, { dueDate: e.target.value })); }} /></div>
          )}

          <div><Label text="Note" /><textarea style={Object.assign({}, inputS, { minHeight: 45, resize: "vertical" })} value={form.note} onChange={function(e) { setForm(Object.assign({}, form, { note: e.target.value })); }} placeholder="Optional note..." /></div>
          <label style={{ display: "flex", alignItems: "center", gap: 7, cursor: "pointer" }}><input type="checkbox" checked={form.autoPay} onChange={function(e) { setForm(Object.assign({}, form, { autoPay: e.target.checked })); }} style={{ accentColor: "#3B82F6", width: 14, height: 14 }} /><span style={{ fontSize: 12, color: "#374151" }}>Auto-Pay</span></label>

          {/* Reminder-specific: card picker + invoice day */}
          {form.isReminder && (
            <div style={{ padding: "9px 11px", background: "#faf5ff", borderRadius: 8, border: "1px solid #d8b4fe" }}>
              <div style={{ fontSize: 10, fontWeight: 700, color: "#6b21a8", marginBottom: 6 }}>🔔 Reminder Details</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                <div>
                  <Label text="Pay With Card" />
                  <select style={Object.assign({}, inputS, { cursor: "pointer", borderColor: "#d8b4fe" })} value={form.payCard} onChange={function(e) { setForm(Object.assign({}, form, { payCard: e.target.value })); }}>
                    <option value="">Select card...</option>
                    {ccCardNames.map(function(cn) { return <option key={cn} value={cn}>{cn}</option>; })}
                  </select>
                </div>
                {form.isRecurring && (
                  <div>
                    <Label text="Invoice/Statement Day" />
                    <input style={Object.assign({}, inputS, { fontFamily: "'JetBrains Mono',monospace", borderColor: "#d8b4fe" })} type="number" min="1" max="31" value={form.closeDay} onChange={function(e) { setForm(Object.assign({}, form, { closeDay: e.target.value })); }} placeholder="e.g. 5" />
                  </div>
                )}
              </div>
              <div style={{ fontSize: 10, color: "#a78bfa", marginTop: 4 }}>Invoice day triggers a banner to enter the due amount</div>
            </div>
          )}
          <div style={{ display: "flex", gap: 8 }}>
            <button onClick={function() { setShowAdd(false); }} style={btnSecondary}>Cancel</button>
            <button onClick={addPay} style={btnPrimary}>{form.isRecurring ? "Add Recurring" : "Add"}</button>
          </div>
        </div>
      </Modal>

      {/* Edit Payment */}
      <Modal open={editId !== null} onClose={function() { setEditId(null); }}>
        <h2 style={{ fontSize: 15, fontWeight: 700, color: "#0F172A", marginBottom: 12 }}>Edit Payment</h2>
        <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
          <div><Label text="Name" /><input style={inputS} value={form.name} onChange={function(e) { setForm(Object.assign({}, form, { name: e.target.value })); }} /></div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
            <div><Label text="Category" /><select style={Object.assign({}, inputS, { cursor: "pointer" })} value={form.category} onChange={function(e) { setForm(Object.assign({}, form, { category: e.target.value })); }}>{Object.keys(CATS).map(function(c) { return <option key={c}>{c}</option>; })}</select></div>
            <div><Label text={form.category === "Credit Card" && !form.isReminder ? "Full Statement ($)" : "Amount ($)"} /><input style={Object.assign({}, inputS, { fontFamily: "'JetBrains Mono',monospace" })} type="number" step=".01" value={form.amount} onChange={function(e) { setForm(Object.assign({}, form, { amount: e.target.value })); }} /></div>
          </div>
          {!form.isReminder && <CCFields f={form} setF={setForm} />}
          {form.isReminder && (
            <div style={{ padding: "9px 11px", background: "#faf5ff", borderRadius: 8, border: "1px solid #d8b4fe" }}>
              <div style={{ fontSize: 10, fontWeight: 700, color: "#6b21a8", marginBottom: 6 }}>🔔 Pay With Card</div>
              <select style={Object.assign({}, inputS, { cursor: "pointer", borderColor: "#d8b4fe" })} value={form.payCard} onChange={function(e) { setForm(Object.assign({}, form, { payCard: e.target.value })); }}>
                <option value="">Select card...</option>
                {ccCardNames.map(function(cn) { return <option key={cn} value={cn}>{cn}</option>; })}
              </select>
            </div>
          )}
          <div><Label text="Due Date" /><input style={inputS} type="date" value={form.dueDate} onChange={function(e) { setForm(Object.assign({}, form, { dueDate: e.target.value })); }} /></div>
          <div><Label text="Check #" /><input style={Object.assign({}, inputS, { fontFamily: "'JetBrains Mono',monospace" })} value={form.checkNum} onChange={function(e) { setForm(Object.assign({}, form, { checkNum: e.target.value })); }} placeholder="Optional" /></div>
          <div><Label text="Note" /><textarea style={Object.assign({}, inputS, { minHeight: 45, resize: "vertical" })} value={form.note} onChange={function(e) { setForm(Object.assign({}, form, { note: e.target.value })); }} /></div>
          <AttachSection editId={editId} attachments={attachments} attachLoading={attachLoading} openAttachViewer={openAttachViewer} removeAttachment={removeAttachment} uploadAttachment={uploadAttachment} />
          <div style={{ display: "flex", gap: 8 }}>
            <button onClick={function() { setEditId(null); }} style={btnSecondary}>Cancel</button>
            <button onClick={saveEdit} style={btnPrimary}>Save</button>
          </div>
        </div>
      </Modal>

            {/* Attachment Viewer - Centered modal */}
      {viewAttach && (
        <div onClick={closeAttachViewer} style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, zIndex: 10000, background: "rgba(0,0,0,0.6)", display: "flex", alignItems: "center", justifyContent: "center", padding: 40 }}>
          <div onClick={function(e) { e.stopPropagation(); }} style={{ background: "white", borderRadius: 12, width: "100%", maxWidth: 720, maxHeight: "85vh", display: "flex", flexDirection: "column", boxShadow: "0 25px 60px rgba(0,0,0,0.4)", overflow: "hidden" }}>
            {/* Header bar */}
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 16px", borderBottom: "1px solid #e2e8f0", flexShrink: 0 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8, minWidth: 0, flex: 1 }}>
                <span style={{ fontSize: 16, flexShrink: 0 }}>{viewAttach.name.toLowerCase().endsWith(".pdf") ? "📄" : "🖼️"}</span>
                <span style={{ fontSize: 13, fontWeight: 600, color: "#0f172a", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{viewAttach.name}</span>
              </div>
              <div style={{ display: "flex", gap: 6, alignItems: "center", flexShrink: 0 }}>
                {viewAttachList.length > 1 && (
                  <div style={{ display: "flex", alignItems: "center", gap: 4, marginRight: 4 }}>
                    <button onClick={function() { viewAttachNav(-1); }} disabled={viewAttachIdx === 0} style={{ padding: "3px 8px", background: viewAttachIdx === 0 ? "#f1f5f9" : "#e2e8f0", border: "none", borderRadius: 4, cursor: viewAttachIdx === 0 ? "default" : "pointer", fontSize: 12, color: viewAttachIdx === 0 ? "#cbd5e1" : "#334155" }}>◀</button>
                    <span style={{ fontSize: 11, color: "#64748b", minWidth: 30, textAlign: "center" }}>{viewAttachIdx + 1}/{viewAttachList.length}</span>
                    <button onClick={function() { viewAttachNav(1); }} disabled={viewAttachIdx >= viewAttachList.length - 1} style={{ padding: "3px 8px", background: viewAttachIdx >= viewAttachList.length - 1 ? "#f1f5f9" : "#e2e8f0", border: "none", borderRadius: 4, cursor: viewAttachIdx >= viewAttachList.length - 1 ? "default" : "pointer", fontSize: 12, color: viewAttachIdx >= viewAttachList.length - 1 ? "#cbd5e1" : "#334155" }}>▶</button>
                  </div>
                )}
                <a href={viewAttach.webUrl || "#"} target="_blank" rel="noopener" style={{ padding: "5px 12px", background: "#10b981", color: "white", borderRadius: 6, fontSize: 11, fontWeight: 600, textDecoration: "none" }}>📎 SharePoint</a>
                <button onClick={downloadAttach} style={{ padding: "5px 12px", background: "#3b82f6", color: "white", border: "none", borderRadius: 6, fontSize: 11, fontWeight: 600, cursor: "pointer" }}>⬇️ Download</button>
                <button onClick={closeAttachViewer} style={{ background: "none", border: "none", color: "#64748b", fontSize: 20, cursor: "pointer", padding: "2px 6px", lineHeight: 1 }}>✕</button>
              </div>
            </div>
            {/* Preview area */}
            <div style={{ flex: 1, overflow: "auto", minHeight: 0 }}>
              {viewLoading ? (
                <div style={{ display: "flex", alignItems: "center", justifyContent: "center", height: 400 }}>
                  <div style={{ textAlign: "center" }}>
                    <div style={{ width: 40, height: 40, border: "4px solid #e2e8f0", borderTopColor: "#3b82f6", borderRadius: "50%", animation: "spin 1s linear infinite", margin: "0 auto 12px" }} />
                    <p style={{ color: "#64748b", fontSize: 13 }}>Loading preview...</p>
                  </div>
                </div>
              ) : viewBlobUrl ? (
                viewAttach.name.toLowerCase().endsWith(".pdf") ? (
                  <iframe src={viewBlobUrl} style={{ width: "100%", height: "calc(85vh - 52px)", border: "none", display: "block" }} />
                ) : (
                  <div style={{ display: "flex", alignItems: "center", justifyContent: "center", padding: 20, background: "#f8fafc" }}>
                    <img src={viewBlobUrl} style={{ maxWidth: "100%", maxHeight: "calc(85vh - 92px)", objectFit: "contain" }} alt={viewAttach.name} />
                  </div>
                )
              ) : (
                <div style={{ display: "flex", alignItems: "center", justifyContent: "center", height: 300 }}>
                  <p style={{ color: "#94a3b8" }}>Could not load preview</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Recurring Templates — view/edit/delete only */}
      <Modal open={showRec} onClose={function() { setShowRec(false); }}>
        <h2 style={{ fontSize: 15, fontWeight: 700, color: "#0F172A", marginBottom: 4 }}>Recurring Payments</h2>
        <p style={{ fontSize: 11, color: "#64748B", marginBottom: 12 }}>Manage your recurring templates. Use <b>+ Payment → Recurring Monthly</b> to add new ones.</p>
        {tmpls.length === 0 ? (
          <div style={{ textAlign: "center", padding: 30, color: "#94a3b8", background: "#f8fafc", borderRadius: 10 }}>
            <div style={{ fontSize: 24, marginBottom: 6 }}>⟳</div>
            <div style={{ fontSize: 13, fontWeight: 600 }}>No recurring templates yet</div>
            <div style={{ fontSize: 11, marginTop: 4 }}>Click <b>+ Payment</b> and choose <b>Recurring Monthly</b> to create one.</div>
          </div>
        ) : (
          <div>
            <div style={{ fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 6, textTransform: "uppercase" }}>Active Recurring ({tmpls.length})</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 3, maxHeight: 420, overflowY: "auto" }}>
              {tmpls.map(function(t, idx) {
                var isCC = t.category === "Credit Card";
                var isEditing = editTmplIdx === idx;

                if (isEditing && editTmplF) {
                  var ef = editTmplF;
                  var setEf = function(o) { setEditTmplF(Object.assign({}, ef, o)); };
                  return (
                    <div key={t.name} style={{ padding: "10px", background: "#eff6ff", borderRadius: 8, border: "2px solid #3b82f6" }}>
                      <div style={{ fontSize: 10, fontWeight: 700, color: "#1e40af", marginBottom: 6 }}>✏️ Editing: {t.name}</div>
                      <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                        <label style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 11 }}>
                          <input type="checkbox" checked={ef.isReminder} onChange={function(e){setEditTmplF(Object.assign({},ef,{isReminder:e.target.checked}));}} style={{ accentColor: "#8b5cf6" }} />
                          <span style={{ color: ef.isReminder ? "#6b21a8" : "#64748b" }}>🔔 Reminder</span>
                        </label>
                        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
                          <input value={ef.name} onChange={function(e){setEditTmplF(Object.assign({},ef,{name:e.target.value}));}} style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d1d5db", fontSize: 11, outline: "none" }} placeholder="Name" />
                          <select value={ef.category} onChange={function(e){setEditTmplF(Object.assign({},ef,{category:e.target.value}));}} style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d1d5db", fontSize: 11, outline: "none", cursor: "pointer" }}>{Object.keys(CATS).map(function(c){return <option key={c}>{c}</option>;})}</select>
                        </div>
                        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 4 }}>
                          <input value={ef.amount} onChange={function(e){setEditTmplF(Object.assign({},ef,{amount:e.target.value}));}} type="number" step=".01" placeholder="Amount" style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d1d5db", fontSize: 11, fontFamily: "'JetBrains Mono',monospace", outline: "none" }} />
                          <input value={ef.dayOfMonth} onChange={function(e){setEditTmplF(Object.assign({},ef,{dayOfMonth:e.target.value}));}} type="number" min="1" max="31" placeholder="Day" style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d1d5db", fontSize: 11, outline: "none" }} />
                          {ef.category==="Credit Card" && !ef.isReminder && <input value={ef.minPay} onChange={function(e){setEditTmplF(Object.assign({},ef,{minPay:e.target.value}));}} type="number" step=".01" placeholder="Min Pay" style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #fde68a", fontSize: 11, fontFamily: "'JetBrains Mono',monospace", outline: "none" }} />}
                        </div>
                        {ef.category==="Credit Card" && !ef.isReminder && (
                          <input value={ef.closeDay} onChange={function(e){setEditTmplF(Object.assign({},ef,{closeDay:e.target.value}));}} type="number" min="1" max="31" placeholder="Close Day" style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #fde68a", fontSize: 11, outline: "none", width: "50%" }} />
                        )}
                        {ef.isReminder && (
                          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
                            <select value={ef.defaultCard} onChange={function(e){setEditTmplF(Object.assign({},ef,{defaultCard:e.target.value}));}} style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d8b4fe", fontSize: 11, outline: "none", cursor: "pointer" }}>
                              <option value="">Default card...</option>
                              {ccCardNames.map(function(cn){return <option key={cn} value={cn}>{cn}</option>;})}</select>
                            <input value={ef.closeDay} onChange={function(e){setEditTmplF(Object.assign({},ef,{closeDay:e.target.value}));}} type="number" min="1" max="31" placeholder="Invoice day" style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d8b4fe", fontSize: 11, outline: "none" }} />
                          </div>
                        )}
                        <label style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 11 }}>
                          <input type="checkbox" checked={ef.autoPay} onChange={function(e){setEditTmplF(Object.assign({},ef,{autoPay:e.target.checked}));}} style={{ accentColor: "#3b82f6" }} />
                          <span style={{ color: "#64748b" }}>Auto-Pay</span>
                        </label>
                        <textarea value={ef.note} onChange={function(e){setEditTmplF(Object.assign({},ef,{note:e.target.value}));}} placeholder="Note (applies to all future payments)" style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d1d5db", fontSize: 11, outline: "none", minHeight: 32, resize: "vertical", fontFamily: "inherit" }} />
                        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
                          <input type="date" value={ef.startDate} onChange={function(e){setEditTmplF(Object.assign({},ef,{startDate:e.target.value}));}} style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d1d5db", fontSize: 11, outline: "none" }} />
                          <input type="date" value={ef.endDate} onChange={function(e){setEditTmplF(Object.assign({},ef,{endDate:e.target.value}));}} placeholder="End" style={{ padding: "5px 8px", borderRadius: 5, border: "1px solid #d1d5db", fontSize: 11, outline: "none" }} />
                        </div>
                        <div style={{ display: "flex", gap: 4 }}>
                          <button onClick={function(){setEditTmplIdx(null);setEditTmplF(null);}} style={{ flex: 1, padding: "5px", background: "white", border: "1px solid #d1d5db", borderRadius: 5, fontSize: 11, cursor: "pointer" }}>Cancel</button>
                          <button onClick={saveEditTmpl} style={{ flex: 1, padding: "5px", background: "#3b82f6", color: "white", border: "none", borderRadius: 5, fontSize: 11, fontWeight: 600, cursor: "pointer" }}>Save</button>
                        </div>
                      </div>
                    </div>
                  );
                }

                return (
                  <div key={t.name} style={{ display: "flex", alignItems: "center", gap: 6, padding: "7px 10px", background: t.isReminder ? "#faf5ff" : "#F8FAFC", borderRadius: 6, border: t.isReminder ? "1px solid #e9d5ff" : "1px solid #E2E8F0" }}>
                    <div style={{ width: 5, height: 5, borderRadius: "50%", background: t.isReminder ? "#a78bfa" : (CATS[t.category] || CATS.Other).dot }} />
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 12, fontWeight: 600, color: "#0F172A" }}>{t.name} {t.isReminder ? "🔔" : ""}</div>
                      <div style={{ fontSize: 11, color: "#94a3b8" }}>
                        Day {t.dayOfMonth} · {fmt(t.amount)}
                        {isCC && t.minPay && !t.isReminder ? " · Min " + fmt(t.minPay) : ""}
                        {isCC && t.closeDay && !t.isReminder ? " · Closes day " + t.closeDay : ""}
                        {t.isReminder && t.closeDay ? " · Invoice day " + t.closeDay : ""}
                        {t.isReminder && t.defaultCard ? " · 💳 " + t.defaultCard : ""}
                        {t.autoPay ? " · Auto-Pay" : ""}
                      </div>
                      {(t.startDate || t.endDate) && <div style={{ fontSize: 10, color: "#93c5fd" }}>
                        {t.startDate ? "From " + fmtS(t.startDate) : ""}
                        {t.endDate ? " → " + fmtS(t.endDate) : ""}
                      </div>}
                      {t.note && <div style={{ fontSize: 10, color: "#64748b", fontStyle: "italic", marginTop: 1 }}>📝 {t.note.length > 50 ? t.note.slice(0,50) + "…" : t.note}</div>}
                    </div>
                    <button onClick={function() { openEditTmpl(idx); }} style={{ background: "#dbeafe", border: "none", borderRadius: 6, padding: "6px 10px", cursor: "pointer", color: "#2563eb", fontSize: 14 }}>✏️</button>
                    <button onClick={function() { if(confirm("Delete recurring template \"" + t.name + "\"?")) remTmpl(t.name); }} style={{ background: "#fee2e2", border: "none", borderRadius: 6, padding: "6px 10px", cursor: "pointer", color: "#dc2626", fontSize: 14 }}>🗑️</button>
                  </div>
                );
              })}
            </div>
          </div>
        )}
        <div style={{ marginTop: 16, borderTop: "1px solid #E2E8F0", paddingTop: 12 }}>
          <button onClick={function() { setShowRec(false); setEditTmplIdx(null); setEditTmplF(null); }} style={{ width: "100%", padding: "10px", background: "#0f172a", color: "white", border: "none", borderRadius: 8, cursor: "pointer", fontSize: 13, fontWeight: 600 }}>Done</button>
        </div>
      </Modal>

      {/* Notes */}
      <Modal open={noteId !== null} onClose={function() { setNoteId(null); }}>
        <h2 style={{ fontSize: 15, fontWeight: 700, color: "#0F172A", marginBottom: 10 }}>📝 Notes</h2>
        <textarea value={noteIn} onChange={function(e) { setNoteIn(e.target.value); }} autoFocus placeholder="Add a note..." style={Object.assign({}, inputS, { minHeight: 100, resize: "vertical", marginBottom: 10, fontSize: 14 })} />
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={function() { setNoteId(null); }} style={btnSecondary}>Cancel</button>
          <button onClick={function() { saveNote(noteId); }} style={Object.assign({}, btnPrimary, { background: "linear-gradient(135deg,#8B5CF6,#6366F1)" })}>Save Note</button>
        </div>
      </Modal>

      {/* Check # */}
      <Modal open={checkId !== null} onClose={function() { setCheckId(null); }}>
        <h2 style={{ fontSize: 15, fontWeight: 700, color: "#0F172A", marginBottom: 10 }}>Check Number</h2>
        <input value={chkIn} onChange={function(e) { setChkIn(e.target.value); }} onKeyDown={function(e) { if (e.key === "Enter") saveChk(checkId); }} autoFocus placeholder="e.g. 10452" style={Object.assign({}, inputS, { fontSize: 16, fontFamily: "'JetBrains Mono',monospace", marginBottom: 10 })} />
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={function() { setCheckId(null); }} style={btnSecondary}>Cancel</button>
          <button onClick={function() { saveChk(checkId); }} style={Object.assign({}, btnPrimary, { background: "linear-gradient(135deg,#10B981,#059669)" })}>Save</button>
        </div>
      </Modal>

      {/* Employees */}
      <Modal open={showEmp} onClose={function() { setShowEmp(false); setEditEmpName(null); setEditEmpF(null); }}>
        <h2 style={{ fontSize: 15, fontWeight: 700, color: "#0F172A", marginBottom: 10 }}>👥 Employees</h2>
        <div style={{ display: "flex", flexDirection: "column", gap: 4, marginBottom: 12, maxHeight: 320, overflowY: "auto" }}>
          {emps.map(function(e) {
            var isPaused = e.pauseFrom && (!e.pauseTo || e.pauseTo >= getToday());
            var isEditing = editEmpName === e.name && editEmpF;

            if (isEditing) {
              return (
                <div key={e.name} style={{ padding: "10px", background: "#eff6ff", borderRadius: 8, border: "2px solid #3b82f6" }}>
                  <div style={{ fontSize: 10, fontWeight: 700, color: "#1e40af", marginBottom: 6 }}>✏️ Editing: {e.name}</div>
                  <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 4 }}>
                      <div>
                        <Label text="Name" />
                        <input value={editEmpF.name} onChange={function(ev) { setEditEmpF(Object.assign({}, editEmpF, { name: ev.target.value })); }} style={{ width: "100%", padding: "5px 8px", borderRadius: 5, border: "1px solid #93c5fd", fontSize: 11, outline: "none", color: "#0F172A" }} />
                      </div>
                      <div>
                        <Label text="Pay Amount" />
                        <input value={editEmpF.salary} onChange={function(ev) { setEditEmpF(Object.assign({}, editEmpF, { salary: ev.target.value })); }} type="number" step=".01" style={{ width: "100%", padding: "5px 8px", borderRadius: 5, border: "1px solid #93c5fd", fontSize: 11, fontFamily: "'JetBrains Mono',monospace", outline: "none", color: "#0F172A" }} />
                      </div>
                    </div>
                    <div>
                      <Label text="Start Date" />
                      <input type="date" value={editEmpF.startDate} onChange={function(ev) { setEditEmpF(Object.assign({}, editEmpF, { startDate: ev.target.value })); }} style={{ width: "100%", padding: "5px 8px", borderRadius: 5, border: "1px solid #93c5fd", fontSize: 11, outline: "none", color: "#0F172A" }} />
                    </div>
                    <div style={{ display: "flex", gap: 4 }}>
                      <button onClick={function() { setEditEmpName(null); setEditEmpF(null); }} style={{ flex: 1, padding: "5px", background: "white", border: "1px solid #d1d5db", borderRadius: 5, fontSize: 11, cursor: "pointer", color: "#374151" }}>Cancel</button>
                      <button onClick={saveEditEmp} style={{ flex: 1, padding: "5px", background: "#3b82f6", color: "white", border: "none", borderRadius: 5, fontSize: 11, fontWeight: 600, cursor: "pointer" }}>Save</button>
                    </div>
                  </div>
                </div>
              );
            }

            return (
              <div key={e.name} style={{ padding: "8px 10px", background: isPaused ? "#fef2f2" : "#F8FAFC", borderRadius: 6, border: isPaused ? "1px solid #fecaca" : "1px solid #E2E8F0" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 12, fontWeight: 600, color: isPaused ? "#991b1b" : "#0F172A" }}>{e.name} {isPaused && <span style={{ fontSize: 10, color: "#dc2626", fontWeight: 700 }}>⏸ PAUSED</span>}</div>
                    <div style={{ fontSize: 10, color: "#64748B", fontFamily: "'JetBrains Mono',monospace" }}>{fmt(e.salary)}</div>
                  </div>
                  <button onClick={function() { openEditEmp(e); }} title="Edit" style={{ background: "#dbeafe", border: "none", borderRadius: 4, padding: "3px 8px", cursor: "pointer", color: "#2563eb", fontSize: 10, fontWeight: 600 }}>✏️</button>
                  {isPaused ? (
                    <button onClick={function() { unpauseEmp(e.name); }} style={{ background: "#d1fae5", border: "none", borderRadius: 4, padding: "3px 8px", cursor: "pointer", color: "#059669", fontSize: 10, fontWeight: 600 }}>▶ Resume</button>
                  ) : (
                    <button onClick={function() { setPauseEmpName(e.name); setPauseFrom(getToday()); setPauseTo(""); }} style={{ background: "#fef3c7", border: "none", borderRadius: 4, padding: "3px 8px", cursor: "pointer", color: "#92400e", fontSize: 10, fontWeight: 600 }}>⏸ Pause</button>
                  )}
                  <button onClick={function() { remEmp(e.name); }} style={{ background: "rgba(239,68,68,.06)", border: "none", borderRadius: 3, padding: "3px 6px", cursor: "pointer", color: "#EF4444", fontSize: 10 }}>✕</button>
                </div>
                <div style={{ display: "flex", gap: 6, marginTop: 3, fontSize: 10, color: "#94a3b8" }}>
                  {e.startDate && <span>Start: {fmtS(e.startDate)}</span>}
                  {e.pauseFrom && <span style={{ color: "#dc2626" }}>Paused: {fmtS(e.pauseFrom)}{e.pauseTo ? " → " + fmtS(e.pauseTo) : " → ongoing"}</span>}
                </div>
              </div>
            );
          })}
        </div>

        {/* Pause date picker */}
        {pauseEmpName && (
          <div style={{ background: "#fffbeb", border: "1px solid #fde68a", borderRadius: 8, padding: 10, marginBottom: 10 }}>
            <div style={{ fontSize: 11, fontWeight: 700, color: "#92400e", marginBottom: 6 }}>⏸ Pause: {pauseEmpName}</div>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6 }}>
              <div><Label text="From" /><input type="date" value={pauseFrom} onChange={function(e) { setPauseFrom(e.target.value); }} style={Object.assign({}, inputS, { fontSize: 12, padding: "6px 8px" })} /></div>
              <div><Label text="Until (optional)" /><input type="date" value={pauseTo} onChange={function(e) { setPauseTo(e.target.value); }} style={Object.assign({}, inputS, { fontSize: 12, padding: "6px 8px" })} /></div>
            </div>
            <div style={{ display: "flex", gap: 6, marginTop: 6 }}>
              <button onClick={function() { setPauseEmpName(null); }} style={{ flex: 1, padding: "6px", background: "white", border: "1px solid #d1d5db", borderRadius: 6, fontSize: 11, cursor: "pointer", color: "#374151" }}>Cancel</button>
              <button onClick={function() { pauseEmp(pauseEmpName, pauseFrom, pauseTo); setPauseEmpName(null); }} style={{ flex: 1, padding: "6px", background: "#f59e0b", border: "none", borderRadius: 6, fontSize: 11, cursor: "pointer", color: "white", fontWeight: 600 }}>Pause</button>
            </div>
          </div>
        )}

        <div style={{ borderTop: "1px solid #E2E8F0", paddingTop: 8 }}>
          <div style={{ fontSize: 10, fontWeight: 600, color: "#374151", marginBottom: 5 }}>Add Employee</div>
          <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
            <input value={empF.name} onChange={function(e) { setEmpF(Object.assign({}, empF, { name: e.target.value })); }} placeholder="Name" style={{ flex: 1, minWidth: 100, padding: "5px 8px", borderRadius: 5, border: "1.5px solid #E2E8F0", fontSize: 11, outline: "none", color: "#0F172A" }} />
            <input value={empF.salary} onChange={function(e) { setEmpF(Object.assign({}, empF, { salary: e.target.value })); }} placeholder="Pay" type="number" style={{ width: 80, padding: "5px 8px", borderRadius: 5, border: "1.5px solid #E2E8F0", fontSize: 11, fontFamily: "'JetBrains Mono',monospace", outline: "none", color: "#0F172A" }} />
            <input type="date" value={empF.startDate} onChange={function(e) { setEmpF(Object.assign({}, empF, { startDate: e.target.value })); }} style={{ width: 130, padding: "5px 8px", borderRadius: 5, border: "1.5px solid #E2E8F0", fontSize: 11, outline: "none", color: "#0F172A" }} />
            <button onClick={addEmp} style={{ background: "#3B82F6", color: "#fff", border: "none", borderRadius: 5, padding: "5px 9px", cursor: "pointer", fontWeight: 600, fontSize: 10 }}>Add</button>
          </div>
        </div>
        <button onClick={function() { setShowEmp(false); setEditEmpName(null); setEditEmpF(null); }} style={{ width: "100%", marginTop: 10, padding: 9, borderRadius: 8, border: "none", background: "#0F172A", color: "#fff", fontSize: 12, fontWeight: 600, cursor: "pointer" }}>Done</button>
      </Modal>

      <footer style={{ textAlign: "center", padding: 24, color: "#6b7280", fontSize: 13, display: "flex", justifyContent: "center", alignItems: "center", gap: 12 }}>
        <span>🔒 Data stored in SharePoint · OpsPay v2.0</span>
        <span style={{
          fontSize: 12, fontWeight: 600, padding: "3px 10px", borderRadius: 20,
          background: saveStatus === "saving" ? "#fef3c7" : saveStatus === "error" ? "#fee2e2" : "#d1fae5",
          color: saveStatus === "saving" ? "#92400e" : saveStatus === "error" ? "#991b1b" : "#065f46"
        }}>
          {saveStatus === "saving" ? "⏳ Saving..." : saveStatus === "error" ? "❌ Save failed" : "✅ Saved"}
        </span>
      </footer>
    </div>
  );
}
    // ════════════════════════════════════════
    //  AUTH WRAPPER
    // ════════════════════════════════════════
    function App() {
      var [user, setUser] = useState(null);
      var [authLoading, setAuthLoading] = useState(true);
      var [spReady, setSpReady] = useState(false);
      var [error, setError] = useState(null);

      useEffect(function() {
        (async function() {
          try { await msalInstance.initialize(); var a = msalInstance.getAllAccounts(); if (a.length > 0) setUser(a[0]); }
          catch (e) { console.error('Auth:', e); }
          finally { setAuthLoading(false); }
        })();
      }, []);

      useEffect(function() {
        (async function() {
          try {
            var result = await msalReady;
            var accounts = msalInstance.getAllAccounts();
            if (result && result.account) { setUser(result.account); }
            else if (accounts.length > 0) { setUser(accounts[0]); }
          } catch (e) { console.error('Redirect:', e); setError('Login: ' + e.message); }
        })();
      }, []);

      useEffect(function() {
        if (!user) return;
        (async function() {
          try { await initSP(); setSpReady(true); }
          catch (e) { console.error('SP:', e); setError('SharePoint: ' + e.message); }
        })();
      }, [user]);

      var handleLogin = async function() {
        setAuthLoading(true);
        try { await msalInstance.loginRedirect(loginRequest); }
        catch (e) { setError('Login: ' + e.message); setAuthLoading(false); }
      };
      var handleLogout = async function() { await msalInstance.logoutRedirect(); setUser(null); setSpReady(false); };

      if (authLoading) return (
        <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", flexDirection: "column", gap: 12 }}>
          <div style={{ width: 48, height: 48, border: "4px solid #e2e8f0", borderTopColor: "#3b82f6", borderRadius: "50%", animation: "spin 1s linear infinite" }} />
          <p style={{ color: "#6b7280" }}>Loading...</p>
        </div>
      );

      if (!user) return (
        <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: "linear-gradient(135deg, #0f172a 0%, #1e293b 100%)" }}>
          <div style={{ background: "white", padding: 48, borderRadius: 16, textAlign: "center", maxWidth: 400, width: "100%", margin: 20, boxShadow: "0 25px 50px -12px rgba(0,0,0,0.5)" }}>
            <div style={{ width: 60, height: 60, borderRadius: 14, background: "linear-gradient(135deg,#3B82F6,#8B5CF6)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 24, fontWeight: 700, color: "white", margin: "0 auto 16px" }}>$</div>
            <h1 style={{ fontSize: 28, fontWeight: 700, color: "#0f172a", marginBottom: 8 }}>OpsPay</h1>
            <p style={{ color: "#64748b", fontSize: 14, marginBottom: 24 }}>Payment Operations Dashboard</p>
            <button onClick={handleLogin} style={{ width: "100%", padding: "14px 24px", background: "#0078d4", color: "white", border: "none", borderRadius: 8, fontSize: 16, fontWeight: 600, cursor: "pointer" }}>Sign in with Microsoft</button>
            {error && <div style={{ color: "#dc2626", fontSize: 13, marginTop: 16 }}>{error}</div>}
          </div>
        </div>
      );

      if (!spReady) return (
        <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", flexDirection: "column", gap: 12 }}>
          <div style={{ width: 48, height: 48, border: "4px solid #e2e8f0", borderTopColor: "#3b82f6", borderRadius: "50%", animation: "spin 1s linear infinite" }} />
          <p style={{ color: "#6b7280" }}>Connecting to SharePoint...</p>
          {error && <div style={{ color: "#dc2626", fontSize: 13, marginTop: 8 }}>{error}</div>}
        </div>
      );

      return <PaymentDashboard onLogout={handleLogout} userName={user.name || user.username} />;
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
